<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 15">
<meta name=Originator content="Microsoft Word 15">
<link rel=File-List href="并发编程重要概念及比较.fld/filelist.xml">
<link rel=Edit-Time-Data href="并发编程重要概念及比较.fld/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Simon Zhang</o:Author>
  <o:LastAuthor>Simon Zhang</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>1</o:TotalTime>
  <o:Created>2019-01-17T13:22:00Z</o:Created>
  <o:LastSaved>2019-01-17T13:22:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>11510</o:Words>
  <o:Characters>65608</o:Characters>
  <o:Lines>546</o:Lines>
  <o:Paragraphs>153</o:Paragraphs>
  <o:CharactersWithSpaces>76965</o:CharactersWithSpaces>
  <o:Version>16.00</o:Version>
 </o:DocumentProperties>
 <o:OfficeDocumentSettings>
  <o:AllowPNG/>
 </o:OfficeDocumentSettings>
</xml><![endif]-->
<link rel=themeData href="并发编程重要概念及比较.fld/themedata.thmx">
<link rel=colorSchemeMapping href="并发编程重要概念及比较.fld/colorschememapping.xml">
<!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:HideSpellingErrors/>
  <w:GrammarState>Clean</w:GrammarState>
  <w:TrackMoves>false</w:TrackMoves>
  <w:TrackFormatting/>
  <w:PunctuationKerning/>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:DoNotPromoteQF/>
  <w:LidThemeOther>EN-GB</w:LidThemeOther>
  <w:LidThemeAsian>ZH-CN</w:LidThemeAsian>
  <w:LidThemeComplexScript>X-NONE</w:LidThemeComplexScript>
  <w:Compatibility>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:DontGrowAutofit/>
   <w:SplitPgBreakAndParaMark/>
   <w:EnableOpenTypeKerning/>
   <w:DontFlipMirrorIndents/>
   <w:OverrideTableStyleHps/>
   <w:UseFELayout/>
  </w:Compatibility>
  <m:mathPr>
   <m:mathFont m:val="Cambria Math"/>
   <m:brkBin m:val="before"/>
   <m:brkBinSub m:val="&#45;-"/>
   <m:smallFrac m:val="off"/>
   <m:dispDef/>
   <m:lMargin m:val="0"/>
   <m:rMargin m:val="0"/>
   <m:defJc m:val="centerGroup"/>
   <m:wrapIndent m:val="1440"/>
   <m:intLim m:val="subSup"/>
   <m:naryLim m:val="undOvr"/>
  </m:mathPr></w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" DefUnhideWhenUsed="false"
  DefSemiHidden="false" DefQFormat="false" DefPriority="99"
  LatentStyleCount="375">
  <w:LsdException Locked="false" Priority="0" QFormat="true" Name="Normal"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 1"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 2"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 3"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 4"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 5"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 6"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 7"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 8"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="heading 9"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 6"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 7"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 8"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index 9"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 1"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 2"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 3"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 4"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 5"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 6"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 7"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 8"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" Name="toc 9"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Normal Indent"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="footnote text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="annotation text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="header"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="footer"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="index heading"/>
  <w:LsdException Locked="false" Priority="35" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="caption"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="table of figures"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="envelope address"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="envelope return"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="footnote reference"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="annotation reference"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="line number"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="page number"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="endnote reference"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="endnote text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="table of authorities"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="macro"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="toa heading"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Bullet 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Number 5"/>
  <w:LsdException Locked="false" Priority="10" QFormat="true" Name="Title"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Closing"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Signature"/>
  <w:LsdException Locked="false" Priority="1" SemiHidden="true"
   UnhideWhenUsed="true" Name="Default Paragraph Font"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text Indent"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="List Continue 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Message Header"/>
  <w:LsdException Locked="false" Priority="11" QFormat="true" Name="Subtitle"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Salutation"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Date"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text First Indent"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text First Indent 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Note Heading"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text Indent 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Body Text Indent 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Block Text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Hyperlink"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="FollowedHyperlink"/>
  <w:LsdException Locked="false" Priority="22" QFormat="true" Name="Strong"/>
  <w:LsdException Locked="false" Priority="20" QFormat="true" Name="Emphasis"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Document Map"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Plain Text"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="E-mail Signature"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Top of Form"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Bottom of Form"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Normal (Web)"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Acronym"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Address"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Cite"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Code"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Definition"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Keyboard"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Preformatted"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Sample"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Typewriter"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="HTML Variable"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Normal Table"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="annotation subject"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="No List"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Outline List 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Outline List 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Outline List 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Simple 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Simple 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Simple 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Classic 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Classic 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Classic 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Classic 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Colorful 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Colorful 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Colorful 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Columns 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 6"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 7"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Grid 8"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 4"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 5"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 6"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 7"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table List 8"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table 3D effects 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table 3D effects 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table 3D effects 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Contemporary"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Elegant"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Professional"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Subtle 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Subtle 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Web 1"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Web 2"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Web 3"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Balloon Text"/>
  <w:LsdException Locked="false" Priority="39" Name="Table Grid"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Table Theme"/>
  <w:LsdException Locked="false" SemiHidden="true" Name="Placeholder Text"/>
  <w:LsdException Locked="false" Priority="1" QFormat="true" Name="No Spacing"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 1"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 1"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 1"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 1"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 1"/>
  <w:LsdException Locked="false" SemiHidden="true" Name="Revision"/>
  <w:LsdException Locked="false" Priority="34" QFormat="true"
   Name="List Paragraph"/>
  <w:LsdException Locked="false" Priority="29" QFormat="true" Name="Quote"/>
  <w:LsdException Locked="false" Priority="30" QFormat="true"
   Name="Intense Quote"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 1"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 1"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 1"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 1"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 1"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 1"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 2"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 2"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 2"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 2"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 2"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 2"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 2"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 2"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 2"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 2"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 2"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 3"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 3"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 3"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 3"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 3"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 3"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 3"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 3"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 3"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 3"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 3"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 4"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 4"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 4"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 4"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 4"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 4"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 4"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 4"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 4"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 4"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 4"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 5"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 5"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 5"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 5"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 5"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 5"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 5"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 5"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 5"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 5"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 5"/>
  <w:LsdException Locked="false" Priority="60" Name="Light Shading Accent 6"/>
  <w:LsdException Locked="false" Priority="61" Name="Light List Accent 6"/>
  <w:LsdException Locked="false" Priority="62" Name="Light Grid Accent 6"/>
  <w:LsdException Locked="false" Priority="63" Name="Medium Shading 1 Accent 6"/>
  <w:LsdException Locked="false" Priority="64" Name="Medium Shading 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="65" Name="Medium List 1 Accent 6"/>
  <w:LsdException Locked="false" Priority="66" Name="Medium List 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="67" Name="Medium Grid 1 Accent 6"/>
  <w:LsdException Locked="false" Priority="68" Name="Medium Grid 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="69" Name="Medium Grid 3 Accent 6"/>
  <w:LsdException Locked="false" Priority="70" Name="Dark List Accent 6"/>
  <w:LsdException Locked="false" Priority="71" Name="Colorful Shading Accent 6"/>
  <w:LsdException Locked="false" Priority="72" Name="Colorful List Accent 6"/>
  <w:LsdException Locked="false" Priority="73" Name="Colorful Grid Accent 6"/>
  <w:LsdException Locked="false" Priority="19" QFormat="true"
   Name="Subtle Emphasis"/>
  <w:LsdException Locked="false" Priority="21" QFormat="true"
   Name="Intense Emphasis"/>
  <w:LsdException Locked="false" Priority="31" QFormat="true"
   Name="Subtle Reference"/>
  <w:LsdException Locked="false" Priority="32" QFormat="true"
   Name="Intense Reference"/>
  <w:LsdException Locked="false" Priority="33" QFormat="true" Name="Book Title"/>
  <w:LsdException Locked="false" Priority="37" SemiHidden="true"
   UnhideWhenUsed="true" Name="Bibliography"/>
  <w:LsdException Locked="false" Priority="39" SemiHidden="true"
   UnhideWhenUsed="true" QFormat="true" Name="TOC Heading"/>
  <w:LsdException Locked="false" Priority="41" Name="Plain Table 1"/>
  <w:LsdException Locked="false" Priority="42" Name="Plain Table 2"/>
  <w:LsdException Locked="false" Priority="43" Name="Plain Table 3"/>
  <w:LsdException Locked="false" Priority="44" Name="Plain Table 4"/>
  <w:LsdException Locked="false" Priority="45" Name="Plain Table 5"/>
  <w:LsdException Locked="false" Priority="40" Name="Grid Table Light"/>
  <w:LsdException Locked="false" Priority="46" Name="Grid Table 1 Light"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark"/>
  <w:LsdException Locked="false" Priority="51" Name="Grid Table 6 Colorful"/>
  <w:LsdException Locked="false" Priority="52" Name="Grid Table 7 Colorful"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 1"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 1"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 1"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 1"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 1"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 1"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 2"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 2"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 2"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 2"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 2"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 2"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 3"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 3"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 3"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 3"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 3"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 3"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 4"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 4"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 4"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 4"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 4"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 4"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 5"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 5"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 5"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 5"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 5"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 5"/>
  <w:LsdException Locked="false" Priority="46"
   Name="Grid Table 1 Light Accent 6"/>
  <w:LsdException Locked="false" Priority="47" Name="Grid Table 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="48" Name="Grid Table 3 Accent 6"/>
  <w:LsdException Locked="false" Priority="49" Name="Grid Table 4 Accent 6"/>
  <w:LsdException Locked="false" Priority="50" Name="Grid Table 5 Dark Accent 6"/>
  <w:LsdException Locked="false" Priority="51"
   Name="Grid Table 6 Colorful Accent 6"/>
  <w:LsdException Locked="false" Priority="52"
   Name="Grid Table 7 Colorful Accent 6"/>
  <w:LsdException Locked="false" Priority="46" Name="List Table 1 Light"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark"/>
  <w:LsdException Locked="false" Priority="51" Name="List Table 6 Colorful"/>
  <w:LsdException Locked="false" Priority="52" Name="List Table 7 Colorful"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 1"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 1"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 1"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 1"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 1"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 1"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 2"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 2"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 2"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 2"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 2"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 2"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 3"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 3"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 3"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 3"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 3"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 3"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 4"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 4"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 4"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 4"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 4"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 4"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 5"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 5"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 5"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 5"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 5"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 5"/>
  <w:LsdException Locked="false" Priority="46"
   Name="List Table 1 Light Accent 6"/>
  <w:LsdException Locked="false" Priority="47" Name="List Table 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="48" Name="List Table 3 Accent 6"/>
  <w:LsdException Locked="false" Priority="49" Name="List Table 4 Accent 6"/>
  <w:LsdException Locked="false" Priority="50" Name="List Table 5 Dark Accent 6"/>
  <w:LsdException Locked="false" Priority="51"
   Name="List Table 6 Colorful Accent 6"/>
  <w:LsdException Locked="false" Priority="52"
   Name="List Table 7 Colorful Accent 6"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Mention"/>
  <w:LsdException Locked="false" SemiHidden="true" UnhideWhenUsed="true"
   Name="Smart Hyperlink"/>
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:-536870145 1107305727 0 0 415 0;}
@font-face
	{font-family:DengXian;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:等线;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:-1610612033 953122042 22 0 262159 0;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-536859905 -1073732485 9 0 511 0;}
@font-face
	{font-family:"PingFang SC";
	panose-1:2 11 4 0 0 0 0 0 0 0;
	mso-font-charset:134;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-1610611969 2060451323 23 0 262145 0;}
@font-face
	{font-family:consolas;
	panose-1:2 11 6 9 2 2 4 3 2 4;
	mso-font-charset:0;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:-520092929 1073806591 9 0 415 0;}
@font-face
	{font-family:"Microsoft YaHei";
	panose-1:2 11 5 3 2 2 4 2 2 4;
	mso-font-charset:134;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-2147483001 684670034 22 0 262175 0;}
@font-face
	{font-family:"\@PingFang SC";
	mso-font-charset:134;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-1610611969 2060451323 23 0 262145 0;}
@font-face
	{font-family:"\@Microsoft YaHei";
	mso-font-charset:134;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-2147483001 684670034 22 0 262175 0;}
@font-face
	{font-family:"\@DengXian";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:-1610612033 953122042 22 0 262159 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-unhide:no;
	mso-style-qformat:yes;
	mso-style-parent:"";
	margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;
	mso-ascii-font-family:Calibri;
	mso-ascii-theme-font:minor-latin;
	mso-fareast-font-family:DengXian;
	mso-fareast-theme-font:minor-fareast;
	mso-hansi-font-family:Calibri;
	mso-hansi-theme-font:minor-latin;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:minor-bidi;
	mso-ansi-language:EN-GB;}
h1
	{mso-style-priority:9;
	mso-style-unhide:no;
	mso-style-qformat:yes;
	mso-style-link:"Heading 1 Char";
	mso-margin-top-alt:auto;
	margin-right:0cm;
	mso-margin-bottom-alt:auto;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	mso-outline-level:1;
	font-size:24.0pt;
	font-family:"Times New Roman",serif;
	mso-fareast-font-family:"Times New Roman";
	font-weight:bold;}
h2
	{mso-style-priority:9;
	mso-style-unhide:no;
	mso-style-qformat:yes;
	mso-style-link:"Heading 2 Char";
	mso-margin-top-alt:auto;
	margin-right:0cm;
	mso-margin-bottom-alt:auto;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	mso-outline-level:2;
	font-size:18.0pt;
	font-family:"Times New Roman",serif;
	mso-fareast-font-family:"Times New Roman";
	font-weight:bold;}
h3
	{mso-style-priority:9;
	mso-style-unhide:no;
	mso-style-qformat:yes;
	mso-style-link:"Heading 3 Char";
	mso-margin-top-alt:auto;
	margin-right:0cm;
	mso-margin-bottom-alt:auto;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	mso-outline-level:3;
	font-size:13.5pt;
	font-family:"Times New Roman",serif;
	mso-fareast-font-family:"Times New Roman";
	font-weight:bold;}
h4
	{mso-style-priority:9;
	mso-style-unhide:no;
	mso-style-qformat:yes;
	mso-style-link:"Heading 4 Char";
	mso-margin-top-alt:auto;
	margin-right:0cm;
	mso-margin-bottom-alt:auto;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	mso-outline-level:4;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;
	mso-fareast-font-family:"Times New Roman";
	font-weight:bold;}
a:link, span.MsoHyperlink
	{mso-style-noshow:yes;
	mso-style-priority:99;
	color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{mso-style-noshow:yes;
	mso-style-priority:99;
	color:purple;
	text-decoration:underline;
	text-underline:single;}
p
	{mso-style-noshow:yes;
	mso-style-priority:99;
	mso-margin-top-alt:auto;
	margin-right:0cm;
	mso-margin-bottom-alt:auto;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;
	mso-fareast-font-family:"Times New Roman";}
code
	{mso-style-noshow:yes;
	mso-style-priority:99;
	font-family:"Courier New";
	mso-ascii-font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Courier New";}
pre
	{mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-link:"HTML Preformatted Char";
	margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";}
span.Heading1Char
	{mso-style-name:"Heading 1 Char";
	mso-style-priority:9;
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-link:"Heading 1";
	mso-ansi-font-size:24.0pt;
	mso-bidi-font-size:24.0pt;
	font-family:"Times New Roman",serif;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	mso-font-kerning:18.0pt;
	mso-ansi-language:EN-HK;
	font-weight:bold;}
span.Heading2Char
	{mso-style-name:"Heading 2 Char";
	mso-style-priority:9;
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-link:"Heading 2";
	mso-ansi-font-size:18.0pt;
	mso-bidi-font-size:18.0pt;
	font-family:"Times New Roman",serif;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	mso-ansi-language:EN-HK;
	font-weight:bold;}
span.Heading3Char
	{mso-style-name:"Heading 3 Char";
	mso-style-priority:9;
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-link:"Heading 3";
	mso-ansi-font-size:13.5pt;
	mso-bidi-font-size:13.5pt;
	font-family:"Times New Roman",serif;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	mso-ansi-language:EN-HK;
	font-weight:bold;}
span.Heading4Char
	{mso-style-name:"Heading 4 Char";
	mso-style-priority:9;
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-link:"Heading 4";
	font-family:"Times New Roman",serif;
	mso-ascii-font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	mso-ansi-language:EN-HK;
	font-weight:bold;}
p.msonormal0, li.msonormal0, div.msonormal0
	{mso-style-name:msonormal;
	mso-style-unhide:no;
	mso-margin-top-alt:auto;
	margin-right:0cm;
	mso-margin-bottom-alt:auto;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;
	mso-fareast-font-family:"Times New Roman";}
span.post-time
	{mso-style-name:post-time;
	mso-style-unhide:no;}
span.post-meta-item-icon
	{mso-style-name:post-meta-item-icon;
	mso-style-unhide:no;}
span.post-meta-item-text
	{mso-style-name:post-meta-item-text;
	mso-style-unhide:no;}
span.post-comments-count
	{mso-style-name:post-comments-count;
	mso-style-unhide:no;}
span.post-meta-divider
	{mso-style-name:post-meta-divider;
	mso-style-unhide:no;}
span.page-pv
	{mso-style-name:page-pv;
	mso-style-unhide:no;}
span.busuanzi-value
	{mso-style-name:busuanzi-value;
	mso-style-unhide:no;}
span.HTMLPreformattedChar
	{mso-style-name:"HTML Preformatted Char";
	mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-link:"HTML Preformatted";
	mso-ansi-font-size:10.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Courier New";
	mso-ascii-font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Courier New";
	mso-ansi-language:EN-HK;}
span.line
	{mso-style-name:line;
	mso-style-unhide:no;}
span.number
	{mso-style-name:number;
	mso-style-unhide:no;}
span.keyword
	{mso-style-name:keyword;
	mso-style-unhide:no;}
span.builtin
	{mso-style-name:built_in;
	mso-style-unhide:no;}
span.comment
	{mso-style-name:comment;
	mso-style-unhide:no;}
span.string
	{mso-style-name:string;
	mso-style-unhide:no;}
span.function
	{mso-style-name:function;
	mso-style-unhide:no;}
span.title
	{mso-style-name:title;
	mso-style-unhide:no;}
span.params
	{mso-style-name:params;
	mso-style-unhide:no;}
span.class
	{mso-style-name:class;
	mso-style-unhide:no;}
span.meta
	{mso-style-name:meta;
	mso-style-unhide:no;}
span.meta-keyword
	{mso-style-name:meta-keyword;
	mso-style-unhide:no;}
span.selector-id
	{mso-style-name:selector-id;
	mso-style-unhide:no;}
span.selector-tag
	{mso-style-name:selector-tag;
	mso-style-unhide:no;}
span.literal
	{mso-style-name:literal;
	mso-style-unhide:no;}
.MsoChpDefault
	{mso-style-type:export-only;
	mso-default-props:yes;
	font-family:"Calibri",sans-serif;
	mso-ascii-font-family:Calibri;
	mso-ascii-theme-font:minor-latin;
	mso-fareast-font-family:DengXian;
	mso-fareast-theme-font:minor-fareast;
	mso-hansi-font-family:Calibri;
	mso-hansi-theme-font:minor-latin;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:minor-bidi;
	mso-ansi-language:EN-GB;}
@page WordSection1
	{size:595.0pt 842.0pt;
	margin:72.0pt 72.0pt 72.0pt 72.0pt;
	mso-header-margin:35.4pt;
	mso-footer-margin:35.4pt;
	mso-paper-source:0;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 @list l0
	{mso-list-id:36858029;
	mso-list-template-ids:-377463564;}
@list l1
	{mso-list-id:70856500;
	mso-list-template-ids:839820716;}
@list l2
	{mso-list-id:450519510;
	mso-list-template-ids:283252964;}
@list l3
	{mso-list-id:542712788;
	mso-list-template-ids:1374747818;}
@list l4
	{mso-list-id:569998512;
	mso-list-template-ids:2108479328;}
@list l5
	{mso-list-id:675812340;
	mso-list-template-ids:1047185164;}
@list l6
	{mso-list-id:780884159;
	mso-list-template-ids:-1165312422;}
@list l7
	{mso-list-id:834344208;
	mso-list-template-ids:-1823573316;}
@list l8
	{mso-list-id:1052928369;
	mso-list-template-ids:-1412674734;}
@list l9
	{mso-list-id:1116801055;
	mso-list-template-ids:1876437018;}
@list l10
	{mso-list-id:1309168070;
	mso-list-template-ids:-1666153614;}
@list l11
	{mso-list-id:1410493824;
	mso-list-template-ids:1075340272;}
@list l12
	{mso-list-id:1527670007;
	mso-list-template-ids:693673718;}
@list l13
	{mso-list-id:1541430622;
	mso-list-template-ids:957538886;}
@list l14
	{mso-list-id:1594392365;
	mso-list-template-ids:1874897842;}
@list l15
	{mso-list-id:1633901114;
	mso-list-template-ids:894181104;}
@list l16
	{mso-list-id:1760101501;
	mso-list-template-ids:-720347784;}
@list l17
	{mso-list-id:1939363437;
	mso-list-template-ids:-931201316;}
@list l18
	{mso-list-id:1989631235;
	mso-list-template-ids:604786012;}
@list l19
	{mso-list-id:2108963422;
	mso-list-template-ids:-502654766;}
@list l20
	{mso-list-id:2140755733;
	mso-list-template-ids:747554030;}
ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;
	mso-ascii-font-family:Calibri;
	mso-ascii-theme-font:minor-latin;
	mso-hansi-font-family:Calibri;
	mso-hansi-theme-font:minor-latin;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:minor-bidi;
	mso-ansi-language:EN-GB;}
</style>
<![endif]-->
</head>

<body lang=EN-HK link=blue vlink=purple style='tab-interval:36.0pt'>

<div class=WordSection1>

<p class=MsoNormal align=center style='text-align:center;mso-outline-level:
1'><span lang=ZH-CN style='font-size:19.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";mso-font-kerning:18.0pt;mso-ansi-language:
EN-HK'>并发编程重要概念及比较</span><span style='font-size:19.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";mso-font-kerning:18.0pt;mso-ansi-language:
EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><b><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>并发</span></b><b><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(concurrency)</span></b><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>强调的是逻辑上的同时发生，是语义上的模型</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(semantic model)<span
lang=ZH-CN>，在实际上并发程序可能是由一个处理器同时</span>(simultaneously)<span lang=ZH-CN>处理多个任务，因此并发过程中常出现一个线程等待其他资源的情况。此时常伴随着线程的阻塞和调度。并发过程通常可划分为</span><a
href="http://ifeve.com/lock-free-and-wait-free/" target="_blank"><span
lang=ZH-CN style='color:#555555'>多个级别</span></a><span lang=ZH-CN>：</span>Blocking<span
lang=ZH-CN>、</span>Obstruction-Free<span lang=ZH-CN>、</span>Lock-Free<span
lang=ZH-CN>、</span>Wait-Free<span lang=ZH-CN>，其中后三种统称为</span>Non-blocking<span
lang=ZH-CN>的。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><b><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>并行</span></b><b><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(parallelism)</span></b><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>属于并发，是运行期的行为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(runtime behavior)<span
lang=ZH-CN>，并行强调这两个并发事件实际上也是同时发生的，例如在多个处理器上运行的多个任务。但我们不能讲这两个概念绝对化，例如在处理器层面，流水线绝对是并发的，但在操作系统之上提供的机制来说，却体现出顺序的特性。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><b><span lang=ZH-CN style='font-size:16.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'>处理器层面的并发</span></b><b><span
style='font-size:16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>这里简单地论述处理器层面的并发相关，例如</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>SMP<span lang=ZH-CN>架构、流水线、分支预测、多级缓存等技术。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>流水线</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(pipeline)<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>流水线和吞吐量</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>我们通常使用</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>GOPS<span lang=ZH-CN>（每秒千兆次操作）来定义吞吐量，表示每秒内执行操作的次数。</span>CPU<span
lang=ZH-CN>流水线的目的是为了提高吞吐量</span>(throughput)<span lang=ZH-CN>，但会增加每条指令的延迟</span>(latency)<span
lang=ZH-CN>，这是因为执行一条指令需要经过更多的流水线寄存器。</span>CSAPP<span lang=ZH-CN>使用一个称为</span>SEQ<span
lang=ZH-CN>的架构来描述流水线的通用模型，一条指令在</span>CPU<span lang=ZH-CN>中被执行会经过取指</span>(fetch)<span
lang=ZH-CN>、译码</span>(decode)<span lang=ZH-CN>、执行</span>(execute)<span
lang=ZH-CN>、访存</span>(memory)<span lang=ZH-CN>、写回</span>(write back)<span
lang=ZH-CN>、更新</span>PC<span lang=ZH-CN>（在</span>SEQ+<span lang=ZH-CN>中和取指进行了合并）等阶段。容易想到在某一时钟周期内，每一个阶段都可以独立运行。例如当指令</span>PC<span
lang=ZH-CN>在执行阶段时，我们可以对指令</span>PC+1<span lang=ZH-CN>进行译码，这样译码器就不会闲置，这就是流水线化的一个简单思路。这种流水线设计很常见，以</span>486<span
lang=ZH-CN>为例，其拥有两条</span>5<span lang=ZH-CN>级流水线</span></span><span lang=ZH-CN
style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
"Microsoft YaHei";color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>取指</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>F-&gt;</span><span
lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
mso-bidi-font-family:"Microsoft YaHei";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>译码</span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>D1-&gt;</span><span lang=ZH-CN
style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
"Microsoft YaHei";color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>转址</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>D2-&gt;</span><span
lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
mso-bidi-font-family:"Microsoft YaHei";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>执行</span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>EX-&gt;</span><span lang=ZH-CN
style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
"Microsoft YaHei";color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>写回</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>WB</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。出于两点的考虑，流水线技术会制约了吞吐量能提高的上限：</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l5 level1 lfo1;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>流水线不同阶段的延迟是不同如下图所示，流水线的吞吐量会受到其中最长操作的局限。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;
margin-left:36.0pt;text-align:justify;text-justify:inter-ideograph;background:
white'><span style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><br>
</span><span lang=EN-GB><a
href="http://www.calvinneo.com/img/concur/lsx_ttl_ys.png"><span lang=EN-US
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK;mso-no-proof:yes;
text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shapetype id="_x0000_t75"
 coordsize="21600,21600" o:spt="75" o:preferrelative="t" path="m@4@5l@4@11@9@11@9@5xe"
 filled="f" stroked="f">
 <v:stroke joinstyle="miter"/>
 <v:formulas>
  <v:f eqn="if lineDrawn pixelLineWidth 0"/>
  <v:f eqn="sum @0 1 0"/>
  <v:f eqn="sum 0 0 @1"/>
  <v:f eqn="prod @2 1 2"/>
  <v:f eqn="prod @3 21600 pixelWidth"/>
  <v:f eqn="prod @3 21600 pixelHeight"/>
  <v:f eqn="sum @0 0 1"/>
  <v:f eqn="prod @6 1 2"/>
  <v:f eqn="prod @7 21600 pixelWidth"/>
  <v:f eqn="sum @8 21600 0"/>
  <v:f eqn="prod @7 21600 pixelHeight"/>
  <v:f eqn="sum @10 21600 0"/>
 </v:formulas>
 <v:path o:extrusionok="f" gradientshapeok="t" o:connecttype="rect"/>
 <o:lock v:ext="edit" aspectratio="t"/>
</v:shapetype><v:shape id="Picture_x0020_10" o:spid="_x0000_i1034" type="#_x0000_t75"
 alt="http://www.calvinneo.com/img/concur/lsx_ttl_ys.png"
 href="http://www.calvinneo.com/img/concur/lsx_ttl_ys.png" style='width:451pt;
 height:230pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image001.png" o:title="lsx_ttl_ys"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=451 height=230 src="并发编程重要概念及比较.fld/image001.png"
alt="http://www.calvinneo.com/img/concur/lsx_ttl_ys.png" v:shapes="Picture_x0020_10"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=2 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l5 level1 lfo1;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>一个较深的流水线可能带来很大的流水线寄存器延迟这是来自于增加的流水线寄存器所带来的额外开销。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>流水线和冒险</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>控制相关和顺序（数据）相关是使用流水线并发执行一些指令需要面临的问题。其中顺序相关指后一条指令的执行依赖于前一条指令的值，控制相关指的是指令流的路径依赖于前一条指令（通常是条件测试）的结果。为了解决这样的问题，</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CSAPP<span lang=ZH-CN>首先升级了原先的</span>SEQ<span
lang=ZH-CN>到</span>SEQ+<span lang=ZH-CN>，现在我们将更新</span>PC<span lang=ZH-CN>移到最前面，并且和取指进行了合并，这样做的目的是使得我们在程序开始时通过上面一条指令结束时的状态来确定地址。</span>CSAPP<span
lang=ZH-CN>基于</span>SEQ+<span lang=ZH-CN>引入了</span>PIPE-<span lang=ZH-CN>这个流水线，并希望</span>PIPE-<span
lang=ZH-CN>能够实现每个时钟周期发射</span>(issue)<span lang=ZH-CN>一条指令，因此我们需要在取出一条指令后马上确定下一条指令的位置。这对于</span>ret<span
lang=ZH-CN>和条件转移来说是较为麻烦的，因为我们要进行<b>分支预测</b>。分支预测有一些策略，包括总是选择（分支），从不选择</span>(NT)<span
lang=ZH-CN>。一种正向不选择</span>(BTFNT)<span lang=ZH-CN>策略只接受跳往地址更低的分支（也就是往前跳，后向分支），因为它可能标志着一个循环的右大括号。现在的分支预测器通常分为静态规则和动态规则的，动态规则会基于一些运行期的历史进行类似“强化学习”，例如如果一段分支历史上不进行跳转的成功率大，那么就这一次预测的时候就不进行跳转，</span><a
href="https://zhuanlan.zhihu.com/p/36795318" target="_blank"><span lang=ZH-CN
style='color:#555555'>知乎专栏</span></a><span lang=ZH-CN>上给出了一个详细的例子来验证这个特性，这个实验中验证了对一个有序数组遍历时其耗时约为无序数组的</span>1/3<span
lang=ZH-CN>。分支预测失败，也就是所谓的控制冒险</span>(hazard)<span lang=ZH-CN>，它的代价是就会导致流水线刷新</span>(flush)<span
lang=ZH-CN>。此外当一条指令<b>写</b>后面指令会<b>读</b>到的那些程序状态时就会带来数据冒险，特别地我们可以发现控制冒险可以看做是对程序计数器</span>PC<span
lang=ZH-CN>而言的数据冒险。我们考虑整个流水线中可能出现的部件，其中通用寄存器和</span>PC<span lang=ZH-CN>已经被证明是存在冒险的，以通用寄存器为例，其写和读发生在流水线上<b>不同的阶段</b>（写回和解码）。剩下来的是</span>EFLAGS<span
lang=ZH-CN>以及存储器则是不存在冒险的，以存储器为例，其读写<b>都</b>发生在流水线的<b>访存阶段</b>，那么前一条指令对存储器的<b>写</b>对后一条指令对存储器的<b>读</b>总是可见的。</span>CPU<span
lang=ZH-CN>流水线中通过暂停</span>(stalling)<span lang=ZH-CN>和转发</span>(forward)/<span
lang=ZH-CN>旁路</span>(bypassing)<span lang=ZH-CN>的机制解决数据冒险的问题。此外在汇编层面，我们可以使用条件传送而不是条件控制转移来避免分支预测出错的问题。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span lang=ZH-CN style='font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>暂停</span></b><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>暂停的思路很简单，就是阻塞流水线中的一些指令直到冒险条件不满足。对通用寄存器而言，在解码阶段时流水线会检查前方执行、访存和写回阶段中是否有指令会更新该通用寄存器。如果存在那么就会阻塞处于解码阶段的指令（包括后面即将执行的下一条指令的取指阶段，也就是保持</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>PC<span lang=ZH-CN>的值）。在阻塞时，流水线的一部分会进入空转状态，此时我们成为插入一个气泡</span>(bubble)<span
lang=ZH-CN>。如下图所示，在时刻</span>5<span lang=ZH-CN>，原本应该执行的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>0x00d</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>处的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>D<span lang=ZH-CN>被阻塞了，因为</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>0x006</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>处的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>W<span lang=ZH-CN>尚未完成。因此在等待其完成的时间中插入了三个气泡（分别对应</span>EMW<span
lang=ZH-CN>阶段）。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><br>
</span><span lang=EN-GB><a href="http://www.calvinneo.com/img/concur/bubble.png"><span
lang=EN-US style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK;
mso-no-proof:yes;text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_9" o:spid="_x0000_i1033" type="#_x0000_t75" alt="http://www.calvinneo.com/img/concur/bubble.png"
 href="http://www.calvinneo.com/img/concur/bubble.png" style='width:451pt;
 height:162pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image002.png" o:title="bubble"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=451 height=162 src="并发编程重要概念及比较.fld/image002.png"
alt="http://www.calvinneo.com/img/concur/bubble.png" v:shapes="Picture_x0020_9"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span lang=ZH-CN style='font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>转发</span></b><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>上面的暂停机制非常直白和简单，但考虑到前后连续两条指令对同一个寄存器先写后读是很通常的情况，此时三个气泡是很划不来的。此时可以借助转发来避免暂停。转发机制指将结果从流水线的较晚阶段发送到流水线的较早阶段的过程，通常是从写回阶段</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>W<span lang=ZH-CN>转发到译码</span>D<span
lang=ZH-CN>阶段作为操作数之一。我们查看下面的图，在第</span>6<span lang=ZH-CN>周期上，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>0x00e</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的解码逻辑发现</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>0x006</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>上所在的写回阶段有对</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>%eax</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的写，而自己恰恰要访问这个寄存器，所以与其这样不如直接拿过来用了。这样相当于只插入了两个气泡。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><br>
</span><span lang=EN-GB><a
href="http://www.calvinneo.com/img/concur/forward.png"><span lang=EN-US
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK;mso-no-proof:yes;
text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shape id="Picture_x0020_8"
 o:spid="_x0000_i1032" type="#_x0000_t75" alt="http://www.calvinneo.com/img/concur/forward.png"
 href="http://www.calvinneo.com/img/concur/forward.png" style='width:451pt;
 height:315pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image003.png" o:title="forward"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=451 height=315 src="并发编程重要概念及比较.fld/image003.png"
alt="http://www.calvinneo.com/img/concur/forward.png" v:shapes="Picture_x0020_8"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><br>
<span lang=ZH-CN>更厉害的是我们甚至可以在访存阶段就转发到解码阶段。我们查看下面的图，在第</span>5<span lang=ZH-CN>周期上位于解码阶段的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>0x00d</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>发现</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>0x006</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>0x000</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>分别处于访存和写回阶段，这里写回阶段如上所示，而访存阶段我们发现我们正在读入数据到</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>%eax</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。因此我们可以直接将这个对</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>%eax</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的写也转发过去。现在我们相当于只插入了一个气泡。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><br>
</span><span lang=EN-GB><a
href="http://www.calvinneo.com/img/concur/forward2.png"><span lang=EN-US
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK;mso-no-proof:yes;
text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shape id="Picture_x0020_7"
 o:spid="_x0000_i1031" type="#_x0000_t75" alt="http://www.calvinneo.com/img/concur/forward2.png"
 href="http://www.calvinneo.com/img/concur/forward2.png" style='width:441pt;
 height:380pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image004.png" o:title="forward2"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=441 height=380 src="并发编程重要概念及比较.fld/image004.png"
alt="http://www.calvinneo.com/img/concur/forward2.png" v:shapes="Picture_x0020_7"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><br>
<span lang=ZH-CN>能不能一个都不插入呢？也是可以的，我们从执行阶段就转发到解码阶段。我们查看下面的图，在第</span>4<span
lang=ZH-CN>周期上位于解码阶段的</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>0x00c</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>发现</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>0x006</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>0x000</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>分别处于执行和访存阶段，这里访存阶段如上所示，而在执行阶段我们发现我们正在计算一个立即数，这个立即数将在稍后写入</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>%eax</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><br>
</span><span lang=EN-GB><a
href="http://www.calvinneo.com/img/concur/forward3.png"><span lang=EN-US
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK;mso-no-proof:yes;
text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shape id="Picture_x0020_6"
 o:spid="_x0000_i1030" type="#_x0000_t75" alt="http://www.calvinneo.com/img/concur/forward3.png"
 href="http://www.calvinneo.com/img/concur/forward3.png" style='width:426pt;
 height:341pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image005.png" o:title="forward3"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=426 height=341 src="并发编程重要概念及比较.fld/image005.png"
alt="http://www.calvinneo.com/img/concur/forward3.png" v:shapes="Picture_x0020_6"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>加载互锁</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>转发能够解决相当多的数据冒险，但有一类加载</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>使用冒险难以被解决，这是因为加载（从存储器读）存在于访存阶段，而如果下一条指令就要使用的话，那么就会“赶不上趟”。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>现代处理器</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在现代的处理器中，流水线被拆分地更加细，出现了所谓的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>12<span lang=ZH-CN>级、</span>31<span
lang=ZH-CN>级乃至更深的流水线。但是这么深的流水线阻塞的代价是非常巨大的。为此</span>Intel<span lang=ZH-CN>使用了乱序执行组件</span>(Out-of-Order
core)<span lang=ZH-CN>。</span><br>
</span><span lang=EN-GB><a
href="http://www.calvinneo.com/img/concur/cur_cpu_rob.png"><span lang=EN-US
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK;mso-no-proof:yes;
text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shape id="Picture_x0020_5"
 o:spid="_x0000_i1029" type="#_x0000_t75" alt="http://www.calvinneo.com/img/concur/cur_cpu_rob.png"
 href="http://www.calvinneo.com/img/concur/cur_cpu_rob.png" style='width:451pt;
 height:520pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image006.png" o:title="cur_cpu_rob"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=451 height=520 src="并发编程重要概念及比较.fld/image006.png"
alt="http://www.calvinneo.com/img/concur/cur_cpu_rob.png" v:shapes="Picture_x0020_5"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>流水线机制对程序优化的启示</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>流水线机制对我们程序性能优化的启示主要有下面几点：</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l12 level1 lfo2;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>减少连续指令的相关性这一点是针对数据冒险而言的。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l12 level1 lfo2;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>进行循环展开这一点是针对控制冒险而言的。循环处必然出现分支，这就带来了可能的分支预测失败的成本。因此我们展开循环能够减少这样的跳转次数。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>的缓存和缓存一致性</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>x86<span lang=ZH-CN>往往都有高速缓存</span>Cache<span
lang=ZH-CN>，而且有多级。高速缓存基于静态</span>RAM(SRAM)<span lang=ZH-CN>技术，区别于主存的动态</span>RAM(DRAM)<span
lang=ZH-CN>技术。现代</span>CPU<span lang=ZH-CN>中寄存器与内存之间没有直接的渠道，而必须通过多级的高速缓存才能到内存。高速缓存的作用依然是为了弥补</span>CPU<span
lang=ZH-CN>和内存在速度上的差异，高速缓存提高效率的原理是基于时间局部性和空间局部性，我们稍后将详细讨论这个概念。虽然高速缓存对用户来说是透明的，我们的代码要不直接操作寄存器，要不直接操作内存，但它并不是不存在，如果深究下去会发现如何保障内存和对应</span>CPU<span
lang=ZH-CN>缓存的同步是个问题。但是我们不要担心诸如此类的“一个核心写另一个核心脏读”的情况，缓存一致性协议能够解决内存和多核</span>CPU<span
lang=ZH-CN>缓存之间以及缓存与缓存之间的同步性问题。但我们仍然要关注缓存这个概念以写出高质量的程序。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>局部性原理</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>时间局部性和空间局部性原理表示被引用过一次的存储器位置很可能在不远的将来再次被引用，而存储器中的某一个地址被引用过，那么它附近的地址很可能也会被使用。我们考虑对一个向量求和</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>int s = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>0</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>for</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>(int </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>i</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> = </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>0</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>; </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>i</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> &lt; N; </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>i</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>++){<br>
  <span style='mso-spacerun:yes'>    </span>s += v[i];<br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>return</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> s;<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>首先对于标量</span><span style='font-size:
10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>s</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，它并没有空间局部性一说，但是它在每次循环中都被访问，因此具有较好的时间局部性。而向量</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>v</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是被<b>逐一</b>访问的，即具有步长为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>1<span lang=ZH-CN>的引用模式，因此空间局部性很好，不过用一次就不用了，所以时间局部性不好。一般来说步长越小，空间局部性越好。这样的空间局部性在对二维数组的访问上会更加明显，例如对于行存储的模型，如果以列为单位遍历，那么就会破坏空间局部性，这个在我</span>CFortranTranslator<span
lang=ZH-CN>工程的设计上曾有所考虑。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>多级缓存和缓存不命中</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>往下深究局部性原理，我们能够想到缓存不命中的问题。我们始终希望能够在当前缓存找到我们需要的对象，这样最快，但缓存的容量总是有限的。当缓存不能命中时，我们就需要从下一级缓存中找。当系统开始运行时缓存是空的，这时候的命中称为冷不命中或者强制不命中，没有什么道理可讲。下面我们考虑如何快速地根据地址</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>m</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来定位和映射</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Cache<span lang=ZH-CN>，由于一般高层</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>k</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>缓存的容量要小，所以缓存在设计的时候会分成几个桶（高速缓存组），这样可以</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Hash<span lang=ZH-CN>到桶里面。事实上高速缓存一般将地址分为三段，即组索引位</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>s</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、行标记位</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>t</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和偏移位</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>b</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。这样的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Hash<span lang=ZH-CN>可能存在问题，例如我们</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>mod 4</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>一下到四个桶里面。那么假如说我们从</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>k+1</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>层交替访问</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>0<span lang=ZH-CN>号和</span>8<span
lang=ZH-CN>号块，那么我们发现其实缓存会一直不命中，即使其他的块还是空的，这被称为冲突不命中</span>(conflict miss)<span
lang=ZH-CN>。当然有的时候缓存就是太小了，这个就是容量不命中</span>(capacity miss)<span lang=ZH-CN>。</span><br>
</span><span lang=EN-GB><a href="http://www.calvinneo.com/img/concur/hchang.jpg"><span
lang=EN-US style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK;
mso-no-proof:yes;text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_4" o:spid="_x0000_i1028" type="#_x0000_t75" alt="http://www.calvinneo.com/img/concur/hchang.jpg"
 href="http://www.calvinneo.com/img/concur/hchang.jpg" style='width:451pt;
 height:142pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image007.jpg" o:title="hchang"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=451 height=142 src="并发编程重要概念及比较.fld/image007.jpg"
alt="http://www.calvinneo.com/img/concur/hchang.jpg" v:shapes="Picture_x0020_4"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><br>
<span lang=ZH-CN>在组织时，我们按照桶的数量和桶中元素数量的区别将高速缓存分为了直接映射高速缓存、组相联高速缓存和全相联高速缓存。直接映射</span>(direct-mapped)<span
lang=ZH-CN>高速缓存每一个桶里面只有一行，缓存根据是否命中会选择直接返回或者向下层请求对应块。整个匹配过程分为三步，第一步是组选择，我们在地址的<b>中间</b>部分抽出</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>s</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>个位作为组索引位</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>s</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>s</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的大小取决于组数</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>S</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，我们有关系</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>$S = log_2^S$<span
lang=ZH-CN>。我们选择中间部分是出于对空间局部性的利用，如果我们使用高位做索引，那么我们空间局部性好的连续的块就会被映射到一个桶里面，这样的话就会导致缓存的频繁刷新。然后第二步是行匹配，我们根据标记位</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>t</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>去寻找一个<b>有效位被设置了的</b>缓存，这是因为缓存可能会失效，这个对于只有一行的直接映射缓存来说的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>trivial<span
lang=ZH-CN>的。</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>t</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>是由</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>s</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>b</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>决定的，假设地址长度为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>m</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，块偏移位数为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>b</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，那么我们的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>t = m - s - b</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这样做的话，一旦我们找到匹配的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>t</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，我们就可以认为这个地址在缓存行中。由于</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>s</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>占了中间位，所以</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>t</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>实际上就占了高位。于是第三步是字选择，因为缓存行是一个包含了</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>$2^b$<span lang=ZH-CN>字节的块，我们整体读出来是没用的，所以我们要读到指定的字需要一个</span>offset<span
lang=ZH-CN>，这时候就可以借助于缓存行中的偏移位</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>b</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>了。对于下面的代码，如果</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>x<span lang=ZH-CN>和</span>y<span
lang=ZH-CN>都被映射到一个高速缓存组中，就会造成</span>thrash<span lang=ZH-CN>。</span>CSAPP<span
lang=ZH-CN>中指出，即使一个局部空间性看上去很好的程序也可能造成缓存抖动</span>(thrash)<span lang=ZH-CN>。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>for</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(int </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>i</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'> = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>; </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>i</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'> &lt; </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>8</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>; </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>i</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>++){<br>
  <span style='mso-spacerun:yes'>    </span>s += x[i] * y[i];<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>此外，对于异常控制流，例如中断和上下文切换，缓存工作会受影响。此时主程序的缓存和中断处理的程序缓存会相互影响导致互相变</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>cold<span lang=ZH-CN>。这种情况下当中断返回或者上下文切换回来时缓存需要较长时间来</span>warm
up<span lang=ZH-CN>，这种情况称为缓存污染</span>(cache pollution)<span lang=ZH-CN>。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>常见的缓存替换算法</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在组相联高速缓存中，每个组中存在多个缓存行。如果我们当前的缓存满了的话，就需要去确定一个最合适的牺牲块</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(victim block)<span
lang=ZH-CN>进行替换，我们有常见的</span>LRU<span lang=ZH-CN>和</span>LFU<span lang=ZH-CN>算法来达成这个目的。</span>LFU<span
lang=ZH-CN>替换过去引用次数最少的行，</span>LRU<span lang=ZH-CN>替换最后一次访问时间最久远的一行。但是当出现偶发性的批量操作时</span>LRU<span
lang=ZH-CN>容易将</span>Hot<span lang=ZH-CN>块（访问频率高的块）移出缓存，造成缓存污染。这时候我们引入了</span>LFU<span
lang=ZH-CN>算法，</span>LFU<span lang=ZH-CN>需要额外的一些计算，但是在性能上好于</span>LRU<span
lang=ZH-CN>，但当数据访问模式改变后</span>LFU<span lang=ZH-CN>需要较长的时间重新进行适应（统计频率）。因此我们引入了</span>LRU-K<span
lang=ZH-CN>算法，这个算法比较距当前第</span>K<span lang=ZH-CN>次的访问时间和当前时间的距离来移出缓存。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>缓存一致性协议</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>MESI<span lang=ZH-CN>是实现缓存一致性的一个基础协议，</span>MESI<span
lang=ZH-CN>分别表示缓存行可能处于的四个状态</span>Modified<span lang=ZH-CN>、</span>Exclusive<span
lang=ZH-CN>、</span>Shared<span lang=ZH-CN>、</span>Invalid<span lang=ZH-CN>。其中</span>Intel<span
lang=ZH-CN>使用了扩展的</span>MESIF<span lang=ZH-CN>，增加了状态</span>Forward<span
lang=ZH-CN>，而</span>AMD<span lang=ZH-CN>使用了</span>MOESI<span lang=ZH-CN>，增加了状态</span>Owned<span
lang=ZH-CN>。</span>MESI<span lang=ZH-CN>协议需要正确处理</span>local read(LR)<span
lang=ZH-CN>、</span>local write(LW)<span lang=ZH-CN>、</span>remote read(RR)<span
lang=ZH-CN>、</span>remote write(RW)<span lang=ZH-CN>四个场景，其中</span>local<span
lang=ZH-CN>表示本</span>core<span lang=ZH-CN>对本地缓存读写，而</span>remote<span
lang=ZH-CN>则表示非本地</span>core<span lang=ZH-CN>对非本地缓存的读写。一个缓存行</span>Cache0<span
lang=ZH-CN>初始状态为</span>I<span lang=ZH-CN>，因为它并不缓存任何数据。当本地</span>core<span
lang=ZH-CN>向该缓存行请求时，</span>CPU<span lang=ZH-CN>会向其他缓存行询问，如果存在缓存行</span>Cache1<span
lang=ZH-CN>拥有该缓存，则将对应缓存行设为</span>S<span lang=ZH-CN>状态，表示目前有多个缓存行缓存有该数据，并且缓存行中数据和内存中一样；否则从内存中加载到</span>Cache0<span
lang=ZH-CN>，并设为</span>E<span lang=ZH-CN>状态，表示目前只有一个缓存行缓存有该数据。当本地处理器写入时，缓存行状态变为</span>M<span
lang=ZH-CN>，此时缓存与主存之间的数据不一致，</span>CPU<span lang=ZH-CN>通知所有对应的其他的缓存行失效。这时候相当于该</span>core<span
lang=ZH-CN>独有这个缓存行，而其他</span>core<span lang=ZH-CN>缓存行的状态变为</span>I<span
lang=ZH-CN>。下面的图描述了四种读写下的状态变化。容易理解的是所有的</span>RW<span lang=ZH-CN>都会导致</span>I<span
lang=ZH-CN>，所有的</span>RR<span lang=ZH-CN>都会导致</span>S<span lang=ZH-CN>，所有的</span>LW<span
lang=ZH-CN>都会导致</span>M<span lang=ZH-CN>，下面考虑</span>LR<span lang=ZH-CN>。对于状态</span>E<span
lang=ZH-CN>，由于是独占的，所以怎么读都是</span>E<span lang=ZH-CN>，因此是自环。同理状态</span>M<span
lang=ZH-CN>也是独占的。对于</span>S<span lang=ZH-CN>状态，虽然不是独占，但缓存行中数据和主存一致，因而是有效的，所以也是自环。下面对于</span>I<span
lang=ZH-CN>状态，缓存行失效意味着有其他</span>core<span lang=ZH-CN>的写导致了缓存行的刷新，所以进行</span>LR<span
lang=ZH-CN>之后实际上就和这些</span>core<span lang=ZH-CN>进行了数据的同步，也就是回到了</span>S<span
lang=ZH-CN>状态。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><br>
</span><span lang=EN-GB><a href="http://www.calvinneo.com/img/concur/mesi.jpg"><span
lang=EN-US style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK;
mso-no-proof:yes;text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shape
 id="Picture_x0020_3" o:spid="_x0000_i1027" type="#_x0000_t75" alt="http://www.calvinneo.com/img/concur/mesi.jpg"
 href="http://www.calvinneo.com/img/concur/mesi.jpg" style='width:375pt;
 height:256pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image008.jpg" o:title="mesi"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=375 height=256 src="并发编程重要概念及比较.fld/image008.jpg"
alt="http://www.calvinneo.com/img/concur/mesi.jpg" v:shapes="Picture_x0020_3"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>伪共享</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>伪共享</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(False Sharing)<span lang=ZH-CN>是在</span>MESI<span
lang=ZH-CN>模型下多个线程对同一缓存行竞争写所导致的性能降低。我们考虑</span><a
href="https://blog.csdn.net/qq_27680317/article/details/78486220"
target="_blank"><span lang=ZH-CN style='color:#555555'>这篇博文中的一个场景</span></a><span
lang=ZH-CN>一个数组</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>int32_t arr[]</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>被同时加载到</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CPU0<span lang=ZH-CN>和</span>CPU1<span
lang=ZH-CN>的</span>L1<span lang=ZH-CN>缓存</span>Cache0<span lang=ZH-CN>和</span>Cache1<span
lang=ZH-CN>上。现在两个线程</span>A<span lang=ZH-CN>和</span>B<span lang=ZH-CN>试图分别修改</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>arr[0]</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>arr[1]</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。这种情况下是不存在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>race condition<span
lang=ZH-CN>的，但是可能导致伪共享。我们考虑初始情况下</span>Cache0<span lang=ZH-CN>和</span>Cache1<span
lang=ZH-CN>都处于</span>S<span lang=ZH-CN>状态，现在</span>CPU0<span lang=ZH-CN>收到线程</span>A<span
lang=ZH-CN>的请求，写</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>arr[0]</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>，</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Cache0<span lang=ZH-CN>状态变为</span>M<span
lang=ZH-CN>，而</span>Cache1<span lang=ZH-CN>收到通知后也作废了自己的缓存行。接下来</span>CPU1<span
lang=ZH-CN>发起了写操作，根据</span>MESI<span lang=ZH-CN>模型，</span>CPU0<span lang=ZH-CN>会先将</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>arr[0]</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>写回内存，此时</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Cache0<span
lang=ZH-CN>变为</span>I<span lang=ZH-CN>，之后</span>CPU1<span lang=ZH-CN>才能从内存重新读取，</span>Cache1<span
lang=ZH-CN>变成</span>E<span lang=ZH-CN>，然后</span>CPU1<span lang=ZH-CN>才能修改</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>arr[1]</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。为了解决伪共享存在的问题，我们通常的做法是尽量避免将需要访问的数据放到同一个缓存行中，而这就是在一些指令中需要内存对齐的原因，还有的原因是原子操作上的考虑。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>测试缓存大小</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>缓存一致性和</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>volatile<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>既然我们</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>总是能读到内存里面最新的值，那为啥还需要</span>volatile<span
lang=ZH-CN>呢？原因有二</span><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l1 level1 lfo3;
     tab-stops:list 36.0pt;background:white'><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>不一定会读缓存，可能直接读寄存器这时候要注意区分</span>CPU<span
     lang=ZH-CN>缓存一致性和</span>volatile<span lang=ZH-CN>之间的关系。例如出于优化的角度，编译器可能把一个在内存的值放到到寄存器里面，以避免访问内存，既然不访问内存那和缓存一致也没啥关系了。但这样就会出现问题，如果某个线程修改了这个值对应的内存，那么寄存器是不知道的，所以这时候</span>volatile<span
     lang=ZH-CN>强制说不要在寄存器里面读啦，直接从内存里面读，这时候缓存就能发挥应该有的作用了。所以</span><b>CPU<span
     lang=ZH-CN>缓存一致性解决的是</span>CPU<span lang=ZH-CN>的</span>Lx<span lang=ZH-CN>缓存和内存之间之间的问题，而不是</span>CPU<span
     lang=ZH-CN>寄存器和内存之间的问题</span></b><span lang=ZH-CN>。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l1 level1 lfo3;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>有的缓存一致性也不保证是任意时刻的经过</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><a
     href="http://www.infoq.com/cn/articles/cache-coherency-primer/"
     target="_blank"><span lang=ZH-CN style='color:#555555'>简单的了解</span></a><span
     lang=ZH-CN>，</span>CPU<span lang=ZH-CN>缓存行的写操作也分为直写</span>(write though)<span
     lang=ZH-CN>和回写</span>(write back)<span lang=ZH-CN>两种策略。直写就是同时写缓存和内存，因此对于直写来说，确实可以做到任意时刻各缓存中的内容等于内存中内容；但回写就不一定是任意时刻了，因为它并不是立即更新缓存，而是值修改本级缓存，而将对应缓存标记为脏段，只有当所有脏段被会邂逅我们才能达到一致性。具体还可以参看</span><a
     href="http://ifeve.com/cpu-cache-flushing-fallacy-cn/" target="_blank"><span
     lang=ZH-CN style='color:#555555'>缓存一致性</span></a><span lang=ZH-CN>。</span><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>提供的并发处理机制</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>栅栏</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>以</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>x86<span lang=ZH-CN>为例，提供了</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>lfence</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>sfence</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和两者合一的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>mfence</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;text-justify:inter-ideograph;
mso-outline-level:1;background:white'><b><span lang=ZH-CN style='font-size:
16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'>内核层面的同步与并发</span></b><b><span
style='font-size:16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>中断</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在现在的多核</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>（特别是</span>SMP<span
lang=ZH-CN>架构）背景下，中断的机制和单核有所区别。在</span>x86<span lang=ZH-CN>中使用的是高级可编程中断控制器</span>(APIC)<span
lang=ZH-CN>，</span>APIC<span lang=ZH-CN>由本地</span>APIC<span lang=ZH-CN>和</span>IO
APIC<span lang=ZH-CN>组成，其中本地</span>APIC<span lang=ZH-CN>与每个处理器核心对应，</span>IO
APIC<span lang=ZH-CN>负责采集和转发来自</span>IO<span lang=ZH-CN>设备的中断信号。根据</span>Intel<span
lang=ZH-CN>的规定，广义上的中断可分为</span><a
href="https://www.ibm.com/developerworks/cn/linux/l-cn-linuxkernelint/index.html"
target="_blank"><span lang=ZH-CN style='color:#555555'>同步中断和异步中断</span></a><span
lang=ZH-CN>。</span><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l7 level1 lfo4;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>同步中断又称<b>异常</b>，实际上是由</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>产生的，因此显然不能被屏蔽，异常分为故障</span>(fault)<span
     lang=ZH-CN>、陷阱</span>(trap)<span lang=ZH-CN>和终止</span>(abort)<span
     lang=ZH-CN>，对应到中断号的</span>0-15<span lang=ZH-CN>。异步中断又称中断，分为外部非屏蔽中断</span>(NMI)<span
     lang=ZH-CN>和外部可屏蔽中断</span>(INTR)<span lang=ZH-CN>，分别对应中断号的</span>16-31<span
     lang=ZH-CN>和</span>32-47<span lang=ZH-CN>。</span>Intel<span lang=ZH-CN>将非屏蔽中断也归入异常，所以异常一般为来自外设或</span>CPU<span
     lang=ZH-CN>中的非法或故障状态，例如常见的除零错误、缺页（故障）、单步调试（陷阱）等情况。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l7 level1 lfo4;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>在中断的语境中，我们主要讨论异步中断中的可屏蔽中断，它通常是来自外部设备的中断。这是因为除了一些硬件故障，来自外部</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>IO<span lang=ZH-CN>设备的中断常是可以等待的，所以属于可屏蔽中断，当</span>IF<span
     lang=ZH-CN>标志为</span>1<span lang=ZH-CN>时，</span>CPU<span lang=ZH-CN>可以不响应可屏蔽中断，而是将它<b>缓存</b>起来，在开中断后会传给</span>CPU<span
     lang=ZH-CN>。当</span>CPU<span lang=ZH-CN>在响应一个异常时，所有的可屏蔽中断都将被屏蔽，而如果此时再出现一个异常，即产生了</span>double
     fault<span lang=ZH-CN>故障，一般来说系统就会宕机。</span><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>上每一个</span>CPU<span lang=ZH-CN>都拥有一个中断栈，这个始于</span>Linux2.6<span
lang=ZH-CN>的版本，在此之前，中断共享其所在的内核栈，后来</span>Linux<span lang=ZH-CN>认为对每个进程提供两页<b>不可换出</b>的内核栈太奢侈的，所以就将其缩小为</span>1<span
lang=ZH-CN>页，并且将中断栈独立了出来。中断处理的原则是快，否则很容易被覆盖。因此，中断上下文又被称为原子上下文（《</span>Linux<span
lang=ZH-CN>内核设计与实现》），该上下文中的代码不允许阻塞，这是因为中断上下文完全不具备进程的结构，因此在睡眠之后无法被重新调度。在操作系统如</span>Linux<span
lang=ZH-CN>中，中断还可以被分为<b>软件中断（内部中断）</b>和硬中断，硬中断是来自硬件的中断，它可以是可屏蔽的，也可以是不可屏蔽的。软件中断一般是由</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>int</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>指令产生的，由操作系统提供，在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>中软中断对应于中断号</span>48-255<span
lang=ZH-CN>。软件中断是不可屏蔽的（不然干嘛调用</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>int</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>呢），但在操作系统中软件中断也可能是由一个硬中断产生的，例如一个来自打印机的硬中断可能产生一个软件中断给内核中的相关处理程序。我们需要区分<b>软件中断</b>和<b>软中断</b>，前者指的是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>INT</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>指令，后者特指</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>的一种<b>中断推后处理机制</b>（在</span>Windows<span
lang=ZH-CN>和</span>Linux<span lang=ZH-CN>的分别被称为中断延时处理和中断下半部）。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>中断程序的注册和处理</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>需要使用中断的驱动程序会调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>request_irq()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>向内核注册一个中断号</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>irq</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和中断处理函数</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>irq_handler_t handler</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，并激活对应的中断线。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>request_irq()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>会接受一个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>flag<span lang=ZH-CN>，</span>flag<span
lang=ZH-CN>中的一个选项</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>IRQF_DISABLED</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>表示禁用所有中断，如果不设置这个值，那么该中断处理程序可以被<b>非同种中断</b>打断，这也就是说</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>中硬中断是<b>可以嵌套</b>的。不过</span>Linux<span
lang=ZH-CN>禁止来自同种类中断的打断，它会挂起后来的中断，这主要是为了<b>防止重入现象</b>的发生，从而简化系统实现。</span>Linux<span
lang=ZH-CN>通过</span><a
href="http://blog.csdn.net/yusiguyuan/article/details/23701519" target="_blank"><span
lang=ZH-CN style='color:#555555'>巧妙的机制</span></a><span lang=ZH-CN>来防止同种类中断重入。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>当中断来临时，</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>IRQ_PENDING</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>被设置，表示正在排队</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// action</span><span
  lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>为当前的中断处理函数指针</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>action</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> = NULL;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// </span><span
  lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>如果</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>IRQ_INPROGRESS</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>不为</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>0</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>，说明有正在处理的同种中断，所以拜拜</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>if</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (likely(!(status &amp; (IRQ_DISABLED
  | IRQ_INPROGRESS)))) {<br>
  <span style='mso-tab-count:1'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>action</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> = desc-&gt;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>action</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>如果当前没有中断等待处理，我们清除</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>IRQ_PENDING</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>，设置</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>IRQ_INPROGRESS</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-tab-count:1'>        </span>status &amp;= ~IRQ_PENDING; </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>/* we commit to handling */</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-tab-count:1'>        </span>status |= IRQ_INPROGRESS; </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>/* we are handling it */</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  }<br>
  desc-&gt;status = status;<br>
  <span style='mso-spacerun:yes'> </span><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>/*</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'><span
  style='mso-spacerun:yes'> </span>* If there is no IRQ handler or it was
  disabled, exit early.</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'><span
  style='mso-spacerun:yes'> </span>* Since we set PENDING, if another processor
  is handling</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'><span
  style='mso-spacerun:yes'> </span>* a different instance of this same irq, the
  other processor</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'><span
  style='mso-spacerun:yes'> </span>* will take care of it.</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'><span
  style='mso-spacerun:yes'> </span>*/</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>if</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (unlikely(!</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>action</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>))<br>
  <span style='mso-tab-count:1'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>goto</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> out;<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>需要特别注意的是“只要非同种中断发生就可以抢占内核”这句话也是不准确的，因为开中断发生在中断处理函数</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>handle_IRQ_event</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中，此时如果没有设置</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>IRQF_DISABLED</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>就会立马开中断。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>irqreturn_t handle_IRQ_event(unsigned </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>int</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> irq, struct irqaction *action)<br>
  {<br>
  <span style='mso-spacerun:yes'>    </span>...<br>
  <span style='mso-tab-count:1'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (!(action-&gt;flags &amp; IRQF_DISABLED))<br>
  <span style='mso-tab-count:1'>        </span><span
  style='mso-spacerun:yes'>    </span>local_irq_enable_in_hardir</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>q()</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>;<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>但是在这个函数前的一条调用链中都是<b>关中断</b>的，这是</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>的一个特性，即中断发生时触发中断门会自动关中断，也就是置</span>IF<span
lang=ZH-CN>为</span>0<span lang=ZH-CN>，可参考</span><a
href="http://abcdxyzk.github.io/blog/2015/05/07/kernel-irq-irq/" target="_blank"><span
lang=ZH-CN style='color:#555555'>这篇文章</span></a><span lang=ZH-CN>。关中断的好处在于可以防止中断嵌套，防止<b>内核抢占</b>，但不能禁止<b>来自</b></span><b>SMP<span
lang=ZH-CN>架构下其他处理器的并发访问</span></b><span lang=ZH-CN>，为了解决这种并发访问，通常的做法是借助于例如自旋锁的机制。此外在关中断时要注意关中断会导致异步</span>IO<span
lang=ZH-CN>、调度等一系列依赖中断的功能失效，所以屏蔽中断后一定要尽快执行完临界区内代码。此外，</span>flag<span
lang=ZH-CN>中还有一些其他的选项，例如</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>IRQF_SAMPLE_RANDOM</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这个被</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>用来实现随机数，会将每次的中断间隔填入内存熵池。与之对应的是</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>IRQF_TIMER</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这个表示系统时钟中断，显然系统时钟具有固定间隔，是不适合用来实现随机数的。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>中断的开启与关闭</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>我们使用</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>local_irq_disable</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>local_irq_enable</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来控制<b>当前</b>处理器的中断，他们对应到</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>x86<span lang=ZH-CN>架构上就是常见的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>cli</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>sti</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>命令。不过</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>更推荐使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>local_irq_save</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来禁止中断、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>local_irq_restore</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来恢复到原来的状态（因为可能一直就是禁止中断的）。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>static</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>inline</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>native_irq_disable</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>)</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  {<br>
  <span style='mso-tab-count:1'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>asm</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>volatile</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>(</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#718C00;mso-ansi-language:EN-HK'>&quot;cli&quot;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>: : :</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>&quot;memory&quot;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>)</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>;<br>
  }<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>static</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>inline</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>native_irq_enable</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>)</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  {<br>
  <span style='mso-tab-count:1'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>asm</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>volatile</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>(</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#718C00;mso-ansi-language:EN-HK'>&quot;sti&quot;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>: : :</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>&quot;memory&quot;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>)</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>《</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>内核设计与实现》指出在</span>2.5<span
lang=ZH-CN>版本前存在一个禁止所有处理器中断的内核函数</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>cli()</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这个函数非常暴力，乃至它实际上提供了对其他所有中断处理程序的互斥访问机制，在这一把全局大锁下我们实际上就可以保证共享数据的互斥了，也就不要像后面版本中那样关闭本地中断后还需要用自旋锁来维护。取消这个全局大锁的好处是使用细粒度的锁能提高性能。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><br>
<span lang=ZH-CN>相对于</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>local_</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>系更轻量级的方案是只禁用一种中断，也就是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>disable_irq</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>disable_irq_nosync</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>系列，他们禁止中断控制器上的指定中断线</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>irq</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，其中</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_nosync</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>系列立即返回，而前面的需要等待已有的中断处理完毕，其实就是在调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_nosync</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>之后调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>synchronize_irq</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>去等待，借助于</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>raw_spin_lock_irqsave</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。《</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>内核设计与实现》指出</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>disable_irq</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>enable_irq</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>不是幂等的，因此要成对调用才能确保正确回到原始状态。此外还指出这个是保证不会</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>sleep<span lang=ZH-CN>的，但是我在</span>4.17<span
lang=ZH-CN>的内核中看到现在的实现是</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>wait_event</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>一个事件，里面涉及一个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>might_sleep</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>宏的调用。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>共享中断</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>的中断是可以共享的，也就是说同一个中断可以有多个处理程序响应。一个共享中断，例如定时器中断，必须通过</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>request_irq</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>设置</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>IRQF_SHARED</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>标志。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>中断下半部</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>中，中断下半部可以被硬中断打断，所以可以认为硬中断具有更高的“优先级”（不过</span>Linux<span
lang=ZH-CN>中并没有中断优先级的概念，虽然也有个中断线程化的东西）。这道理是显然的，因为我们又要快速地响应设备，又不能在中断上下文停留过久，所以才发明了中断下半部这个东西。</span>Linux<span
lang=ZH-CN>中的中断下半部的实现有三种机制：</span>Orignial Bottom Half<span lang=ZH-CN>机制、</span>Task
Queue<span lang=ZH-CN>机制、软中断</span>Softirq<span lang=ZH-CN>机制、</span>tasklet<span
lang=ZH-CN>和工作队列，其中前两种已被替代。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Orignial
Bottom Half(BH)<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>使用</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>32<span lang=ZH-CN>个链表串联，全局中只有一个</span>BH<span
lang=ZH-CN>能够运行。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Task
Queue<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span lang=ZH-CN style='font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>软中断</span></b><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>从</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>2.3<span lang=ZH-CN>开始，软中断和</span>tasklet<span
lang=ZH-CN>被引入，其中</span>tasklet<span lang=ZH-CN>是基于软中断实现的。软中断和软中断之间是不会抢占的，事实上它们被抢占也就是如之前提到的<b>只能被硬中断抢占</b>，但包括相同类型的软中断都可以在</span>SMP<span
lang=ZH-CN>的不同</span>CPU<span lang=ZH-CN>上并行执行。注意</span><a
href="http://unicornx.github.io/2016/02/11/20160211-lk-drv-softirq/"
target="_blank"><span lang=ZH-CN style='color:#555555'>软中断处理函数属于中断上下文</span></a><span
lang=ZH-CN>，从而在处理软中断时也不允许休眠，所以其实软中断的优先级还是很高的。</span>Linux<span lang=ZH-CN>中使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>softirq_action</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>结构表示软中断，</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>中设置了一个长度为</span>32<span
lang=ZH-CN>的</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>softirq_action</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>数组来存放这些中断。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>struct</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>softirq_action</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> {<span style='mso-spacerun:yes'> 
  </span><br>
  <span style='mso-spacerun:yes'>    </span>void (*action) (</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>struct</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>softirq_action</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> *); </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>/* </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>软中断的处理函数</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'> */</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><span style='mso-spacerun:yes'>  </span><br>
  };<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>可以看出，软中断实际上很像一个回调函数。那么软中断和回调函数之间有什么区别呢：</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l16 level1 lfo5;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>软中断能够实现不同优先级代码的跳转</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l16 level1 lfo5;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>软中断的重入性和回调函数不同</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>软中断的检查与执行一般出现在以下几种情况：</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l2 level1 lfo6;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>从硬中断返回时。这是一个很常见的情况，因为从硬中断返回之后往往会立即开启软中断，但是在软中断时可以自由地抢占了。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l2 level1 lfo6;
     tab-stops:list 36.0pt;background:white'><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>ksoftirqd<span lang=ZH-CN>内核线程。这个内核线程是为了处理可能存在的大量的软中断。对于如网络子系统之类的使用软中断的系统，他们可能会频繁的触发软中断，并且在软中断处理函数中可能还会重复触发软中断。这样就会存在大量的软中断抢占其他任务执行时间的问题。对于这个问题，单纯地选择执行完所有当前的软中断或者所有重复触发的软中断都放到下一跳执行都是不合适的。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l2 level1 lfo6;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>来自网络子系统等显式要求检查软中断的部分。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>软中断的执行非常有意思，通过移位操作来实现按顺序</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>check<span lang=ZH-CN>并执行</span>32<span
lang=ZH-CN>个软中断的行为，具体可以查看《</span>Linux<span lang=ZH-CN>内核与实现》</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>虽然不如硬中断处理函数那么严苛，但由上可见软中断的使用还是有很大限制的，目前使用软中断的主要有网络</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>IO<span lang=ZH-CN>、</span>SCSI<span
lang=ZH-CN>、内核定时器、</span>tasklet<span lang=ZH-CN>等、</span>RCU<span lang=ZH-CN>等。</span><br>
<span lang=ZH-CN>但注意工作队列由内核线程</span>eventX<span lang=ZH-CN>执行，允许被调度甚至睡眠。</span>Linux<span
lang=ZH-CN>的外部中断处理过程可以参考</span><a
href="http://home.ustc.edu.cn/~boj/courses/linux_kernel/2_int.html"
target="_blank"><span lang=ZH-CN style='color:#555555'>文章</span></a><span
lang=ZH-CN>。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>tasklet<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>相对于</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>softirq<span lang=ZH-CN>，相同类型的</span>tasklet<span
lang=ZH-CN>在一个时刻只有一个在执行。</span>tasklet<span lang=ZH-CN>通过</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>TASKLET_SOFTIRQ</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>HI_SOFTIRQ</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>两个软中断触发，实际上也是出于中断上下文之中的，所以不能睡眠。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>进程与线程设施</span></b><b><span
style='font-size:15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>进程模型</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>五状态进程模型包括新建、就绪（等待</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>）、阻塞（等待事件）、运行和退出。在五状态模型之外，还有挂起操作。挂起操作指的是将进程交换到外存，这常常是由于内存紧张或者该进程被阻塞的缘故。挂起不同于阻塞或者就绪，被挂起的进程犹如进入一个平行世界，当等待的事件到达时，它能够从挂起阻塞直接切换成挂起就绪。一个挂起的进程必须脱去挂起这层壳之后才能重新进入五状态模型，如一个挂起就绪态进程必须换回到内存切换成就绪态才能被调度。在</span>Linux<span
lang=ZH-CN>中，进程的状态主要有</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>TASK_RUNNING</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>TASK_INTERRUPTIBLE</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>TASK_UNINTERRUPTIBLE</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_TASK_TRACED</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_TASK_STOPPED</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。其中</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>TASK_RUNNING</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>表示进程处于执行或者排队等待执行的状态，此时进程可能位于用户态，也可能位于内核态。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>TASK_INTERRUPTIBLE</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>表示进程正在被阻塞，等待条件达成或者信号。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>TASK_UNINTERRUPTIBLE</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是不可中断的睡眠状态，这是指这个进程不响应</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>SIGKILL</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等外部信号，因此必须是十分短暂的，在</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>ps -aux</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>命令中显示为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>D<span lang=ZH-CN>。顺带一提另一令不能响应外部信号的僵尸进程</span>Z<span
lang=ZH-CN>（区别于失去父进程的孤儿进程），僵尸进程的资源已经被全部释放，只留下包括</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>task_struct</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>在内的一点信息用来给父进程提供返回码等信息，如果此时父进程被阻塞而不能回收子进程，那么子进程就会进入僵尸状态。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>fork</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>出的子进程默认会拷贝父进程的一系列资源，包括内存（包括堆栈）、文件描述符（特别地</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>exec</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>也会保留文件描述符，可以参考我有关</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>subprocess<span
lang=ZH-CN>的文章）、信号设定、</span>Nice<span lang=ZH-CN>优先级值、工作目录等。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>线程模型</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>根据调度者在内核内还是内核外将线程分为用户线程和核心线程，前者一般更利于并发使用多核处理器资源，后者则需要较多地考虑上下文切换的开销。为此在设计时往往会引入一对多或者一对一多对多等线程模型，例如使用一个核心线程去调度多个用户线程。</span>pthread(POSIX
threads)<span lang=ZH-CN>是</span>POSIX<span lang=ZH-CN>下的一套线程模型，而</span>Linux<span
lang=ZH-CN>对这套模型或者接口的实现跟随时间先后有</span>LinuxThreads<span lang=ZH-CN>和</span>NPTL<span
lang=ZH-CN>等几种方式。</span><o:p></o:p></span></p>

<ol style='margin-top:0cm' start=1 type=1>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l3 level1 lfo7;tab-stops:
     list 36.0pt;background:white'><span style='font-size:10.5pt;font-family:
     "PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>LinuxThreads<o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:18.75pt;
margin-left:36.0pt;text-align:justify;text-justify:inter-ideograph;background:
white'><span lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>容易想到的简单办法就是直接复用进程，也就是</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>LinuxThread<span
lang=ZH-CN>轻量级线程。无论是</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>fork()</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>还是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pthread_create()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，最后都是调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>do_fork()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，普通进程和轻量级进程（线程）的区别在于调用参数不同。线程的创建一般会使用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>CLONE_VM | CLONE_FS |
CLONE_FILES | CLONE_SIGHAND</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>等</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>clone_flags</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>参数选项，表示共享地址空间、文件系统、描述符和信号处理，而</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>fork</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>只有</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>CLONE_CHLD</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol style='margin-top:0cm' start=2 type=1>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l3 level1 lfo7;tab-stops:
     list 36.0pt;background:white'><span style='font-size:10.5pt;font-family:
     "PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>NPTL<o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:18.75pt;
margin-left:36.0pt;text-align:justify;text-justify:inter-ideograph;background:
white'><span style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>NPTL(Native
POSIX Thread Library)<span lang=ZH-CN>是</span>POSIX<span lang=ZH-CN>线程模型的新实现，我们可以再</span>glibc<span
lang=ZH-CN>库源码的</span><i>nptl</i><span lang=ZH-CN>目录下可以看到它被用来实现了</span>pthread<span
lang=ZH-CN>系列函数接口</span>s<span lang=ZH-CN>。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>信号</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>中信号是一个实现异步的机制。信号分为同步信号</span>(synchronous
signal)<span lang=ZH-CN>和异步信号</span>(asynchronous signal)<span lang=ZH-CN>。同步信号类似于</span>SIGFPE<span
lang=ZH-CN>、</span>SIGSEGV<span lang=ZH-CN>，通常标记着一个无法恢复的错误，来自当前执行上下文中，通常</span><a
href="https://www.linuxjournal.com/article/3985" target="_blank"><span
lang=ZH-CN style='color:#555555'>由一个</span><span style='color:#555555'>trap<span
lang=ZH-CN>陷入内核，并由一个</span>trap handler<span lang=ZH-CN>触发</span></span></a><span
lang=ZH-CN>。异步信号则来自当前的执行上下文之外</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>系统调用</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在稍后的论述中，我们将看到进程在用户态和内核态之间切换时常伴随有很多奇妙的工作，不过首先来先行讨论一下系统调用。进程从用户态进入内核态可以通过系统调用、异常（如缺页异常）和来自外部设备的硬中断，而系统调用是最常见的一种，也是应用程序唯一主动进入内核的机制。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>的系统调用以</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>asmlinkage long sys_</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>打头，据说</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>asmlinkage</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>保证从栈中提取函数的参数，其实就是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>CPP_ASMLINKAGE
__attribure__((syscall_linkage))</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>，其中</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>CPP_ASMLINKAGE</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>就是在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>上用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>extern &quot;C&quot;</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>导出符号。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>system_call</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>系统调用负责系统调用并陷入内核，从前它是一个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>int 0x80</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>指令，现在它是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>sysenter</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>指令，它精简了</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>int</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的流程。这是因为保护模式中</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>首先从中断描述符表</span>(IDT)<span
lang=ZH-CN>中取出对应的门描述符，比较中断描述符级别</span>DPL<span lang=ZH-CN>和</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>int</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>调用者级别</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPL<span lang=ZH-CN>，我们禁止</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>CPL&gt;DPL</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的调用，但是对于系统调用来说比较描述符的这一步是能省掉的，因为我们可以确定这个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPL<span lang=ZH-CN>和</span>DPL<span
lang=ZH-CN>。</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>system_call</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>从</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>eax</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中获得系统调用号，并定位到对应的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>NR_</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>调用位置。我们需要特别注意的是由于内核抢占和</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>SMP<span lang=ZH-CN>的关系，我的系统调用一定要是可重入的。因此<b>系统调用时完全可以被信号打断的</b>，当然我们也可以在调用前通过</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>SIG_IGN</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>sigprocmask()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pthread_sigmask()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的方法去屏蔽掉信号以防止系统调用被打断。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>调度</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>多任务系统常使用非抢占式</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(cooperative)<span
lang=ZH-CN>或者抢占式</span>(preemptive)<span lang=ZH-CN>的调度策略，</span>Linux<span
lang=ZH-CN>支持抢占式的任务调度。和处理器的流水线设计类似，一个好的调度策略需要</span>balance<span lang=ZH-CN>延迟和吞吐量，也就是说它应该能在一定程度上<b>识别</b>和<b>预测</b>出</span>IO<span
lang=ZH-CN>型和计算型的程序，并且分别给予它们更短的响应时间或者吞吐量。此外，调度的时间间隔，或者说每个进程所拥有的时间片的大小也对应着处理器流水线深度的情况，太频繁的调度会导致系统在调度器上浪费太多的资源，所以我们也要控制调度的切换代价。</span>Linux<span
lang=ZH-CN>的调度算法从简单粗暴，变为了</span>O(1)<span lang=ZH-CN>，并在最后使用了</span>RSDL<span
lang=ZH-CN>也就是目前的</span>CFS<span lang=ZH-CN>算法。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CFS<span lang=ZH-CN>调度算法</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>CFS<span lang=ZH-CN>根据</span>NICE<span lang=ZH-CN>给每个进程分配一个处理器使用比，一个实际消耗使用比小于当前进程的进程将抢占当前进程。注意到这种策略相对于传统的，按照</span>NICE<span
lang=ZH-CN>值给高优先级进程分配更长时间片要更为贴近现实，因为</span>NICE<span lang=ZH-CN>值较高（也就是优先级较低）的进程通常是计算密集型的，而如果按照</span>NICE<span
lang=ZH-CN>值，这些进程将获得较短的时间片，反而是优先级高的获得较多的时间片，旱的旱死，涝的涝死。此外，直接用</span>NICE<span
lang=ZH-CN>去标定时间片还会涉及定时器节拍改变导致时间片改变、优化</span>NICE<span lang=ZH-CN>到时间片映射的问题，最终的结论是进程之间的切换频率如果非固定的，效果会更好。</span>CFS<span
lang=ZH-CN>理论上希望一个进程能运行多久取决于处理器使用比，因此指定目标延迟（如</span>20ms<span lang=ZH-CN>）的情况下，每个进程实际能得到的运行时间就和它占到的比例以及总的可运行进程数有关了。当然，我们的分配也是要有最小粒度的，例如最小的时间片长度不能小于</span>1ms<span
lang=ZH-CN>。</span>Linux<span lang=ZH-CN>使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>task_struct</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>sched_entity</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>结构来描述。在具体实现的时候我们并不会望文生义地来做，而是在结构</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>sched_entity</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中使用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>vruntime</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>表示加权的虚拟运行时间，这里的加权指的是默认进程的权重比上当前进程的权重。在</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>update_urr</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中，</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>now -
curr-&gt;exec_start</span><span lang=ZH-CN style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>计算出</span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>delta_exec</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>时间并使用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>__update_curr</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，将未加权的加入到</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>sum_exec_runtime</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，加权的加入到</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>vruntime</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中。根据</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CFS<span lang=ZH-CN>的原则，我们现在应当从</span>CFS<span
lang=ZH-CN>队列</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>cfs_rq</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>（这里</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>rq<span lang=ZH-CN>表示</span>run queue<span
lang=ZH-CN>的意思，在</span>Linux<span lang=ZH-CN>源码中有很多这样的简写）中调用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>__pick_next_entity()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>选取</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>vruntime</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>最小的进程，</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>在这里使用了红黑树来实现。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>的调度器</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>schedule()</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数负责选中最高优先级的调度类中最高优先级的进程，整个过程最后会到</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>idle<b><span
lang=ZH-CN>类</span></b><span lang=ZH-CN>，对应到</span>Linux<span lang=ZH-CN>中的</span>0<span
lang=ZH-CN>号</span>(idle)<span lang=ZH-CN>进程。有多个调度类的原因是由于</span>Linux<span
lang=ZH-CN>中不但存在普通进程（对应于</span>CFS<span lang=ZH-CN>），还存在实时进程。在选中之后，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>schedule()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>会调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>context_switch()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来进行上下文切换。一般来说，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>schedule()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数是由进程调用的，当进程死亡（调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>do_exit</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>）、阻塞等需要放弃当前时间片时就会调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>schedule()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。我们现在考虑最主要的等待某个条件而陷入阻塞的情况，这时候线程会将自己放入等待队列，等待一个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>condition<span
lang=ZH-CN>。这个过程涉及到多个函数，其中</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>DEFINE_WAIT</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>宏用来创建一个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>wait_queue_entry</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>结构，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>add_wait_queue</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>负责将一个进程增加到等待队列，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>prepare_to_wait</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>负责<b>等待队列</b>上的一个进程置入睡眠，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>finish_wait</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>负责将一个进程移出等待队列。这些函数中都使用了内部结构</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>spin_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来维护等待队列。《</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>内核设计与实现》书中举了下面的典型的用例，我们看到整个过程用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>while</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>所维护，期间会发生若干次</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>schedule()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。此外我们发现进程可能会被信号所唤醒，也就是所谓的虚假唤醒</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>伪唤醒，这时候我们同样退出循环，而不是继续循环等待，这也就是为什么我们在后面看到使用条件变量要</span>while-wait<span
lang=ZH-CN>的原因。唤醒操作由</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>wake_up()</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数负责，它会负责调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>try_to_wake_up</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，该函数会唤醒等待队列上的所有进程，注意</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="https://unix.stackexchange.com/questions/268027/how-does-linux-kernel-find-out-which-process-to-wake-up-during-interrupt-handlin"
target="_blank"><span lang=ZH-CN style='color:#555555'>系统中有</span><b><span
lang=ZH-CN style='color:#555555;text-decoration:none;text-underline:none'>很多</span></b><span
lang=ZH-CN style='color:#555555'>个这样的等待队列</span></a><span lang=ZH-CN>，每个等待队列上的所有进程等待同一个事件。一般来说，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>wake_up</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的调用者就是使得条件达成的那一方，这个和条件变量的逻辑是相同的。刚才说到有虚假唤醒，其实还有无效唤醒，也就是进程带着</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>condition<span
lang=ZH-CN>进入睡眠。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<br>
  23<br>
  24<br>
  25<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 3.11.10</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// inotify_read</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  DEFINE_WAIT(wait);<br>
  start = buf;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>group</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> = file-&gt;private_data;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>while</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>) {<br>
  <span style='mso-spacerun:yes'>    </span>prepare_to_wait(&amp;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>group</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>-&gt;notification_waitq, &amp;wait,
  TASK_INTERRUPTIBLE);<br>
  <span style='mso-spacerun:yes'>    </span>mutex_lock(&amp;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>group</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>-&gt;notification_mutex);<br>
  <span style='mso-spacerun:yes'>    </span>kevent = get_one_event(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>group</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, count);<br>
  <span style='mso-spacerun:yes'>    </span>mutex_unlock(&amp;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>group</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>-&gt;notification_mutex);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (kevent) {<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>...</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span>ret = copy_event_to_user(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>group</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, kevent, buf);<br>
  <span style='mso-spacerun:yes'>        </span>fsnotify_put_event(kevent);<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>...</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span>continue;<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>...</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (signal_pending(current))<br>
  <span style='mso-spacerun:yes'>        </span>break;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>...</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>schedule();<br>
  }<br>
  finish_wait(&amp;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>group</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>-&gt;notification_waitq, &amp;wait);<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>...</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>的抢占</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>被动式的调度指的是使用一个<b>调度器</b>决定哪一个任务会在下一刻运行，而不是由进程主动放弃处理器。由调度器决定暂时停止一个任务并让另一个任务开始执行的行为就是抢占式</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(preempt)<span
lang=ZH-CN>调度。抢占式调度分为</span><a
href="http://blog.csdn.net/gatieme/article/details/51872618" target="_blank"><span
lang=ZH-CN style='color:#555555'>用户抢占和内核抢占</span></a><span lang=ZH-CN>两种。先前提到，进程可以通过主动调用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>schedule()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来放弃剩余时间片，但对于时间片耗尽的情况，内核中的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>scheduler_tick()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数（此时关中断，需要在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>2.6<span lang=ZH-CN>版本左右查看）会通过</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>set_tsk_need_resched(p)</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数设置一个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>need_resched</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>标志，这个标志从逻辑上讲应该是全局性的，但为了方便从高速缓存中读取，它自</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>2.2<span lang=ZH-CN>版本后被放到了每一个进程的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>task_struct</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中，自</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>2.6<span lang=ZH-CN>内核后放到</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>thread_info</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中。此外在刚才的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>try_to_wake_up()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>唤醒过程中，如果被唤醒的进程的优先级更高，这个标志也会被设置。从系统调用</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>中断处理程序中返回的情况也包括在内，这也对应着用户抢占。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>用户抢占</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>的用户抢占并不是在用户态下，而是发生在进程即将从内核态返回用户态时，这对应两种情况，从系统调用返回和从中断处理程序返回。如果不开启内核抢占，抢占式调度会给每一个进程的运行分配一个固定或者动态计算的时间片</span>(timeslice)<span
lang=ZH-CN>，进程在内核态的运行会直至结束（主动放弃</span>(yield)/<span lang=ZH-CN>时间片耗尽</span>/<span
lang=ZH-CN>阻塞）。这样的假设方便了内核的编写，特别是在单处理器</span>(UP)<span lang=ZH-CN>下，因为我们考虑到在内核态中不存在对进程上下文的切换，所以内核并不需要考虑对临界资源的竞争访问问题，因此用户程序也可以假设在一次系统调用过程中不需要保护内核临界资源。但需要注意的是中断仍然存在，所以在进入临界区前还需要关中断。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>内核抢占</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>通过内核抢占，系统允许高优先级的进程抢占低优先级的进程的<b>内核态</b>，这将能提高系统的实时性能。内核抢占可能发生在中断处理程序返回到内核空间前、内核代码具有抢占性、内核代码显式调用调度器</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>schedule<span
lang=ZH-CN>、内核中的任务被阻塞时。此外，内核抢占是可以被关闭的，即所谓的关抢占的几种情况：</span><o:p></o:p></span></p>

<ol style='margin-top:0cm' start=1 type=1>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l10 level1 lfo8;tab-stops:
     list 36.0pt;background:white'><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>当内核调度器</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>scheduler<span lang=ZH-CN>正在运行时这个是显然的，我们可以直接在</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>schedule()</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>函数中看到相应实现</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;margin-left:36.0pt;border-collapse:collapse;mso-yfti-tbllook:
 1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 2.6.11</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>//
  /include/linux/preempt.</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>#define
  preempt_disable() \</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>do</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> { \<br>
  <span style='mso-spacerun:yes'>    </span>inc_preempt_count(); \<br>
  <span style='mso-spacerun:yes'>    </span>barrier(); \<br>
  } </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>while</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// /kernel/sched.c</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  need_resched:<br>
  <span style='mso-spacerun:yes'>    </span>preempt_disable();<br>
  <span style='mso-spacerun:yes'>    </span>prev = current;<br>
  <span style='mso-spacerun:yes'>    </span>release_kernel_lock(prev);<br>
  need_resched_nonpreemptible:<br>
  <span style='mso-spacerun:yes'>    </span>rq = this_rq();<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<ol style='margin-top:0cm' start=2 type=1>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l10 level1 lfo8;tab-stops:
     list 36.0pt;background:white'><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>另及，</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>通过内核抢占锁</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>preempt_count</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>来跟踪一个进程的可抢占性，当内核代码具有抢占性时（此时</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>preempt_count</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>为</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>0<span lang=ZH-CN>，且</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>need_resched</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>被设置），则调用</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>preempt_schedule_irq -&gt;
     schedule</span><span lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>进行内核抢占，这过程的发生场景之一就是</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><a
     href="https://unix.stackexchange.com/questions/84107/are-time-interrupts-always-followed-by-a-scheduler-call"
     target="_blank"><span lang=ZH-CN style='color:#555555'>从时间中断返回</span></a><span
     lang=ZH-CN>。我们看到这里关中断实际上是自增了</span></span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>preempt_count</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>使它不等于</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>0<span lang=ZH-CN>。这里的</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>do{}while(0)</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>是出于宏的考虑，防止和其他语法结构（如没有括号的</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>if<span lang=ZH-CN>）混用导致错误。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l10 level1 lfo8;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>中断的</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>bottom half<span lang=ZH-CN>通常有上文所述的三种方式，当内核执行软中断和</span>tasklet<span
     lang=ZH-CN>禁止内核抢占，但注意此时可以被硬中断打断。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l10 level1 lfo8;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>当进程持有自旋锁读写锁这实际上是为了保护临界资源，在有关自旋锁的讨论中会详细说明。事实上当进程持有锁时</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>preempt_count</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>会自增，释放锁时</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>preempt_count</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>会自减，这也就是使用</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>preempt_count</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>的缘由，进程持有锁的数量直接影响到它的可抢占性。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l10 level1 lfo8;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>内核正在处理中断这时候也就是所谓的中断上半部，中断在操作系统中拥有最高的优先级，我们也在前文中论述了中断上下文中不能睡眠的原因，这里不能抢占的原因也是类似的。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l10 level1 lfo8;tab-stops:
     list 36.0pt;background:white'><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>内核操作</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>Per-CPU data structures<span lang=ZH-CN>在</span>SMP<span
     lang=ZH-CN>架构中，不同的</span>CPU<span lang=ZH-CN>仍然会维护一些私有数据，此时抢占可能造成一个进程被调度到另一个</span>CPU<span
     lang=ZH-CN>上去，此时</span>Per-CPU<span lang=ZH-CN>变量就会发生改变。我们可以查看相关代码</span><o:p></o:p></span></li>
</ol>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;margin-left:36.0pt;border-collapse:collapse;mso-yfti-tbllook:
 1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 2.6.39.4</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>//
  /include/linux/smp.h</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  #define get_cpu()<span style='mso-tab-count:2'>               </span>({
  preempt_disable(); smp_processor_id(); })<br>
  #define put_cpu()<span style='mso-tab-count:2'>               </span>preempt_enable()<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<ol style='margin-top:0cm' start=7 type=1>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l10 level1 lfo8;tab-stops:
     list 36.0pt;background:white'><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>而</span><span style='font-size:10.0pt;font-family:
     consolas;mso-fareast-font-family:"Times New Roman";background:#EEEEEE;
     mso-ansi-language:EN-HK'>get_cpu</span><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>就是获得当前的</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>，我们看到首先这一步骤就关了抢占，其中</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>smp_processor_id</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>会调用</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>raw_smp_processor_id</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>这个宏，然后根据不同的</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>来讨论。例如对</span>x86<span
     lang=ZH-CN>来说，这个宏是</span></span><span style='font-size:10.0pt;font-family:
     consolas;mso-fareast-font-family:"Times New Roman";background:#EEEEEE;
     mso-ansi-language:EN-HK'>#define raw_smp_processor_id()
     (percpu_read(cpu_number))</span><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>，然后是</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>#define percpu_read(var)
     percpu_from_op(&quot;mov&quot;, var, &quot;m&quot; (var))</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>。然后我们就可以根据获得的</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>号操作</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>unsigned long
     my_percpu[NR_CPUS]</span><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>这样的每个</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>独有的数据了。注意所有这样的操作是不需要加锁的，因为这是当前</span>CPU<span
     lang=ZH-CN>独有的数据，而内核抢占又被关闭了，所以不存在并发访问问题。《</span>Linux<span lang=ZH-CN>内核设计与实现》中指出了对每个</span>CPU<span
     lang=ZH-CN>维护私有数据的好处：</span><o:p></o:p></span></li>
 <ol start=1 type=1>
  <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
      auto;text-align:justify;text-justify:inter-ideograph;mso-list:l10 level2 lfo8;
      tab-stops:list 72.0pt;background:white'><span lang=ZH-CN
      style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
      "Times New Roman";mso-ansi-language:EN-HK'>减少了竞态条件和锁的使用，这个在上面已经提到</span><span
      style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
      "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
  <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
      auto;text-align:justify;text-justify:inter-ideograph;mso-list:l10 level2 lfo8;
      tab-stops:list 72.0pt;background:white'><span lang=ZH-CN
      style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
      "Times New Roman";mso-ansi-language:EN-HK'>减少了缓存失效的可能根据</span><span
      style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
      "Times New Roman";mso-ansi-language:EN-HK'>MESI<span lang=ZH-CN>，同一数据可能存在于多个</span>CPU<span
      lang=ZH-CN>的缓存中，这样一个</span>CPU<span lang=ZH-CN>造成的修改会导致缓存失效。而一些性能不佳的代码会造成缓存抖动，也就是缓存的不停刷新，这样极大地降低了效率。</span>Linux2.6<span
      lang=ZH-CN>内核提供了</span></span><span style='font-size:10.0pt;font-family:
      consolas;mso-fareast-font-family:"Times New Roman";background:#EEEEEE;
      mso-ansi-language:EN-HK'>per_cpu</span><span lang=ZH-CN style='font-size:
      10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
      mso-ansi-language:EN-HK'>接口能够缓存对齐</span><span style='font-size:10.5pt;
      font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
      mso-ansi-language:EN-HK'>(cache-align)<span lang=ZH-CN>所有数据，这样可以保证不会讲其他处理器的数据带到同一缓存上。</span><o:p></o:p></span></li>
 </ol>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l10 level1 lfo8;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>关中断这是一种特殊情况，关中断后抢占机制自然无法实现了，</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>关中断通常借助于</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>local_irq_disable</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>或者</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>local_irq_save</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>可重入、异步信号安全、线程安全与中断安全</span></b><b><span
style='font-size:15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>可重入函数</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>考虑单线程模型，一般来说执行流程是不会被外部打断的，但考虑可重入</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(reentrant)<span
lang=ZH-CN>性仍然是有必要的。一个典型的场景是</span>signal<span lang=ZH-CN>机制（借助于软中断实现）。例如，我们在函数</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>func</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>涉及读写全局变量</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>errno</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，在这个过程中被</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>signal<span
lang=ZH-CN>中断，而中断处理程序也会访问这个</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>errno</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，那么当继续进行</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>func</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>时就可能读到无效的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>errno</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。很多的系统调用是可重入的，一般来说不可重入函数具有以下几个特征：</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l6 level1 lfo9;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>在未保护的情况下访问全局或者局部静态变量我们希望可重入函数只访问自己栈上的变量。这里注意，严格意义上</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>errno</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>这个全局变量是怎么都避免不了的，但幸好这个变量有着明确的修改时间，所以我们推荐<b>在信号处理函数一开始保存</b></span><b><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>errno</span></b><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>，退出时恢复</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>errno</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>的做法，从而保护了调用前后的现场。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l6 level1 lfo9;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>调用</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>malloc</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>/</span><span style='font-size:10.0pt;font-family:
     consolas;mso-fareast-font-family:"Times New Roman";background:#EEEEEE;
     mso-ansi-language:EN-HK'>free</span><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>函数因此我们在信号处理函数里面应当避免使用</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>malloc</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>，这是因为如果我们在主逻辑里面</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>malloc</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>时被</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>signal<span lang=ZH-CN>了，这时候信号处理对</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>malloc</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>的调用就有可能破坏内核数据结构。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l6 level1 lfo9;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>调用标准</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>IO<span lang=ZH-CN>等对硬件有副作用的函数</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l6 level1 lfo9;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>调用</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>longjmp</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>之类的函数</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>POSIX<span lang=ZH-CN>中还描述了异步信号安全</span>(async-signal-safe)<span
lang=ZH-CN>的概念，并</span><a
href="http://man7.org/linux/man-pages/man7/signal-safety.7.html" target="_blank"><span
lang=ZH-CN style='color:#555555'>列举了一系列信号安全的系统调用</span></a><span lang=ZH-CN>。从本质上讲一个异步信号安全的函数要不是可重入的，要不对信号处理函数来说是原子的，即不能被打断。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>线程安全</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>异步可重入和线程安全是两个不同的概念，线程安全指一个函数能够同时被多个线程安全地调用。一般来说线程安全的函数不一定是可重入的，如</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>malloc</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，而反之则一般是成立的。所以我们可以体会到</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>提供的</span>signal<span
lang=ZH-CN>机制虽然能够实现异步，但是却添加了许多需要考虑的成分。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>中断安全</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='text-align:justify;text-justify:inter-ideograph;
mso-outline-level:1;background:white'><b><span lang=ZH-CN style='font-size:
16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'>内核和运行时向外提供的并发与同步设施</span></b><b><span
style='font-size:16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>多进程与多线程</span></b><b><span
style='font-size:15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>进程是</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>UNIX<span lang=ZH-CN>设计模型中的一个重要部分，</span>UNIX<span
lang=ZH-CN>推崇以多进程</span>+IPC<span lang=ZH-CN>的方式组成应用系统，充分贯彻了</span>KISS<span
lang=ZH-CN>的方针。在</span>UNIX<span lang=ZH-CN>产生的年代，这种方式无疑是很健壮的。从定义上看，进程是资源分配的最小单位，那么线程是程序执行的最小单位。线程通常和同一程序下的其他线程共享一套地址空间，其中包含应用程序拥有的程序代码与资源，每个线程自己维护一套运行上下文。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>同步与异步</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在进程</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>IPC<span lang=ZH-CN>中同步和异步是两种编程模型，描述了</span>IPC<span
lang=ZH-CN>中<b>被调用者</b>的行为。在同步模型中一个调用只有在等到结果（也就是被调用者完成计算）时才返回，被调用者并不会进行通知。而异步模型中调用会立即返回，而由<b>被调用者</b>选择在结果达到后通过回调函数或者信号等机制进行通知。</span>UNP<span
lang=ZH-CN>书中还强调异步过程中用户不需要手动将数据从内核复制到用户（即不需要在被通知后调用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>read</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等函数），但我觉得这是异步过程所必须具备的特性，而不是其根本的区分点。需要和同步异步进行区分的是阻塞和非阻塞的概念，这两个描述了调用结果未到达时<b>调用者</b>的状态。阻塞调用会直接睡眠线程，而非阻塞调用不会阻塞线程。在<b>非阻塞同步</b>调用中，当调用者还没有收到来自调用者的返回时，调用者可以原地进行轮询等待，此时虽然逻辑无法持续，但线程并没有进入睡眠。此外，非阻塞模型还可以是异步的，此时线程可以继续执行下面无关返回值的逻辑，消息到达时线程收到一个异步信号或者回调，或者采用类似协程的方法。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>IO<span lang=ZH-CN>多路复用是一种特殊的同步模型，并且它们在消息到来前必须在一个循环中轮询，而不是立即返回并跳出循环。不过</span>IO<span
lang=ZH-CN>多路复用并不属于同步阻塞模型，因为当一个</span>fd<span lang=ZH-CN>在等待结果时，线程可能在处理来自其它</span>fd<span
lang=ZH-CN>的</span>IO<span lang=ZH-CN>，因此并不一定会进入睡眠。</span>IO<span lang=ZH-CN>多路复用也不属于同步非阻塞模型，因为当没有任何一个</span>fd<span
lang=ZH-CN>产生</span>IO<span lang=ZH-CN>事件时，线程还是会被阻塞的。此外</span>UNP<span
lang=ZH-CN>还指出</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>poll</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>函数中仍然需要手动将数据从内核复制回来。以</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>UNIX<span lang=ZH-CN>套接口为例，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>SS_NBIO</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>SS_ASYNC</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>标志分别表示非阻塞和异步的选项，其中非阻塞套接口在请求资源不满足时会返回</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>EWOULDBLOCK</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，而异步套接口则会通过</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>SIGIO</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>信号来通知进程。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>协程</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>协程</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(Coroutine)<span lang=ZH-CN>是具有多个入口点的函数，协程内部可通过</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>yield</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>进行中断，此时处理器可能被调度到执行其他的函数。虽然线程也可以被睡眠，睡眠本身涉及用户态与内核态的上下文切换，开销较大。对于套接字等</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>IO<span lang=ZH-CN>密集型的应用，协程在提高</span>CPU<span
lang=ZH-CN>使用率上比线程轻很多。协程通常分为</span>stackful<span lang=ZH-CN>和</span>stackless<span
lang=ZH-CN>两种。</span>stackless<span lang=ZH-CN>实现不保存调用栈和寄存器等上下文，因此效率比较高。</span>stackless<span
lang=ZH-CN>的协程实现例如</span>C++<span lang=ZH-CN>中的</span>setjmp<span lang=ZH-CN>、</span>Python<span
lang=ZH-CN>中的生成器等。</span>stackful<span lang=ZH-CN>即栈式构造，这时候协程拥有自己的堆栈等上下文。</span>stackful<span
lang=ZH-CN>的协程类似于</span>C++<span lang=ZH-CN>中的</span>ucontext<span lang=ZH-CN>、</span>libco<span
lang=ZH-CN>等。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>下协程的实现方式</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>基于</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>ucontext<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>ucontext<span lang=ZH-CN>是</span>POSIX<span
lang=ZH-CN>上的一套用于保存上下文的库，这里上下文包括寄存器（通用和浮点）、信号等。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>黑科技</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>1<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>Protothreads<span lang=ZH-CN>基于</span>C<span
lang=ZH-CN>的是围绕</span>switch<span lang=ZH-CN>展开的一系列黑科技实现的协程。我们首先看它定义的一些原语，原来这就是一个简易的，关于行号的状态机。我在</span><a
href="https://paste.ubuntu.com/p/MDjGpX3999/" target="_blank"><span lang=ZH-CN
style='color:#555555'>这里模仿</span><span style='color:#555555'>Protothreads<span
lang=ZH-CN>实现了一个简易版的协程</span></span></a><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>#define PT_BEGIN() </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>bool</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> ptYielded = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>true</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>; (</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>) ptYielded; </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>switch</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (_ptLine) { </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>case</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#718C00;mso-ansi-language:EN-HK'>0</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>:<br>
  #define PT_YIELD() \<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>do</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> { ptYielded = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>false</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>; _ptLine = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>__LINE__</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>; </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>case</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>__LINE__</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>: \<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (!ptYielded) </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>return</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>true</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>; } </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>while</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  #define PT_END() </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>default</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>: ; } Stop(); </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>return</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>false</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>为了理解这段代码，我们回想</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>实现协程需要实现的一个核心问题，并不是调度，而是实现从多个入口点进入。这就意味着我们需要在退出协程函数时记录下已经到了哪里，然后在下一次进入函数时回到这个地方。对于第一个需求，我们可以借助于</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>__LINE__</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>这个宏表示执行到的行号，每次将这个行号赋值给一个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>int<span lang=ZH-CN>。对于第二个需求，我们可以借助于</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>switch</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>实现跳转。这里用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>switch</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>而不用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>goto</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的原因是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>switch</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>能够根据</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>int<span lang=ZH-CN>变量来实现</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>goto</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的功能，而</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>goto</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>需要依赖静态的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>label<span lang=ZH-CN>。这种巧妙的机制不禁让我想起了称为</span><a
href="https://en.wikipedia.org/wiki/Duff%27s_device" target="_blank"><span
style='color:#555555'>Duff<span lang=ZH-CN>’</span>s device</span></a><span
lang=ZH-CN>的优化方案。不过这种机制有一个语法缺陷就是在里面嵌套的</span>switch<span lang=ZH-CN>语句会产生干扰。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>基于</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>setjmp<span lang=ZH-CN>和</span>longjmp<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>setjmp<span lang=ZH-CN>和</span>longjmp<span
lang=ZH-CN>类似跨栈帧的带上下文的</span>goto<span lang=ZH-CN>。</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>int setjmp(jmp_buf
env)</span><span lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>负责将函数当前的上下文保存在</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>jmp_buf</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;text-justify:inter-ideograph;
mso-outline-level:1;background:white'><b><span lang=ZH-CN style='font-size:
16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'>约束线程间并发行为</span></b><b><span
style='font-size:16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>线程间实现互斥与同步的任务常具有下面两种形式：</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l11 level1 lfo10;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>多个线程同时访问一个共享资源，需要维护该共享资源的完整性。这就是</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>Race condition<span lang=ZH-CN>问题，将在本节讨论。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l11 level1 lfo10;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>一个线程向另一个线程通告自己的结果</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>/<span lang=ZH-CN>等待另一个线程的结果，这将在章节数据共享中讨论。</span><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>总的来说，为了实现同步，等待资源的一方可以处于用户态（忙等）或者内核态（睡眠），而获得资源的一方可以选择锁进行同步，或者使用原子操作保证自己访问不被打断。这分别下面的基于锁和原子操作的工具。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>、</span>Windows<span
lang=ZH-CN>和</span>C++11<span lang=ZH-CN>的标准库中都对这些工具提供了不同程度的支持，具体可参考</span><a
href="https://www.ibm.com/developerworks/cn/linux/l-cn-mthreadps/index.html"
target="_blank"><span lang=ZH-CN style='color:#555555'>文档</span></a><span
lang=ZH-CN>。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Race condition<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>竞态条件常出现在逻辑电路这样的硬件环境中，对于软件环境而言，当两个线程竞争同一资源时，如果对资源的访问顺序敏感，就称存在竞态条件</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(race condition)<span
lang=ZH-CN>，导致竞态条件发生的代码区称作临界区。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>volatile<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在有关</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>缓存一致性的章节中，我们讨论的</span>volatile<span
lang=ZH-CN>、寄存器、主存和</span>CPU<span lang=ZH-CN>缓存之间的关系。这里我们讨论语言（</span>C/C++<span
lang=ZH-CN>）层面的</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>volatile</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>的有关特性。</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><br>
C++<span lang=ZH-CN>中的</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>volatile</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>并不以任何形式保证线程安全，它仅用来告知编译器期修饰的变量是易变的，要避免对其进行优化，这里所谓的优化常常是将变量缓存到寄存器中而不是每次都从内存读取。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>volatile</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>并不蕴含禁止编译器或者处理器进行重排或乱序，我们需要通过编译器屏障或者内存屏障来实现这一点。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>volatile</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>关键字有时是有用的，例如可以在自旋锁中防止多次循环中始终读取寄存器中的值。但滥用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>volatile</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>不仅不会提高程序的安全性，而且会导致程序变慢。对于以为可以加“</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>volatile<span
lang=ZH-CN>”就可以解决的问题，一般可以使用</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来避免使用内核锁的开销。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>内核锁</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>内核锁一般基于内核对象互斥量</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>信号量，它们通常是阻塞锁，会导致线程进入睡眠。锁的存在通常限制了并发范围，变并行访问为串行访问。在使用锁维护临界资源时应当争取让序列化访问最小化，真实并发最大化。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>互斥量</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>中一般不直接使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::mutex</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，而使用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>lock_guard</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>unique_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>lock_guard</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>unique_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>利用了</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>RAII<span lang=ZH-CN>来自动管理加锁解锁操作，它们能够应用到包括互斥量的所有</span>Lockable<span
lang=ZH-CN>的对象上。</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>unique_lock</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>相比于</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>lock_guard</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>更灵活，用户能够手动地加</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>解锁，例如在条件变量中就需要</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>unique_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>以便解锁，而在取得对临界资源后进行处理时也可以暂时解锁。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>unique_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>还是可移动的，以下面的代码为例，这里</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>1<span lang=ZH-CN>处是一个直接返回</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>lk</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，编译器可能进行</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>NRVO<span lang=ZH-CN>，当然即使不这么做，</span>2<span
lang=ZH-CN>作为一个直接初始化操作，也可以接受</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>get_lock</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>返回的将亡值，从而完成移动构造</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::unique_lock&lt;std::mutex&gt;</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。因此这里锁的控制权从</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>get_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>转移到了</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>process_data</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::unique_lock&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; get_lock()<br>
  {<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>extern</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex some_mutex;<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::unique_lock&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lk(some_mutex);<br>
  <span style='mso-spacerun:yes'>  </span>prepare_data();<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> lk;<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 1</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>process_data</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::unique_lock&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lk(get_lock());<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 2</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span>do_something();<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>一般会将</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>mutex<span lang=ZH-CN>和临界资源一起放到一个类中进行管理，此时宜保证该临界资源是非</span>public<span
lang=ZH-CN>的，并且不会以引用或者指针的形式传出。这些场景例如成员函数直接返回指针或者引用，友元函数，或者一个接受函数指针</span>P<span
lang=ZH-CN>作为参数的函数，且</span>P<span lang=ZH-CN>接受了临界成员的指针或引用，并将其泄露到类外（</span>C++
Concurrency in Action<span lang=ZH-CN>），因此我们还要避免在持有锁时调用用户提供的代码。虽然我们的愿景是希望最大化真实并发，因此要追求较小粒度的锁</span>(small
granularity)<span lang=ZH-CN>，一个较小的粒度表现在锁所保护的临界数据较少，并且持有锁的时间较短，但粒度不可能无限小。例如考虑删除双向链表中的一个节点，需要修改三个节点的数据，如果对这三个修改单独加锁，其实等于没有加锁。因此一个直截了当的解决方案是在删除过程中锁住整个链表。如果是仍然希望为每个节点维护一把锁，那么对于删除操作必须获得被删除节点和其相邻的共三把锁，当重新连接节点时，必须在获得当前节点锁的前提下尝试获取下一节点的锁（但一旦持有了下一节点的锁就可以释放当前节点的锁了），以防后继节点产生变化。与此同时，我们还要考虑在遍历的时候需要对要访问的节点上锁，因此遍历时同样需要按照和删除相同的上锁步骤。下面我们考虑一个线程安全的栈，其中实现了</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>empty()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>top()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>size()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>push()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pop()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等常见方法。在多线程下，下面的代码中</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pop()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>可能使得</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>top()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的结果无效，这是因为在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>1<span lang=ZH-CN>和</span>2<span
lang=ZH-CN>两个方法<b>间</b>可能有另一个线程执行了</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>pop()</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。容易看出无论这些方法内部怎么加锁都无法避免这种情况，因为这里的竞态发生在这些方法<b>之间</b>，</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++ Concurrency in
Action<span lang=ZH-CN>特别指出这属于接口设计的问题。在后面内存模型的部分，我们能看到<b>类似的问题</b>，原子操作虽然避免了竞态，但原子操作之间可能存在的乱序必须要被考虑。书中还指出了另一个更严重的</span>2<span
lang=ZH-CN>和</span>3<span lang=ZH-CN>之间竞争的错误，假设有两个线程并行执行该段代码，我们期望的顺序是</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>top[1] -&gt; pop[1]
-&gt; top[2] -&gt; pop[2]</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>，中括号表示执行该方法的线程。然而实际执行顺序可能是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>top[1] -&gt; top[2]
-&gt; pop[1] -&gt; pop[2]</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>。这就导致了从栈顶开始的两个元素有一个被处理了两次，另一个完全没有被处理。一个简单的解决方案是将这两个调用<b>合并成一个带返回值的</b></span><b><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>pop</span></b><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，使用一个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>mutex<span lang=ZH-CN>来管理，但</span>Tom
Cargill<span lang=ZH-CN>指出这处理方式是有问题的。这涉及到为什么标准库在设计时选择将</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>top()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pop()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>两个方法，原因是可能发生在成功将元素</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>pop<span lang=ZH-CN>后而拷贝函数失败，这个元素就被丢失，所以先取</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>top()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>再</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pop()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>保证了</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>top()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>失败情况下可以选择不执行</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pop()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>stack</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; s;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>if</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (! s.empty()){<span
  style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// 1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>int</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>const</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> value = s.top();<span
  style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// 2</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span>s.pop();<span
  style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// 3</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span>do_something(value);<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>死锁</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>使用互斥量的另一个问题是死锁，这时候锁机制避免了竞态，却可能产生线程对锁的竞争，即线程间互相等待对方的锁。死锁的产生满足四个条件：互斥、占有且请求、不可抢占和循环等待。其中等待且请求条件很关键，当完成一个操作需要获得两个及以上的锁时，死锁往往就会发生。为了解决死锁就要想办法破坏它的四个条件之一。从占有且求的角度来解决，我们可以借助于</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Dijkstra<span
lang=ZH-CN>的银行家算法。在</span>C++11<span lang=ZH-CN>中，我们可以使用标准库函数</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来同时上锁，不过现实情境下我们往往难以在申请锁时就确定自己需要哪些锁。从破坏循环等待条件的解读来设计的一个解决方案是永远按照一个顺序来获得锁，以哲学家就餐问题为例，我们将筷子进行编号，并约定哲学家们总是先尝试获得编号较低的筷子，用完后总是先释放编号较高的筷子，这样就能避免死锁问题。注意到约定哲学家们总是先拿起左手边的筷子，再拿起右手边的筷子恰恰会导致死锁问题，因为在这里我们并不是<b>对每一个哲学家</b>的操作指定一个<b>相对的规则</b>，而是为<b>所有的资源（锁）</b>的获取直接指定一个<b>绝对的顺序</b>。于是我们发现有时候去确定一个顺序并不是很容易。对于</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>swap</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数来说，我们可以按照参数的顺序来加锁，例如先获得第一个参数的锁，再获得第二个参数的锁。可惜这个是相对的，例如考虑如下面代码所示的两个规则，容易发现这两个线程并行执行时死锁就会发生了。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// thread 1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  swap(a, b);<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// thread 2</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  swap(b, a);<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>为了解决这个问题，一个方法是对每个对象求</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Hash<span lang=ZH-CN>，从而进行排序，另一种是借助于</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数。这个函数的作用是将多个互斥量同时上锁（失败时则抛出异常并释放已经获得的锁），下面代码展示了一个线程安全的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>swap</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<br>
  23<br>
  24<br>
  25<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>class</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>some_big_object</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>swap</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>(some_big_object&amp; lhs,some_big_object&amp; rhs)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>class</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>X</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>private</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>:<br>
  <span style='mso-spacerun:yes'>  </span>some_big_object some_detail;<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex m;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>public</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>:<br>
  <span style='mso-spacerun:yes'>  </span>X(some_big_object </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>const</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>&amp; sd):some_detail(sd){}<br>
  <br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>friend</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>swap</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>(X&amp; lhs, X&amp; rhs)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4271AE;mso-ansi-language:EN-HK'><span
  style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(&amp;lhs==&amp;rhs)<br>
  <span style='mso-spacerun:yes'>      </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::lock(lhs.m, rhs.m); </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// std::adopt_lock</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>告知这个</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>lock_guard</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>已获得锁</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::lock_guard&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lock_a(lhs.m, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::adopt_lock); </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 2</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::lock_guard&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lock_b(rhs.m, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::adopt_lock); </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 3</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>swap(lhs.some_detail,
  rhs.some_detail);<br>
  <span style='mso-spacerun:yes'>  </span>}<br>
  };<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// </span><span
  lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>注意</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>1/2/3</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>也可以换为以下代码</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::unique_lock&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lock_a(lhs.m, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::defer_lock);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::unique_lock&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lock_b(rhs.m, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::defer_lock); </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// unique_lock </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>不对互斥量上锁</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::lock(lock_a, lock_b); </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>互斥量在这里上锁</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>std::lock</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的实现借助了</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>try_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>即</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Try_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<br>
  23<br>
  24<br>
  25<br>
  26<br>
  27<br>
  28<br>
  29<br>
  30<br>
  31<br>
  32<br>
  33<br>
  34<br>
  35<br>
  36<br>
  37<br>
  38<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>template</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>class</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lock0</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>class</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lock1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>class</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>... _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>LockN</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>inline</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>lock</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(_</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lock0</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp; _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lk0</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lock1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp; _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lk1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>LockN</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp;... _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>LkN</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  {<span style='mso-spacerun:yes'>   </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// lock N mutexes</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>int</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _Res = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>0</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (_Res != </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>-1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  <span style='mso-spacerun:yes'>        </span>_Res = _Try_lock(_Lk0, _Lk1,
  _LkN...);<br>
  }<br>
  <span style='mso-spacerun:yes'>    </span><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>template</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>&lt;</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>class</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>Lock0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>&gt; </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>inline</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>int</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>Try_lock</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(_</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lock0</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp; _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lk0</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  {<span style='mso-spacerun:yes'>   </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// try to lock one mutex</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (!_Lk0.try_lock())<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>else</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>-1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>);<br>
  }<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>template</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>&lt;</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>class</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>Lock0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>, </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>class</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lock1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>class</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>... _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>LockN</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>inline</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>int</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>Try_lock</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(_</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lock0</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp; _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lk0</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lock1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp; _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Lk1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>LockN</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp;... _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>LkN</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  { </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// try to lock n-1
  mutexes</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>int</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _Res;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>如果第一个锁</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>_Lk0</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>直接失败，则返回失败</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (!_Lk0.try_lock())<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>try</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>{<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>否则递归地尝试获取第二个锁</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>_Lk1</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>，如果失败则解开第一个锁并修改</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>_Res</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>为失败</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> ((_Res = </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>:: try_lock(_Lk1, _LkN...)) != </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>-1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  <span style='mso-spacerun:yes'>            </span>{<span
  style='mso-spacerun:yes'>   </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// tail lock failed</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>            </span>_Lk0.unlock();<br>
  <span style='mso-spacerun:yes'>            </span>++_Res;<br>
  <span style='mso-spacerun:yes'>            </span>}<br>
  <span style='mso-spacerun:yes'>    </span>}</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>catch</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>(...){<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>如果出现异常同样解开第一个锁并返回失败</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span>_Lk0.unlock();<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>throw</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (_Res);<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>值得注意的是引起死锁的并不一定是锁，而可以扩展到造成互相等待的其他情况，例如一组线程互相</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>join<span lang=ZH-CN>等待对方，相互阻塞，这导致整个程序无法往下运行，或者线程在持有锁时同时等待其他线程。此外即使在一个线程中，也会出现如同死锁的现象，例如下面的代码中，我们希望</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>subroutine1</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>routine</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>都在</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>mut</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的保护下，但这样一来程序就会死锁。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>subroutine1</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span>mut.lock();<br>
  <span style='mso-spacerun:yes'>    </span>mut.unlock();<br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>routine</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span>mut.lock();<br>
  <span style='mso-spacerun:yes'>    </span>subroutine1();<br>
  <span style='mso-spacerun:yes'>    </span>...<br>
  <span style='mso-spacerun:yes'>    </span>subroutine2();<br>
  <span style='mso-spacerun:yes'>    </span>mut.unlock();<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>另一种解决死锁的办法从锁的角度，为锁提供层级。一个已持有低层级锁的线程是不能试图获得高层级的锁的，试图违反这一约定的行为将导致抛出异常或终止程序。注意到不能同时持有相同层级上的锁，所以这些互斥量往往形成一条链。一个层次互斥量</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>hierarchical_mutex</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的实现可以对每个线程使用一个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>thread_local</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>全局变量进行维护当前线程所持有的锁的层级，默认取</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>UINT_MAX</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这样线程可以获得任何层级的互斥量。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><br>
<span lang=ZH-CN>但即使可以避免死锁也要注意锁的粒度（保护数据规模与持有时间）对性能的影响，一个总的原则是一个锁应当被持有尽可能少的时间，并且在持有过程中只应该去完成必要的工作。特别地，持有一个锁的同时等待另一个锁，即使不造成死锁，也要考虑其性能问题。以判定两个</span>int<span
lang=ZH-CN>是否相等为例，在先前我们看到了一个</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>swap</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数的实现方案，同时对两个互斥量进行加锁。但这里考虑到实际上</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>int<span lang=ZH-CN>非常小，所以比较好的是分别对两个</span>int<span
lang=ZH-CN>加锁，复制副本，并比较两个副本，从而避免同时持有两个锁。注意和前面</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>top()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pop()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>所遇到的问题一样，在对</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>intA<span lang=ZH-CN>和</span>intB<span
lang=ZH-CN>的读操作</span>(LOAD)<span lang=ZH-CN>间可能发生另一个线程对</span>intA<span
lang=ZH-CN>的写操作，导致先前读取到的是旧值。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>自旋锁</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>自旋锁是一种忙等锁</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(busy waiting)<span lang=ZH-CN>，它适用于短时间锁定某个资源，这样可以避免内核锁所需要的线程睡眠（两次线程上下文切换）等一系列的开销，但持有过长的自旋锁会导致浪费大量</span>CPU<span
lang=ZH-CN>资源。特别是在单核</span>CPU<span lang=ZH-CN>上，自旋锁的使用需要审慎考虑，因为在单核</span>CPU<span
lang=ZH-CN>上同一时间只能运行一个线程，这时候如果等待锁的线程先运行，那么它势必进入空等直到时间片用完，因为获得锁的线程势必不能运行以释放锁。因此在单核</span>CPU<span
lang=ZH-CN>上使用内核锁进入睡眠是一个好的选择。自旋锁常被用在对称多处理器</span>(SMP)<span lang=ZH-CN>系统中，在多</span>CPU<span
lang=ZH-CN>的情况下保护临界区。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>自旋锁与中断处理</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>处理中断时不能使用互斥量、信号量等让线程进入睡眠的锁，因此自旋锁常用于内核中有关中断处理的部分。内核锁必须在进程上下文（对应于中断上下文）中才能使用，这里的关闭中断的目的是为了关闭调度，因为关闭了时钟中断（时钟中断是可以被关闭的），调度器就无法运转了。这样就产生了睡死的现象。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>持有自旋锁时不能进入睡眠</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>自旋锁适用于不能睡眠的场景，但双向地来说，持有自旋锁时也不能进入睡眠，否则会引起死锁。为了理解原因，首先要了解为什么自旋锁常伴随<b>关中断</b>和<b>关抢占</b>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>中提供了各个品种的自旋锁操作函数。其中</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>spin_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>系列的关闭了抢占而不关中断，而</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>spin_lock_irqsave</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>spin_lock_irq</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>spin_lock_bh</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>会一道把中断也关了。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="http://blog.csdn.net/liduxun/article/details/47833143" target="_blank"><span
lang=ZH-CN style='color:#555555'>关抢占的原因是</span></a><span lang=ZH-CN>如果一个低优先级的线程</span>A<span
lang=ZH-CN>获得自旋锁而紧接着被一个高优先级的进程</span>B<span lang=ZH-CN>抢占，那么会造成这两个线程死锁，直到时间片用尽，也就是所谓的优先级反转（优先级倒置）现象，会严重影响性能。关中断的原因是如果一个进程</span>A<span
lang=ZH-CN>获得自旋锁然后被一个中断打断，如果这个中断处理器也试图获得同一个自旋锁，那么就会造成在中断内部的死锁（自旋锁不能嵌套上锁，否则会造成自死锁现象），并且中断处理无法被抢占（但可以被其他中断打断）。可以参考</span><a
href="http://blog.guorongfei.com/2014/09/06/linux-interrupt-preemptive-lock/"
target="_blank"><span lang=ZH-CN style='color:#555555'>文章</span></a><span
lang=ZH-CN>和</span><a href="https://www.zhihu.com/question/28821201"
target="_blank"><span lang=ZH-CN style='color:#555555'>知乎</span></a><span
lang=ZH-CN>。既然使用自旋锁应当关闭中断或者调度，那么原因就很明显了，如果进程</span>A<span lang=ZH-CN>获得了自旋锁并且阻塞在内核态，此时内核调度了进程</span>B<span
lang=ZH-CN>（阻塞可导致调度），而</span>B<span lang=ZH-CN>也试图获得自旋锁，那么</span>B<span
lang=ZH-CN>将永远自旋，</span>A<span lang=ZH-CN>将永远睡眠，这类似于开中断时在中断内的死锁情况，不过在这种情况下仍有可能</span>B<span
lang=ZH-CN>时间片用完从而再次重新调度。此外</span><a
href="http://blog.csdn.net/samantha_sun/article/details/6365770" target="_blank"><span
lang=ZH-CN style='color:#555555'>另一种解释</span></a><span lang=ZH-CN>认为对于不关中断的自旋锁在睡眠后可能会被重新调度，从而造成自死锁的现象。这种思想同样值得用在处理异常、信号等会破坏程序执行顺序的地方。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>临界区</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>相对于互锁访问函数这种“有限的”原子操作，临界区允许对<b>一段代码</b>进行“原子操作”，临界区相对于互斥量比较轻便，这是由于互斥量能够跨进程，并且支持等待多个内核对象。同时线程在进入一个被占用的临界区时会首先尝试自旋锁，在自旋锁循环一定次数失败后再让线程进入睡眠。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>临界资源的初始化</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>我们考虑临界资源的初始化问题，一个重要的情景就是实现单例模式。在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++11<span lang=ZH-CN>后，可以方便地使用局部静态变量（</span>Meyers
Singleton<span lang=ZH-CN>满足初始化和定义完全在一个线程中发生，并且发生在所有其他线程访问之前）或者</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::call_once</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>（在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++11<span lang=ZH-CN>前我们只能使用</span>Linux<span
lang=ZH-CN>系统中的替代品</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>pthread_once</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>）实现线程安全的单例模式。不过首先先看看一个使用锁的朴素的，也是开销巨大的方案。查看下面的代码，我们可以发现这里用一把大锁保证了不会有两个线程竞争创建</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>访问</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p_singleton</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的实例。但同时需要意识到当实例被唯一地创建好后，这个函数就不需要要锁来保护了，因为在这种情况下它简单到可以作为原子操作，然而事与愿违的是每次调用这个函数都需要获得锁。因此我们需要一种<b>仅保护临界资源初始化过程的机制</b>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>Singleton * p_singleton = </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>nullptr</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4271AE;mso-ansi-language:EN-HK'>Singleton * </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#3E999F;mso-ansi-language:EN-HK'>get_singleton</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::lock_guard&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lock(mtx);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (p_singleton == </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>nullptr</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>) { <br>
  <span style='mso-spacerun:yes'>        </span>p_singleton = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>new</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> Singleton();<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> p_singleton;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>双重检查锁定模式</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(Double-checked locking pattern, DCLP)<span
lang=ZH-CN>指的是在加锁前先进行一次验证是否可以加锁。下面使用双重检查锁定模式来减少加锁的开销，具体的做法是先检查一遍</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p_singleton</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是否为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>nullptr</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>Singleton * p_singleton = </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>nullptr</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4271AE;mso-ansi-language:EN-HK'>Singleton * </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#3E999F;mso-ansi-language:EN-HK'>get_singleton</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (p_singleton == </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>nullptr</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>) { </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// a</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::lock_guard&lt;</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lock(mtx);<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (p_singleton == </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>nullptr</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>) { </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// b</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>            </span>p_singleton = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>new</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> Singleton();<br>
  <span style='mso-spacerun:yes'>        </span>}<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> p_singleton;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>但其实这种加锁方式也是有</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="http://blog.jobbole.com/86392/" target="_blank"><span lang=ZH-CN
style='color:#555555'>理论上的风险</span></a><span lang=ZH-CN>的，例如我们的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p_singleton</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>不是原子的，甚至都不是</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>volatile<span
lang=ZH-CN>的，基于我们与编译器的约定，编译器完全可以认为</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>p_singleton</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的值不会发生变化，因此直接将两层</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>if</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>削掉一层。但是即使我们将</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p_singleton</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>套上</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、加上</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>volatile</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这个代码仍然是错误的。原因在于</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p_singleton = new
Singleton()</span><span lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>这条语句不是原子的。我们可以把该语句分为三步</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l14 level1 lfo11;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>分配内存</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l14 level1 lfo11;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>构造对象</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l14 level1 lfo11;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>指针指向对象</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><b><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>编译器</span></b><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>在理论上（但实践中编译器没有理由去进行这样的重排）会在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>2<span lang=ZH-CN>构造对象前执行</span>1<span
lang=ZH-CN>内存分配和</span>3<span lang=ZH-CN>指针指向操作。假设线程在</span>1/3<span
lang=ZH-CN>步骤完毕之后被挂起而来不及执行</span>2<span lang=ZH-CN>步骤，而另一个线程开始访问</span>a<span
lang=ZH-CN>处的代码，注意到此时</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>p_singleton</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>已经不是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>nullptr</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>了，于是函数会返回一个未初始化的内存。继续思考我们发现，这里的问题是由于第一个线程此时已经在初始化</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p_singleton</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这第二个线程就<b>不应该有机会执行到</b></span><b><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>a<span lang=ZH-CN>处的代码</span></span></b><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，试想即使第二个线程知道初始化再被另一个线程执行，那它也做不了任何事情，因为代码中写了要么初始化并返回指针，要么直接返回指针。选择前者会破坏第一个线程的初始化过程，选择后一个会造成上面说的结果。因此在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>a<span lang=ZH-CN>处对</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p_singleton</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>进行保护是非常有必要的。在稍后的章节中，我们将对双重检查锁定模式进行进一步的讨论。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>因此实际上使用上面提到的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::call_once</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是一个更好的解决方案。在下面的代码中，只会输出一行</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>Called once</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::once_flag flag;<span style='mso-spacerun:yes'>  </span><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>do_once</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'><span style='mso-spacerun:yes'>  </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  {<span style='mso-spacerun:yes'>  </span><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::call_once(flag, [](){ </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>cout</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> &lt;&lt; </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>&quot;Called once&quot;</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> &lt;&lt; </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>endl</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>; });<span style='mso-spacerun:yes'>  </span><br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>int</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>main</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>()</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'><span style='mso-spacerun:yes'>  </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  {<span style='mso-spacerun:yes'>  </span><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'>thread </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>t1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>(do_once)</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'>thread </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>t2</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>(do_once)</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>;<br>
  <span style='mso-spacerun:yes'>    </span><br>
  <span style='mso-spacerun:yes'>    </span>t1.join();<br>
  <span style='mso-spacerun:yes'>    </span>t2.join();<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>这里的</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>std::once_flag</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>不能被拷贝和移动，其实相当于一个锁，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>call_once</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>实现如下</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<br>
  23<br>
  24<br>
  25<br>
  26<br>
  27<br>
  28<br>
  29<br>
  30<br>
  31<br>
  32<br>
  33<br>
  34<br>
  35<br>
  36<br>
  37<br>
  38<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>template</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>class</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Fn</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>,<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>class</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>... _</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>Args</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>inline</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>call_once</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)(</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>once_flag</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp; _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Flag</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Fn</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp;&amp; _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Fx</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Args</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&amp;&amp;... _</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#3E999F;mso-ansi-language:
  EN-HK'>Ax</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  <span style='mso-spacerun:yes'>    </span>{<span style='mso-spacerun:yes'>  
  </span></span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// call _Fx(_Ax...)
  once</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>定义一个</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>_Tuple</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>类型</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>typedef</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> tuple&lt;_Fn&amp;&amp;, _Args&amp;&amp;..., _XSTD
  exception_ptr&amp;&gt; _Tuple;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// _Seq</span><span lang=ZH-CN style='font-size:
  10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>的值索引上面的</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>_Tuple</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>typedef</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> make_integer_sequence&lt;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>size_t</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> + </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>sizeof</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>...(_Args)&gt; _Seq;<br>
  <br>
  <span style='mso-spacerun:yes'>    </span>_XSTD exception_ptr _Exc;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>将回调函数参数打包到</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>_Tuple</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>类型里面，最后一个是</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>exception_ptr</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>_Tuple _Tup(_STD
  forward&lt;_Fn&gt;(_Fx), _STD forward&lt;_Args&gt;(_Ax)..., _Exc);<br>
  <span style='mso-spacerun:yes'>    </span><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>使用</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>_Tup</span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>里面的上下文特化</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>_Callback_once</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>函数模板</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>_Lambda_fp_t _Fp =
  &amp;_Callback_once&lt;_Tuple, _Seq, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> + </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>sizeof</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>...(_Args)&gt;;<br>
  <span style='mso-spacerun:yes'>    </span><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>在</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>xonce.cpp</span><span lang=ZH-CN style='font-size:
  10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>中实际调用了</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>__crtInitOnceExecuteOnce</span><span
  lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>的</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>WINAPI</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (_Execute_once(_Flag, _Fp, _STD addressof(_Tup)) != </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>)<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (_Exc)<br>
  <span style='mso-spacerun:yes'>        </span>_</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'>XSTD </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#3E999F;mso-ansi-language:EN-HK'>rethrow_exception</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>(_Exc)</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <br>
  <span style='mso-spacerun:yes'>    </span>_XGetLastError();<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <span style='mso-spacerun:yes'>    </span><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// xonce.cpp</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  _STD_BEGIN<br>
  _CRTIMP2_PURE </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> __CLRCALL_PURE_OR_CDECL _Execute_once(<br>
  <span style='mso-spacerun:yes'>    </span>once_flag&amp; _Flag, _Lambda_fp_t
  _Lambda_fp, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> *_Pv) _NOEXCEPT<br>
  <span style='mso-spacerun:yes'>    </span>{<span style='mso-spacerun:yes'>  
  </span></span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// wrap Win32
  InitOnceExecuteOnce()</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>static_assert</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>sizeof</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(_Flag._Opaque) == </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>sizeof</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(INIT_ONCE), </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>&quot;invalid size&quot;</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>);<br>
  <br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (__crtInitOnceExecuteOnce(<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>reinterpret_cast</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>&lt;PINIT_ONCE&gt;(&amp;_Flag._Opaque),<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>reinterpret_cast</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>&lt;PINIT_ONCE_FN&gt;(_Lambda_fp),<br>
  <span style='mso-spacerun:yes'>        </span>_Pv, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>));<br>
  <span style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>读写锁</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>相对于临界区，读写锁能提供更精细的控制，它适用于写操作远少于读操作的数据结构。读写锁允许一个写线程独占访问，而多个读线程并行访问。当写线程需要独占访问时，它需要获得一个排它锁，如果此时有另外的线程持有排它锁或者共享锁，那么本线程就会被阻塞。当读线程需要共享访问时，只要没有线程持有排它锁，那么他就可以立即获得共享锁。读写锁的过程可以参照来自</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="http://ytliu.info/blog/2013/04/14/tong-bu-yuan-yu-xue-xi-bi-ji-lock,rcuhe-transaction/"
target="_blank"><span lang=ZH-CN style='color:#555555'>博文</span></a><span
lang=ZH-CN>的论述</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>Read</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>object</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>begin</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span>P(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>object</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>.lock)<br>
  <span style='mso-spacerun:yes'>  </span>AtomicAdd(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>object</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>.activeReader, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>)<br>
  <span style='mso-spacerun:yes'>  </span>V(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>object</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>.lock)<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>Do</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> Actual </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>Read</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span>AtomicAdd(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>object</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>.activeReaders, −</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>)<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>end</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>Write</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>object</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>begin</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span>P(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>object</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>.lock)<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>object</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>.activeReaders != </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>0</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>do</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> delay<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>Do</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> Actual </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>Write</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span>V(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>object</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>.lock)<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>end</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>对读写锁</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Windows API<span lang=ZH-CN>提供了所谓的</span>SRW<span
lang=ZH-CN>系列函数，</span>Linux<span lang=ZH-CN>提供了</span>rwlock<span lang=ZH-CN>系列函数。在</span>C++14<span
lang=ZH-CN>中终于提供了</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>std::shared_timed_mutex</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来实现读写锁，</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++17<span lang=ZH-CN>中提供了</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_mutex</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来实现一个没有定时的读写锁，从设计上看来这是有点本末倒置的，为什么要在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++17<span lang=ZH-CN>实现一个功能更少的类呢？</span><a
href="https://stackoverflow.com/questions/40207171/why-shared-timed-mutex-is-defined-in-c14-but-shared-mutex-in-c17"
target="_blank"><span style='color:#555555'>SoF<span lang=ZH-CN>指出这是出于性能原因</span></span></a><span
lang=ZH-CN>，在</span>C++14<span lang=ZH-CN>制定时，原本的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_mutex</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>拥有定时功能，但稍后一些人指出去掉定时功能能够提高效率，例如在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Windows<span
lang=ZH-CN>上的</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>SRWLOCK</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>机制提供了高效简便地实现一个没有定时的读写锁的方案，因此后来</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++14<span lang=ZH-CN>版本的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_mutex</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>被重命名到</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_timed_mutex</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，而一个没有定时的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_mutex</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++17<span lang=ZH-CN>提供。在</span>C++17<span
lang=ZH-CN>中我们的读锁可以声明为</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>std::shared_lock&lt;std::shared_mutex&gt;</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>shared_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来自</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++14)<span
lang=ZH-CN>，写锁可以声明为</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>std::unique_lock&lt;std::shared_mutex&gt;</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>unique_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来自</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++11)<span
lang=ZH-CN>，如此跨越三个版本的标准才最终完成的实现，你只有在</span>C++<span lang=ZH-CN>中才能看到。从实现上来看，无论是关键段、互斥量、信号量，甚至是条件变量都可以实现读写锁。</span><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l9 level1 lfo12;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>关键段的实现方式这里摘录了</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><a
     href="http://blog.csdn.net/StanfordZhang/article/details/40784975"
     target="_blank"><span style='color:#555555'>CSDN<span lang=ZH-CN>上的一个实现</span></span></a><span
     lang=ZH-CN>。其思想</span><a href="https://paste.ubuntu.com/p/9vy7wgbBVS/"
     target="_blank"><span lang=ZH-CN style='color:#555555'>如下</span></a><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l9 level1 lfo12;tab-stops:
     list 36.0pt;background:white'><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>互斥量的实现方式使用互斥量时我们需要注意在进行读操作时我们要获取写锁以免脏读，但可能出现多个读线程竞争写锁的情况，所以我们需要一个读锁。只有竞争到读锁的线程才能去锁定写锁。其过程如下</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;margin-left:36.0pt;border-collapse:collapse;mso-yfti-tbllook:
 1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>写</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  lock(mutex_write);<br>
  write();<br>
  unlock(mutex_write);<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// </span><span
  lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>读</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  lock(mutex_read);<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>if</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>(readers == </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>)<br>
  <span style='mso-spacerun:yes'>    </span>lock(mutex_write);<br>
  readers++;<br>
  unlock(mutex_read);<br>
  read();<br>
  lock(mutex_read);<br>
  readers--;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>if</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>(readers == </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>)<br>
  <span style='mso-spacerun:yes'>    </span>unlock(mutex_write);<br>
  unlock(mutex_read);<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<ol style='margin-top:0cm' start=3 type=1>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l9 level1 lfo12;tab-stops:
     list 36.0pt;background:white'><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>信号量的实现方式这里的</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>Swait(sem, t, d)</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>表示信号量</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>sem</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>的</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>P<span lang=ZH-CN>操作需要</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>t</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>个资源，并且会消耗</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>d</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>个资源，</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>Ssignal(sem, d)</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>表示信号量</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>sem</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>的</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>V<span lang=ZH-CN>操作产生</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>d</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>个资源。这里</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>Swait</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>类似</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::lock</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>，可以同时对若干个信号量上锁，从而避免死锁。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;margin-left:36.0pt;border-collapse:collapse;mso-yfti-tbllook:
 1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>初始化</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  max_reader = n; </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>最多允许</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>n</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>个读者读</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  Sinit(sem_read, max_reader);<br>
  Sinit(sem_write, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>);<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// </span><span
  lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>写</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  Swait(sem_write, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>; sem_read, max_reader, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>);<br>
  write();<br>
  Ssignal(sem_write, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>);<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// </span><span
  lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>读</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  Swait(sem_write, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>; sem_read, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>);<br>
  write();<br>
  Ssignal(sem_read, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>);<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<ol style='margin-top:0cm' start=4 type=1>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l9 level1 lfo12;tab-stops:
     list 36.0pt;background:white'><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>条件变量的实现方式</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>不变量与恶性条件竞争</span></b><b><span
style='font-size:15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>不变量</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(invariant)<span lang=ZH-CN>是某个特定数据结构始终保持的特性。例如通过链表的前向指针始终能到达前驱结点。不变量对应的特性常常在更新过程中被破坏，特别是当更新涉及到修改多个值，或者需要多个过程时。这就类似于在最终一致性系统的窗口内强一致性被破坏。当不变量遭到破坏时，才会产生竞态条件（</span>C++
Concurrency in Action: Ch3<span lang=ZH-CN>）。为了解决竞态条件，一种方法是确保只有当前进行修改的线程才能看到不变量被修改的中间状态，也就是将临界资源保护起来，前面看到的互斥量等属于这种机制。另一种方法是借助于锁无关编程技术，这种技术将对数据结构的修改分解为若干个不破坏不变量的原子操作。还有一种办法是借助于事务的</span>STM<span
lang=ZH-CN>技术，将所需要的操作存储于日志中，再合并提交。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>锁无关</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>锁无关</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(Lock-Free)<span lang=ZH-CN>是一种比无干扰</span>(Obstruction-Free)<span
lang=ZH-CN>高层次的并发模型，它是一个容易混淆的概念。锁无关与其他模型的本质区别并不是不用锁</span>(Lockless)<span
lang=ZH-CN>，而是确保各个线程在访问共享资源时之间不会互相阻塞，从而使得整个程序整体上能够始终向后执行。相对应地，如果使用内核锁，如果一个获得内核锁的线程被挂起或者挂掉，这容易导致其他拥有锁的线程陷入永久等待。但即使借助于原子操作，也会产生死锁、竞态的问题，例如自旋锁的死锁问题和使用</span>CAS<span
lang=ZH-CN>时可能出现的</span><a
href="http://www.isnowfy.com/understand-to-lock-free/" target="_blank"><span
style='color:#555555'>ABA<span lang=ZH-CN>问题</span></span></a><span lang=ZH-CN>。加锁操作通常存在着</span><a
href="http://blog.csdn.net/liuxuejiang158blog/article/details/17559901"
target="_blank"><span lang=ZH-CN style='color:#555555'>一些问题</span></a><span
lang=ZH-CN>，锁无关的编程虽然复杂，但相对于使用锁，锁无关的可伸缩性和性能方面会强于锁相关的算法，并且如果我们能够有序地组织各个线程“各行其道”，就能减少锁的使用。通常来说一个基于锁的算法在高竞争的系统中有较好的效率，因为当发生竞态时线程进行睡眠而不是立即重试，但在一般的情境中，不使用锁往往能避免上下文切换的开销。</span><br>
<span lang=ZH-CN>相应的还有一个无阻塞</span>(Non-blocking)<span lang=ZH-CN>的概念，无阻塞的限制条件要弱于锁无关。属于无阻塞算法而不属于无锁算法的常见例子包括自旋锁。在自旋锁中，所有的线程都不会进入睡眠，因此是非阻塞算法；而考虑当获得锁的线程因为一些原因被暂停时，所有的其他线程仍然需要在原地自旋<b>忙等</b>，因而自旋锁不是无锁算法。由此可见，锁无关编程中定义了如原子操作、</span>CAS<span
lang=ZH-CN>之类的范式，它们本身都是不涉及到锁的，但为了确保我们的读写成功，往往需要尝试若干次，但这个多次尝试造成的<b>等待</b>本身不属于锁无关的范畴。其实锁机制本身也是<b>和等待没有关系的</b>，因为有些操作中的等待是客观的，我们不能看到锁，就想到阻塞，就想到等待，这是不正确的，即使我们不停</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>while</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>去轮询，没有锁，但还是存在等待。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>原子操作</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>原子操作是常见的实现锁无关编程的方式，常见的原子操作有</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>、</span>FAA<span
lang=ZH-CN>、</span>TAS<span lang=ZH-CN>、</span>TTAS<span lang=ZH-CN>等。原子操作指的是<b>不可被中断的一系列操作</b>，在原子操作保证当前操作中不发生线程切换，因此保证了其他的线程不可能访问这个资源。原子操作一般有两种实现方式，第一个是使用锁或者</span>CPU<span
lang=ZH-CN>的特殊指令等机制来维持原子性，第二个是当出现并发写等破坏原子性的情况时<b>让操作失败</b>，因此对于第二种情况需要使用一个循环不断尝试。这里需要注意的是，原子操作并不一定就能够提高效率，也就是所谓的</span>scalability<span
lang=ZH-CN>，这是由于涉及对共享对象操作的原子指令都可能造成</span>cache invalidation<span lang=ZH-CN>，也就是需要重新刷新缓存行。另外，原子操作本身也是很慢的，如</span><a
href="https://www.ibm.com/developerworks/cn/linux/l-rcu/" target="_blank"><span
lang=ZH-CN style='color:#555555'>下图</span></a><span lang=ZH-CN>所示</span><br>
</span><span lang=EN-GB><a
href="http://www.calvinneo.com/img/concur/speed_cmp.jpg"><span lang=EN-US
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK;mso-no-proof:yes;
text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shape id="Picture_x0020_2"
 o:spid="_x0000_i1026" type="#_x0000_t75" alt="http://www.calvinneo.com/img/concur/speed_cmp.jpg"
 href="http://www.calvinneo.com/img/concur/speed_cmp.jpg" style='width:445pt;
 height:161pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image009.jpg" o:title="speed_cmp"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=445 height=161 src="并发编程重要概念及比较.fld/image009.jpg"
alt="http://www.calvinneo.com/img/concur/speed_cmp.jpg" v:shapes="Picture_x0020_2"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><br>
<a href="https://www.zhihu.com/question/27026846" target="_blank"><span
lang=ZH-CN style='color:#555555'>我们知道</span><span style='color:#555555'>x86<span
lang=ZH-CN>汇编要求</span></span></a><span lang=ZH-CN>对任意位置的</span>1<span
lang=ZH-CN>字节，以及对</span><b>2/4/8<span lang=ZH-CN>对齐</span></b><span lang=ZH-CN>的</span>2/4/8<span
lang=ZH-CN>长度的整型读取都<b>是原子的</b>，但是</span>C++11<span lang=ZH-CN>前我们却不能假设甚至是对一个</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>int</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>赋值的操作是原子的，而在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++11<span lang=ZH-CN>后我们需要使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来显式声明一个原子的变量。这一方面是由于</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>无法保证通过一条指令从内存的存取（考虑一些违反</span>strict
aliasing<span lang=ZH-CN>的胡乱</span>cast<span lang=ZH-CN>破坏了对齐）。另一方面也是</span>C++11<span
lang=ZH-CN>前根本没有考虑对多线程提供语言级别的支持（这点</span>Java<span lang=ZH-CN>就做得比较好），</span>C++<span
lang=ZH-CN>标准规定</span>data race<span lang=ZH-CN>，即并发地去修改一个对象是</span>UB<span
lang=ZH-CN>的，所以编译器可以不考虑多线程的情况而进行优化，</span><a
href="https://www.zhihu.com/question/27026846" target="_blank"><span
lang=ZH-CN style='color:#555555'>产生错误</span></a><span lang=ZH-CN>。因此通常的方式是直接使用操作系统提供的</span>API<span
lang=ZH-CN>，一般来说如果能够有一个<b>原子的</b></span><b>CAS</b><span lang=ZH-CN>，那么就能够借助它实现其他的原子操作。为了展示问题的复杂性，下面展示了一个</span><a
href="http://dreamrunner.org/blog/2014/06/28/qian-tan-memory-reordering/"
target="_blank"><span lang=ZH-CN style='color:#555555'>早期</span><span
style='color:#555555'>GCC<span lang=ZH-CN>编译器的问题</span></span></a><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>extern </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> v;<br>
  <br>
  void f(</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>int</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> set_v)<br>
  {<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (set_v)<br>
  <span style='mso-spacerun:yes'>    </span>v = </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>;<br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// GCC 3.3.4--4.3.0
  O1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  f:<br>
  <span style='mso-spacerun:yes'>        </span>pushl<span
  style='mso-spacerun:yes'>   </span>%ebp<br>
  <span style='mso-spacerun:yes'>        </span>movl<span
  style='mso-spacerun:yes'>    </span>%esp, %ebp<br>
  <span style='mso-spacerun:yes'>        </span>cmpl<span
  style='mso-spacerun:yes'>    </span>$0, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>8</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(%ebp)<br>
  <span style='mso-spacerun:yes'>        </span>movl<span
  style='mso-spacerun:yes'>    </span>$1, %eax<br>
  <span style='mso-spacerun:yes'>        </span>cmove<span
  style='mso-spacerun:yes'>   </span>v, %eax<span
  style='mso-spacerun:yes'>        </span>; load (maybe)<br>
  <span style='mso-spacerun:yes'>        </span>movl<span
  style='mso-spacerun:yes'>    </span>%eax, v<span
  style='mso-spacerun:yes'>        </span>; store (always)<br>
  <span style='mso-spacerun:yes'>        </span>popl<span
  style='mso-spacerun:yes'>    </span>%ebp<br>
  <span style='mso-spacerun:yes'>        </span>ret<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在这个问题中考虑调用</span><span style='font-size:
10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>f(0)</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，理想情况下</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>v</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的值无论如何都不会变动的，但是在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>gcc<span lang=ZH-CN>生成的代码中，我们看到一个始终执行的存储</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>movl %eax, v</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。显然编译器认为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>f</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>并不会被修改，而且这对仅面向单线程优化的编译器是完全有理由说得通的。但如果在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>load<span lang=ZH-CN>和</span>store<span
lang=ZH-CN>之间发生了切换，并导致竞态。除了上面的例子，一些常见的优化，例如循环展开都会造成严重后果。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>互锁访问函数和</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>操作</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>操作系统提供的原子</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>API<span lang=ZH-CN>常借助于某些</span>CPU<span
lang=ZH-CN>（比如</span>Intel<span lang=ZH-CN>处理器）提供的指令，能够对<b>某些类型</b>实现<b>某些原子操作</b>。注意到对</span>SMP<span
lang=ZH-CN>架构而言，会出现多个核心并发写的情况，这个涉及到后面的内存模型，并且在这里我们可以暂时忽略这个问题。</span>Windows API<span
lang=ZH-CN>提供了一系列</span>Interlocked<span lang=ZH-CN>开头的互锁访问函数，这些函数在处理器层面被保证独占访问。其中一个很关键的便是</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>InterlockedCompareExchange(PLONG
dest, LONG value, LONG old)</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>函数，这个函数提供了对</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>LONG</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>类型的原子的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>操作。</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>InterlockedCompareExchange</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>将</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>*dest</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>old</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>进行比较，如果相等就将</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>*dest</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>设为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>value</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。显然，通过内核锁能够方便地实现原子语义，但原子操作通常会借助于这样的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>操作，因为这样能避免线程进入睡眠。借助于</span>CAS<span
lang=ZH-CN>可以实现其他的原子操作，例如下面的对</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>LONG</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>进行原子赋值的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>InterlockedExchange</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数。在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++11<span lang=ZH-CN>的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>类型中，我们会看到更多的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>的应用。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>LONG</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> InterlockedExchange(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>LONG</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> * target, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>LONG</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> value){<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>LONG</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> old;<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>do</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span>old = *target;<br>
  <span style='mso-spacerun:yes'>  </span>}</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(! InterlockedCompareExchange(target, value, old));<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> old;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>这里的</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>do-while</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>循环保证了在</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>InterlockedCompareExchange</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>失败之后再来一遍能够再来一遍直到成功，但是<b>不能将这个循环和自旋锁中的忙等混淆</b>，从而认为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>不是锁无关的。这是因为</span>CAS<span
lang=ZH-CN>实际上并没有“持有”临界资源，它只需要一个指令就能结束战斗。因此任意一个线程的暂停并不会使得其他线程进入忙等，甚至能够使得</span>CAS<span
lang=ZH-CN>的成功率更高。因此可以看出</span>CAS<span lang=ZH-CN>在这里对竞争访问实际上是“消极防御”的态度，也就是所谓的<b>乐观锁</b></span><b>(Optimistic
Locking)</b><span lang=ZH-CN>，乐观锁是一种非独占锁，它并不是向内核锁一样直接让竞争者们睡眠，而是返回一个失败的状态。相对应的，之前的内核锁和自旋锁等机制属于悲观锁、独占锁。相比乐观锁，悲观锁有以下的弱点（也可以理解为基于锁算法的弱点）</span><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l13 level1 lfo13;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>上下文切换造成的性能开销</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l13 level1 lfo13;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>可能造成的死锁问题</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l13 level1 lfo13;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>优先级倒置</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>使用</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>操作实现的并发缓冲队列</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>常见的用</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>实现的</span>Lockfree<span
lang=ZH-CN>算法例如缓冲队列。首先对于一读一写的模型我们可以仅通过</span><a
href="http://blog.csdn.net/linyt/article/details/5764312" target="_blank"><span
lang=ZH-CN style='color:#555555'>约束读指针和写指针</span></a><span lang=ZH-CN>的行为即可实现，并不需要接触并发模型。下面我们考虑多对多的模型，以论文</span><a
href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.53.8674&amp;rep=rep1&amp;type=pdf"
target="_blank"><span style='color:#555555'>Implementing Lock-Free Queues</span></a><span
lang=ZH-CN>中的论述为例。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>Enqueue(x) {<br>
  <span style='mso-spacerun:yes'>    </span>q = </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>new</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> record();<br>
  <span style='mso-spacerun:yes'>    </span>q-&gt;value = x;<br>
  <span style='mso-spacerun:yes'>    </span>q-&gt;next = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>NULL</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'> </span><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>do</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> {<br>
  <span style='mso-spacerun:yes'>        </span>p = tail; </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>使用</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>tail</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>维护链表尾指针的位置</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>} </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>while</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>( CAS(p-&gt;next, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>NULL</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, q) != </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>); </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// 1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'> </span><br>
  <span style='mso-spacerun:yes'>    </span>CAS(tail, p, q); </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 2</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  }<br>
  <br>
  DeQueue() {<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>do</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>{<br>
  <span style='mso-spacerun:yes'>        </span>p = head;<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (p-&gt;next == </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>NULL</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>){<br>
  <span style='mso-spacerun:yes'>    </span><span
  style='mso-spacerun:yes'>        </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> ERR_EMPTY_QUEUE;<br>
  <span style='mso-spacerun:yes'>        </span>}<br>
  <span style='mso-spacerun:yes'>    </span>} </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>while</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>( CAS(head, p, p-&gt;next) != </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>TRUE</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> );<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> p-&gt;next-&gt;value;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>这里有一个疑问，就是为什么</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>2<span lang=ZH-CN>这句不使用循环保护起来，这是因为这个语句是始终能够成功的。我们考虑成功进行了</span>1<span
lang=ZH-CN>处</span>CAS<span lang=ZH-CN>的线程</span>T1<span lang=ZH-CN>，它使得</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail-&gt;next</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>不为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>NULL</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>了，假如此时另一个线程</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>T2<span lang=ZH-CN>执行到</span>1<span
lang=ZH-CN>，那么它的</span>CAS<span lang=ZH-CN>一定是失败的。这个过程一直到语句</span>2<span
lang=ZH-CN>之后</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>tail</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>被成功更新成</span><span style='font-size:
10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>q</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，因此实际上可以把</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail-&gt;next</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>看成一个锁一样的东西。既然如此，我们容易发现一个违背锁无关性质的可能性，也就是当线程</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>T1<span lang=ZH-CN>在执行语句</span>2<span
lang=ZH-CN>时挂掉了，那就会阻塞所有其他在循环中的线程。因此我们提出下面的改良版</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>EnQueue(x)<br>
  {<br>
  <span style='mso-spacerun:yes'>    </span>q = </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>new</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> record();<br>
  <span style='mso-spacerun:yes'>    </span>q-&gt;value = x;<br>
  <span style='mso-spacerun:yes'>    </span>q-&gt;next = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>NULL</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'> </span><br>
  <span style='mso-spacerun:yes'>    </span>p = tail;<br>
  <span style='mso-spacerun:yes'>    </span>oldp = tail;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>do</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> {<br>
  <span style='mso-spacerun:yes'>  </span><span
  style='mso-spacerun:yes'>      </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (p-&gt;next != </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>NULL</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  <span style='mso-spacerun:yes'>            </span>p = p-&gt;next;<br>
  <span style='mso-spacerun:yes'>    </span>} </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>while</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>( CAS(p-&gt;next, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>NULL</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, q) != </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>TRUE</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>); </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// 1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'> </span><br>
  <span style='mso-spacerun:yes'>    </span>CAS(tail, oldp, q); </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 2</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>考虑到可能来自其他线程的未提交（指未执行语句</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>2<span lang=ZH-CN>）的添加，我们发现语句</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p = tail</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>并不一定是结尾，这也导致了为了维护离开循环时</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>必须指向结尾这个特性，线程需要在循环内自旋，从而导致上述的死锁现象的产生。为了解决问题，在这一版本中我们索性放宽假设，认为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>只是“接近”结尾，因此现在我们需要使用一个内层的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>while</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>循环来从</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>开始尝试更新结尾。这样即使</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>T1<span lang=ZH-CN>线程挂在语句</span>2<span
lang=ZH-CN>，没能更新完</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>tail</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>指针，线程</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>T2<span lang=ZH-CN>也可以自动跟踪到</span>T1<span
lang=ZH-CN>在</span>1<span lang=ZH-CN>处的修改。此时我们也不要担心语句</span>2<span lang=ZH-CN>的失败问题，因为有的时候它应该失败。考虑下面的执行顺序：原先链表中只有一个元素</span>1<span
lang=ZH-CN>，此时线程</span>T1<span lang=ZH-CN>添加了一个元素</span>2<span lang=ZH-CN>，并且成功执行语句</span>1<span
lang=ZH-CN>，将</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>p</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>指向了元素</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>2<span lang=ZH-CN>的位置。此时发生了调度，线程</span>T2<span
lang=ZH-CN>获得处理器，它需要在队列中加一个元素</span>3<span lang=ZH-CN>，</span>T2<span
lang=ZH-CN>在刚进入循环时它发现自己的</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>tail</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>是指向</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>1<span lang=ZH-CN>的，但它在内层的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>while</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>循环中根据</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>p</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>next</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>指针走到了刚被</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>T1<span lang=ZH-CN>添加进去的元素</span>2<span
lang=ZH-CN>处。因此</span>T2<span lang=ZH-CN>在元素</span>2<span lang=ZH-CN>的末尾增加了元素</span>3<span
lang=ZH-CN>，并且更新自己的</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>p</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>指向元素</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>3<span lang=ZH-CN>。</span>T2<span
lang=ZH-CN>继续执行语句</span>2<span lang=ZH-CN>，此时</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail == oldp</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>指向元素</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>1<span lang=ZH-CN>，所以</span>CAS<span
lang=ZH-CN>成功，</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>tail</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>指向了元素</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>3<span lang=ZH-CN>。接着</span>T1<span
lang=ZH-CN>重新获得了处理器，此时</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>tail</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>已经被</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>T2<span lang=ZH-CN>修改到指向元素</span>3<span
lang=ZH-CN>了，于是不能匹配</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>oldp</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>，这个</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>就会失败。容易看到这个失败不会影响</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>指向精确的队列结尾。但是如果我们稍稍修改下上面的运行顺序，按照</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>T1</span><span
lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
mso-bidi-font-family:"Microsoft YaHei";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>添加元素</span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>2 =&gt; T2</span><span lang=ZH-CN
style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
"Microsoft YaHei";color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>添加元素</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>3 =&gt; T1</span><span
lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
mso-bidi-font-family:"Microsoft YaHei";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>修改</span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>tail =&gt; T2</span><span lang=ZH-CN
style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
"Microsoft YaHei";color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>修改</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail(</span><span
lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
mso-bidi-font-family:"Microsoft YaHei";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>失败</span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>)</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>来执行，那么我们就会发现</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>被更新到指向元素</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>2<span lang=ZH-CN>而不是元素</span>3<span
lang=ZH-CN>。所以我们看到先前我们放宽的假设是非常有必要的，在论文中作者指出这种情况下</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>tail</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>指针距离列表的准确结束位置最多相差</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>2 * p - 1</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>个节点。其实这个“最多”还是有点多的，所以在实践中我们常常结合两种方案来使用。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>提供的原子操作</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>如果细究上面</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>WINAPI<span lang=ZH-CN>的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>InterlockedCompareExchange</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，容易猜到它的实现方式来自于</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>的硬件支持，因为它只能为特定数据类型提供服务。事实上，这里</span><a
href="http://blog.csdn.net/zhangliang1223/article/details/7614027"
target="_blank"><span lang=ZH-CN style='color:#555555'>用了</span><span
style='color:#555555'>x86<span lang=ZH-CN>中的</span></span><b><span
style='color:#555555;text-decoration:none;text-underline:none'>cmpxchg</span></b><span
lang=ZH-CN style='color:#555555'>命令</span></a><span lang=ZH-CN>。</span><br>
CPU<span lang=ZH-CN>原子操作的实现借助于总线锁、缓存锁等机制。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>的原子操作库</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在上面的章节中，我们概览了锁无关编程的一些思想。从现在开始，我们将讨论</span><b><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++11<span lang=ZH-CN>标准库</span></span></b><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>提供的原子操作支持。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>std::atomic_flag<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>std::atomic_flag</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++11<span lang=ZH-CN>原子库的一个基础设施，它被广泛地运用到下面的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>类模板的实现中。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic_flag</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>基于</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>TAS(test-and-set)<span
lang=ZH-CN>操作维护了一个布尔量</span>flag<span lang=ZH-CN>，提供了</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>test_and_set</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>clear</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>两个方法，可以保证对</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>flag<span lang=ZH-CN>的写不会冲突，读不会脏读。</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>test_and_set</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>尝试将</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>flag<span lang=ZH-CN>从</span>false<span
lang=ZH-CN>设为</span>true<span lang=ZH-CN>，如果发现</span>flag<span lang=ZH-CN>已被设置，否则原子地设置</span>flag<span
lang=ZH-CN>为</span>true<span lang=ZH-CN>，该函数返回的是</span>flag<span lang=ZH-CN>先前的值。由于</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic_flag</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>原子地维护了一个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>flag<span lang=ZH-CN>，它常被用来实现自旋锁。下面的代码来自</span>MSVC<span
lang=ZH-CN>的</span>atomic<span lang=ZH-CN>库，它在</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Atomic_copy</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>方法中被调用。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>inline</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Lock_spin_lock(<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>volatile</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> _Atomic_flag_t *_Flag)<br>
  <span style='mso-spacerun:yes'>    </span>{<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (_ATOMIC_FLAG_TEST_AND_SET(_Flag,
  memory_order_acquire))<br>
  <span style='mso-spacerun:yes'>        </span>_YIELD_PROCESSOR;<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>inline</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _Unlock_spin_lock(<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>volatile</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> _Atomic_flag_t *_Flag)<br>
  <span style='mso-spacerun:yes'>    </span>{<br>
  <span style='mso-spacerun:yes'>    </span>_ATOMIC_FLAG_CLEAR(_Flag,
  memory_order_release);<br>
  <span style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>此外，容易发现</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>TAS<span lang=ZH-CN>操作也可以通过</span>CAS<span
lang=ZH-CN>实现，其代码很简单</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>return</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> InterlockedCompareExchange(&amp;flag, </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>false</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>);<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>MSVC<span lang=ZH-CN>的标准库实现中</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>test_and_set</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>借助了</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Interlock<span
lang=ZH-CN>互锁访问函数，保证了访问的原子性</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<br>
  23<br>
  24<br>
  25<br>
  26<br>
  27<br>
  28<br>
  29<br>
  30<br>
  31<br>
  32<br>
  33<br>
  34<br>
  35<br>
  36<br>
  37<br>
  38<br>
  39<br>
  40<br>
  41<br>
  42<br>
  43<br>
  44<br>
  45<br>
  46<br>
  47<br>
  48<br>
  49<br>
  50<br>
  51<br>
  52<br>
  53<br>
  54<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><span style='mso-spacerun:yes'> </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>#if defined(_M_ARM) ||
  defined(_M_ARM64)</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _INTRIN_RELAXED(x)<span
  style='mso-spacerun:yes'>    </span>_CONCAT(x, _nf)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _INTRIN_ACQUIRE(x)<span
  style='mso-spacerun:yes'>    </span>_CONCAT(x, _acq)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _INTRIN_RELEASE(x)<span
  style='mso-spacerun:yes'>    </span>_CONCAT(x, _rel)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _INTRIN_SEQ_CST(x)<span
  style='mso-spacerun:yes'>    </span>x</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#else </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>/* defined(_M_ARM) || defined(_M_ARM64) */</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _INTRIN_RELAXED(x)<span
  style='mso-spacerun:yes'>    </span>x</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _INTRIN_ACQUIRE(x)<span
  style='mso-spacerun:yes'>    </span>x</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _INTRIN_RELEASE(x) <span
  style='mso-spacerun:yes'>   </span>x</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _INTRIN_SEQ_CST(x)<span
  style='mso-spacerun:yes'>    </span>x</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#endif </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>/* defined(_M_ARM) || defined(_M_ARM64) */</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>inline</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>int</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _Atomic_flag_test_and_set(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>volatile</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> _Atomic_flag_t *_Flag,<br>
  <span style='mso-spacerun:yes'>    </span>memory_order _Order)<br>
  <span style='mso-spacerun:yes'>    </span>{<span style='mso-spacerun:yes'>  
  </span></span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>/* atomically test
  flag and set to true */</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>switch</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (_Order)<br>
  <span style='mso-spacerun:yes'> </span><span style='mso-spacerun:yes'>      
  </span>{<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>case</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> memory_order_relaxed:<br>
  <span style='mso-spacerun:yes'>            </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>
  (_INTRIN_RELAXED(_interlockedbittestandset)(_Flag, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>));<br>
  <br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>case</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> memory_order_consume:<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>case</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> memory_order_acquire:<br>
  <span style='mso-spacerun:yes'>            </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>
  (_INTRIN_ACQUIRE(_interlockedbittestandset)(_Flag, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>));<br>
  <br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>case</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> memory_order_release:<br>
  <span style='mso-spacerun:yes'>            </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>
  (_INTRIN_RELEASE(_interlockedbittestandset)(_Flag, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>));<br>
  <br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>case</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> memory_order_acq_rel:<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>case</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> memory_order_seq_cst:<br>
  <span style='mso-spacerun:yes'>            </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>
  (_INTRIN_SEQ_CST(_interlockedbittestandset)(_Flag, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>));<br>
  <br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>default</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>:<br>
  <span style='mso-spacerun:yes'>            </span>_INVALID_MEMORY_ORDER;<br>
  <span style='mso-spacerun:yes'>            </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>);<br>
  <span style='mso-spacerun:yes'>        </span>}<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>inline</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _Atomic_flag_clear(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>volatile</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _Atomic_flag_t *_Flag,<br>
  <span style='mso-spacerun:yes'>    </span>memory_order _Order)<br>
  <span style='mso-spacerun:yes'>    </span>{<span style='mso-spacerun:yes'>  
  </span></span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>/* atomically clear
  flag */</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>static_assert</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>sizeof</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(_Atomic_flag_t) == </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>sizeof</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(_Uint4_t),<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>&quot;Unexpected _Atomic_flag_t
  size&quot;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>);<br>
  <br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>switch</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (_Order)<br>
  <span style='mso-spacerun:yes'>        </span>{<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>case</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> memory_order_relaxed:<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>case</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> memory_order_release:<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>case</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> memory_order_seq_cst:<br>
  <span style='mso-spacerun:yes'>            </span>_Atomic_store_4((</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Uint4_t *)_Flag, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>, _Order);<br>
  <span style='mso-spacerun:yes'>            </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>break</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>default</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>:<br>
  <span style='mso-spacerun:yes'>            </span>_INVALID_MEMORY_ORDER;<br>
  <span style='mso-spacerun:yes'>            </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>break</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'>        </span>}<br>
  <span style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>std::atomic<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在前面的讨论中我们已经明白</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>中的基本类型并不保证是原子的，所以</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic&lt;T&gt;</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>定义了一系列具有<b>原子行为</b>的<b>类型</b>。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>禁用了复制构造函数和复制赋值运算符（同时也不允许移动）。这是由于这两个操作发生在两个对象间，势必要破坏原子性，而一个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的所有操作都是原子的。对于用户自定义类型</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(UDT)</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>typename T</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的<b>主模板</b>要求</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>T</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>满足</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="http://zh.cppreference.com/w/cpp/atomic/atomic" target="_blank"><span
style='color:#555555'>standard layout<span lang=ZH-CN>、</span>trivial default
constructor<span lang=ZH-CN>和</span>trivial destructor</span></a><span
lang=ZH-CN>，即编译器可以使用</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>memcpy</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等进行</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>bitwise<span
lang=ZH-CN>的复制并使用</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>memcmp</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>进行</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>bitwise<span lang=ZH-CN>的比较。在</span>CAS<span
lang=ZH-CN>操作的实现中调用了</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>memcpy</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memcmp</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。这看起来限制很大，我们希望有用户自定义的复制构造函数，这样我们就可以进行</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>member-wise<span
lang=ZH-CN>的操作了，对此想法，</span><i>C++ Concurrency in Action</i><span lang=ZH-CN>一书中指出，如果有自定义的复制构造函数，那么就势必要将锁定区域（下文中会交待其实</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的主模板实现中可能会有自旋锁）内的数据交给这些用户代码，如果在用户代码中再使用了锁，就可能产生死锁的现象。容易发现我们常用的智能指针</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_ptr</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>并不能被放到</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>里面，但是我们又确实有这个需要，因此标准库通过重载</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic_</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>系列函数为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_ptr</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>提供了原子操作的支持。而对于</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>类型，我们既可以通过</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic_</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>系列函数，也可以通过</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>模板中提供了</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>compare_exchange_weak</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>compare_exchange_strong</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>load</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>store</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等操作。一般标准库会对一些大小满足能够直接使用某些处理器的原子指令的类型进行特化，例如指针类型、</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>integral<span
lang=ZH-CN>类型和一些用户定义类型。对于指针类型，</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>会进行偏特化。原子的指针运算可以通过</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>fetch_</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>开头的函数和相应的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>operator</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>运算符来实现。对</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>integeral<span
lang=ZH-CN>类型</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>std::atomic</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>类模板也会进行特化，其实现类似指针类型，并且添加了对位运算的支持。对于“复杂”的整型计算如乘法，虽然</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>atomic<span
lang=ZH-CN>未提供，但可以通过</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>compare_exchange_weak</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等函数间接实现。从</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++20<span lang=ZH-CN>开始，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>类模板提供对浮点类型的特化。注意在这之前，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>compare_exchange_strong</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>方法对浮点数可能出现问题，原因显而易见是</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memcmp</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的锅，</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>浮点数之间比较时甚至都不能使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>==</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，遑论</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memcmp</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。在上文中提到，除了</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic_flag</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic&lt;typename
T&gt;</span><span lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>类模板都是<b>不保证不使用锁</b>的（情况特定于处理器和标准库实现），用户可通过</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>bool is_lock_free()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数判断是否</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Lockfree<span
lang=ZH-CN>的。以</span>PJ Plauger<span lang=ZH-CN>的实现为例，主模板的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>load()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>内部就使用了上文提到的用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic_flag</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>实现的自旋锁。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>inline</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Atomic_copy(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Atomic_flag_t *_Flag, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>size_t</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Size,<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>volatile</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> *_Tgt, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>volatile</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>const</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> *_Src, memory_order _Order)<br>
  {<br>
  <span style='mso-spacerun:yes'>    </span>_Lock_spin_lock(_Flag);<br>
  <span style='mso-spacerun:yes'>    </span>_CSTD memcpy((void *)_Tgt, (void
  *)_Src, _Size);<br>
  <span style='mso-spacerun:yes'>    </span>_Unlock_spin_lock(_Flag);<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>这里要提一句，主模板的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>template&lt;class
_Ty&gt; struct atomic</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>的实现继承了</span><span style='font-size:
10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Atomic_base&lt;_Ty,
sizeof (_Ty)&gt;</span><span lang=ZH-CN style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>。这个</span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>_Atomic_base&lt;_Ty, sizeof (_Ty)&gt;</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>模板又继承了</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Atomic_impl&lt;_Bytes&gt;</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>模板，其作用相当于把</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Atomic_impl&lt;_Bytes&gt;</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中全</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>void *</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的东西封装回了</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Ty</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。我们查看最核心的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Atomic_impl&lt;_Bytes&gt;</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>模板，它是和数据字节数相关的，分别对</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>1/2/4/8<span
lang=ZH-CN>字节的进行了偏特化。模板里面定义了最重要的</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>_Is_lock_free</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Store</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Load</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Exchange</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Compare_exchange_weak</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Compare_exchange_strong</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等操作，全部是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>void*</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的。我们刚才看到的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Atomic_copy</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来自于主模板。我们下面看看</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Atomic_impl&lt;_Bytes&gt;</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的偏特化版本，如对于一个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>uint2_t</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是如何实现的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<br>
  23<br>
  24<br>
  25<br>
  26<br>
  27<br>
  28<br>
  29<br>
  30<br>
  31<br>
  32<br>
  33<br>
  34<br>
  35<br>
  36<br>
  37<br>
  38<br>
  39<br>
  40<br>
  41<br>
  42<br>
  43<br>
  44<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><span style='mso-spacerun:yes'>  </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>#define _Compiler_barrier()<span
  style='mso-spacerun:yes'>   </span>_ReadWriteBarrier()</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#if defined(_M_ARM)</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _Memory_barrier()<span
  style='mso-spacerun:yes'>     </span>__dmb(_ARM_BARRIER_ISH)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#endif </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>/* defined(_M_ARM) */</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#if defined(_M_ARM64)</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#define _Memory_barrier()<span
  style='mso-spacerun:yes'>     </span>__dmb(_ARM64_BARRIER_ISH)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#endif </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>/* defined(_M_ARM64) *</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'><span
  style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'><span
  style='mso-spacerun:yes'>    </span>/* _Atomic_load_2 */</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>inline</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Uint2_t _Load_seq_cst_2(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Uint2_t *_Tgt)<br>
  <span style='mso-spacerun:yes'>    </span>{<br>
  <span style='mso-spacerun:yes'>    </span>_Uint2_t _Value;<br>
  <br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#if defined(_M_ARM) || defined(_M_ARM64)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>_Value = __iso_volatile_load16((</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>short</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> *)_Tgt);<br>
  <span style='mso-spacerun:yes'>    </span>_Memory_barrier();<br>
  <br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#else</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>_Value = *_Tgt;<br>
  <span style='mso-spacerun:yes'>    </span>_Compiler_barrier();<br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#endif</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (_Value);<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>inline</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Uint2_t _Load_relaxed_2(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Uint2_t *_Tgt)<br>
  <span style='mso-spacerun:yes'>    </span>{<br>
  <span style='mso-spacerun:yes'>    </span>_Uint2_t _Value;<br>
  <br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#if defined(_M_ARM) || defined(_M_ARM64)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>_Value = __iso_volatile_load16((</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>short</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> *)_Tgt);<br>
  <br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#else</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>_Value = *_Tgt;<br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#endif</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (_Value);<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>inline</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Uint2_t _Load_acquire_2(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Uint2_t *_Tgt)<br>
  <span style='mso-spacerun:yes'>    </span>{<span style='mso-spacerun:yes'>  
  </span><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (_Load_seq_cst_2(_Tgt));<br>
  <span style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>可以发现在这个偏特化版本的实现中直接借助了处理器提供的设施，而避免了自旋锁的使用。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>weak<span lang=ZH-CN>和</span>strong<span
lang=ZH-CN>版本的</span>CAS<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>类似与</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Windows API<span lang=ZH-CN>的互锁访问函数，</span>atomic<span
lang=ZH-CN>库通过</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>bool atomic::compare_exchange_weak(old, value)</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>bool
atomic::compare_exchange_strong(old, value)</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>提供了对</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>操作的支持。这两个函数监测该</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中维护的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic_flag
_My_flag</span><span lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>（在</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_Atomic_impl</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>模板中定义）的值，如果等于</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>old</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>就改为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>value</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，函数返回一个表示修改是否成功的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>bool<span lang=ZH-CN>量。因此容易发现这两个函数不总是成功的，因为</span>CPU<span
lang=ZH-CN>可能仅对某些类型提供了相应的</span>CAS<span lang=ZH-CN>原子指令，对于其他的类型则必须通过使用自旋锁甚至内核锁来实现。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>inline</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>int</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Atomic_compare_exchange_weak(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Atomic_flag_t *_Flag, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>size_t</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Size, </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>volatile</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> *_Tgt, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>volatile</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> *_Exp, </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>const</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>volatile</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> *_Src, memory_order _Order1, memory_order _Order2)<br>
  {<span style='mso-spacerun:yes'>   </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>/* atomically compare and exchange with memory
  ordering */</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>int</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _Result;<br>
  <br>
  <span style='mso-spacerun:yes'>    </span>_Lock_spin_lock(_Flag);<br>
  <span style='mso-spacerun:yes'>    </span>_Result = _CSTD </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>memcmp</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>((</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>const</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> *)_Tgt, (</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>const</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> *)_Exp, _Size) == </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (_Result != </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>0</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>)<br>
  <span style='mso-spacerun:yes'>        </span>_CSTD memcpy((void *)_Tgt,
  (void *)_Src, _Size);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>else</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span>_CSTD </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>memcpy</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>((</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> *)_Exp, (</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> *)_Tgt, _Size);<br>
  <span style='mso-spacerun:yes'>    </span>_Unlock_spin_lock(_Flag);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (_Result);<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>这两个函数有一些细致的区别，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>compare_exchange_weak</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>在可能会</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>False Negative<span
lang=ZH-CN>，这是由于</span>weak<span lang=ZH-CN>允许</span>spurious failure<span
lang=ZH-CN>。在某些平台（不错</span>ARM<span lang=ZH-CN>、</span>PowerPC<span lang=ZH-CN>又被点名了）上的</span>CAS<span
lang=ZH-CN>是通过</span>LL/SC<span lang=ZH-CN>实现的，而不像</span>x86<span lang=ZH-CN>上那样只通过一条指令，所以可能存在问题。因此使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>compare_exchange_weak</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的时候需要一个循环。注意到这个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>!expected</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>不是必要的。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>bool</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> expected=</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>false</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>extern</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> atomic&lt;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>bool</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>&gt; b; </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// set somewhere else</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>while</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>(!b.compare_exchange_weak(expected,</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>) &amp;&amp; !expected);<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><a
href="https://chaomai.github.io/2015/06/09/2015-2015-06-09-translation-understand-std-atomic-compare-exchange-weak-in-cpp11/"
target="_blank"><span style='color:#555555'>Stackoverflow<span lang=ZH-CN>上相关问题的整理</span></span></a><span
lang=ZH-CN>中提到了这两者之间的性能比较，由于</span>weak<span lang=ZH-CN>会忽视检查，所以一般</span>weak<span
lang=ZH-CN>比</span>strong<span lang=ZH-CN>快。但是如果使用</span>strong<span
lang=ZH-CN>能避免</span>weak+loop<span lang=ZH-CN>，那么选择</span>strong<span
lang=ZH-CN>是适合的。注意到即使使用</span>strong<span lang=ZH-CN>，</span>loop<span
lang=ZH-CN>也不是就一定可以避免的，因为原子操作本来就存在使用乐观锁的情况。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>ABA<span lang=ZH-CN>问题</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>伴随着</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CAS<span lang=ZH-CN>的是可能存在的</span>ABA<span
lang=ZH-CN>问题。</span>ABA<span lang=ZH-CN>问题的根源是从内存中取出值和</span>CAS<span
lang=ZH-CN>这两个操作不是原子的，因此可能在这两个过程中发生切换。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>原子操作与锁的关系</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在上面的讨论中，我们能够直观地发现原子操作和锁的关系。原子操作看起来是“独善其身”的只能管住自己，原子操作之间、原子操作和非原子操作之间可能发生乱序或重排；而锁像大哥，能护住一段代码。由此我们思考如何通过原子操作来组织其他的那些非原子操作呢？这就要引入下面讨论的内存模型的问题。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>其他的同步原语</span></b><b><span
style='font-size:15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在上面的几个章节中，我们论述了基于锁和基于原子操作的同步原语。还有一些其他的同步原语，例如</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>RCU<span lang=ZH-CN>、</span>MCS
Lock<span lang=ZH-CN>等。在</span>Linux<span lang=ZH-CN>中使用了</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Hazard Pointer<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><a
href="http://www.cs.otago.ac.nz/cosc440/readings/hazard-pointers.pdf"
target="_blank"><span style='color:#555555'>Hazard Pointer</span></a><span
lang=ZH-CN>类似于面向多线程的智能指针，它能够无等待地进行线程安全的垃圾回收。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>RCU<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><a
href="http://www.rdrop.com/~paulmck/RCU/whatisRCU.html" target="_blank"><span
style='color:#555555'>RCU(Read Copy Update)</span></a><span lang=ZH-CN>是</span>Linux2.6<span
lang=ZH-CN>引入的一种替代读写锁的方法，在</span>Linux<span lang=ZH-CN>内核中被广泛使用。其思想是在多个读者能和一个写者并行，写者在访问值时首先拷贝一个副本，对副本进行修改，再在适当的时候将新的数据一次性写回，这个时机就是所有读者完成读取之后。</span><a
href="http://www.ibm.com/developerworks/cn/linux/l-rcu/index.html"
target="_blank"><span lang=ZH-CN style='color:#555555'>由此</span></a><span
lang=ZH-CN>看出这种方法能够很好地适应读多写少的情况，因为现在读者端不需要任何锁来保证同步，也不会被写者阻塞。但是写者端的任务加重了，一方面它仍然要处理和其他写者的竞争问题，另一方面它具有复制开销，还需要监听所有读者的信号以确定数据的修改时间。下面描述了写操作的流程：</span><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l0 level1 lfo14;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>对旧数据建立一块副本，对副本进行修改</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l0 level1 lfo14;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>等待前面所有的读者完成读取这时候</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>RCU<span lang=ZH-CN>实际上向专门的垃圾回收器注册一个</span>callback<span
     lang=ZH-CN>并等待器通知，这段时间称为</span>grace period<span lang=ZH-CN>。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l0 level1 lfo14;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>写者将原来的数据替换为新的数据</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l0 level1 lfo14;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>写者删除旧的数据</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>通过内存模型约束线程对变量的读写顺序</span></b><b><span
style='font-size:15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>锁无关编程的难点之一就是需要从编译器与</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>两个层面考虑行为对线程间的同步造成的的影响，也就是考虑<b>编译器重排和</b></span><b>CPU<span
lang=ZH-CN>缓存</span></b><span lang=ZH-CN>与乱序对读写逻辑可能造成的影响。当我们试图使用原子操作去解决非原子操作间的竞态问题时，那么我们需要谨慎选择使用恰当的内存模型，这样能够在提升效率的同时保证安全性。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>原子操作的线程间顺序</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>我们知道从</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>语言到运行程序得到结果之间需要经历编译器优化和处理器优化两道坎，处理器优化包括高速缓存和指令乱序，编译器优化可能进行重排。编译器和处理器达成的协议是不能改变单线程程序的行为。以编译器优化为例，下面展示的代码在</span>O0<span
lang=ZH-CN>下，</span>g++7<span lang=ZH-CN>按照</span>1-2<span lang=ZH-CN>的原始顺序来编译，但开启</span>O1<span
lang=ZH-CN>后，</span>g++7<span lang=ZH-CN>就会进行</span>Store-Store<span
lang=ZH-CN>重排，将</span>2<span lang=ZH-CN>提到</span>1<span lang=ZH-CN>前面，先对</span>b<span
lang=ZH-CN>赋值，再对</span>a<span lang=ZH-CN>赋值；并且还去除了一部分没用的代码。对单线程来说，这样的优化并没有任何问题。但对于多线程来说则可能出现问题。一方面，由于去除部分代码的原因，汇编</span>O1<span
lang=ZH-CN>事实上不能在</span>a<span lang=ZH-CN>处观察到</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>a == 1 &amp;&amp; b
== 1</span><span lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的情况，而假设</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>O0<span lang=ZH-CN>汇编在进行到</span>b<span
lang=ZH-CN>处被抢占，那么其他的线程有机会看到以上的情况。另一方面，在</span>O1<span lang=ZH-CN>中先对</span>b<span
lang=ZH-CN>赋值再对</span>a<span lang=ZH-CN>赋值，仍然会出现问题。假如说在</span>3<span
lang=ZH-CN>和</span>4<span lang=ZH-CN>间线程被强占，那么另外一个线程观察</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>a</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>b</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，得到</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>b</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>123<span lang=ZH-CN>，而</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>a</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>为不确定值（或者</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>1<span lang=ZH-CN>，如果前面赋初值语句没有被删去的话），而如果编译器不进行重排，我们理想中的原始结果是</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>a</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>43<span lang=ZH-CN>，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>b</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>为不确定值。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>main</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>int</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> a = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>, b = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>; </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 0</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// a</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>a = b + </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>42</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>; </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// c</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>b = </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>123</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>; </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 2</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>printf</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>&quot;%d %d&quot;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, a, b);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>0</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// compile with -O0</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>movl<span
  style='mso-spacerun:yes'>    </span>$</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>-8</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(%rbp)<br>
  <span style='mso-spacerun:yes'>    </span>movl<span
  style='mso-spacerun:yes'>    </span>$</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>1</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>-4</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(%rbp)<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// b</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>movl<span
  style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>-4</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(%rbp), %eax<br>
  <span style='mso-spacerun:yes'> </span><span style='mso-spacerun:yes'>  
  </span>addl<span style='mso-spacerun:yes'>    </span>$</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>42</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>, %eax<br>
  <span style='mso-spacerun:yes'>    </span>movl<span
  style='mso-spacerun:yes'>    </span>%eax, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>-8</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(%rbp)<br>
  <span style='mso-spacerun:yes'>    </span>movl<span
  style='mso-spacerun:yes'>    </span>$</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>123</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>-4</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(%rbp)<br>
  <span style='mso-spacerun:yes'>    </span>movl<span
  style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>-4</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(%rbp), %edx<br>
  <span style='mso-spacerun:yes'>    </span>movl<span
  style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>-8</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(%rbp), %eax<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// compile with -O1</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>movl<span
  style='mso-spacerun:yes'>    </span>$</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>123</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, %ecx </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 3</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>movl<span
  style='mso-spacerun:yes'>    </span>$</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>43</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, %edx </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 4</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>出于性能方面的考虑，对<b>多线程</b>的程序而言并不存在和单线程一样的硬性要求。在使用原子操作等锁无关技术时，不能假设所有环境下程序最后行为一如我们希望代码所“暗示”一样。事实上编译器或处理器可以在<b>不同线程间</b>对<b>不同变量间</b>进行读写乱序，而这在多线程中会造成问题。例如在单线程中将对</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>B<span lang=ZH-CN>的写提到对</span>A<span
lang=ZH-CN>的读前面是没有问题的，但是对多线程来说，这往往就会出现问题。虽然大部分时候我们不需要操心这个问题，这是因为一方面在使用</span>mutex<span
lang=ZH-CN>等内核锁时，内核帮我们做了相关工作，另一方面部分处理器（如</span>x86<span lang=ZH-CN>）也提供了（</span><a
href="https://www.zhihu.com/question/24301047" target="_blank"><span
lang=ZH-CN style='color:#555555'>近似</span></a><span lang=ZH-CN>，实际上是</span><a
href="https://ljalphabeta.gitbooks.io/a-primer-on-memory-consistency-and-cache-coherenc/content/%E7%AC%AC%E5%9B%9B%E7%AB%A0-total-store-order%E5%92%8Cx.html"
target="_blank"><span style='color:#555555'>TSO</span></a><span lang=ZH-CN>）</span>acquire/release<span
lang=ZH-CN>的保障，并也可以通过一些指令命令编译器在某些地方减少优化，但这依然是一个客观存在的问题。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>可见性和有序性</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>可见性指一个线程对变量的写操作对其它线程后续的读操作可见，这里见的是结果。可见性要求</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>在对缓存行写操作后能够保证至少在某个时间点前必须写回内存，从而保证其他线程能读到<b>最新的值</b>。有序性指的是数据不相关变量在并发的情况下，实际执行的结果和单线程的执行结果和单线程的执行结果是一样的，不会因为重排</span>/<span
lang=ZH-CN>乱序的问题导致结果不可预知。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>根据以上的定义，我们引入下面的两个概念：如果操作</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>A<span lang=ZH-CN>先行发生</span>(happen-before)<span
lang=ZH-CN>于操作</span>B<span lang=ZH-CN>，那么</span>A<span lang=ZH-CN>造成的修改能够被</span>B<span
lang=ZH-CN>观察到。我们以</span><a href="https://zhuanlan.zhihu.com/p/31386431"
target="_blank"><span lang=ZH-CN style='color:#555555'>知乎</span></a><span
lang=ZH-CN>上举出的一个例子来理解，根据上面有关原子操作的线程间顺序的讨论，我们知道下面的代码在单线程条件下断言是始终成立的，即使语句</span>1<span
lang=ZH-CN>和</span>2<span lang=ZH-CN>之间发生了重排。容易看出</span>happen-before<span
lang=ZH-CN>强调的是一个现象，</span>C++<span lang=ZH-CN>保证在单线程中</span>happen-before<span
lang=ZH-CN>现象是始终成立的，不管后面编译器和</span>CPU<span lang=ZH-CN>如何进行重排。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> a, b;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>foo</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>()</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span>a = </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>42</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>; </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>b = a; </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 2</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>assert(b == </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>42</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>);<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>如果</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>A<span lang=ZH-CN>同步发生</span>(synchronizes-with)<span
lang=ZH-CN>于</span>B<span lang=ZH-CN>，那么某个线程中</span>A<span lang=ZH-CN>的修改能够被另一个线程中的</span>B<span
lang=ZH-CN>观察到。它实际上是建立一种方法，使得一个时间点前内存的变化能够被其他线程看到。我们引用同样的来源的一个例子，由于重排的问题，在下面的代码中语句</span>4<span
lang=ZH-CN>的断言不一定成立（我们不考虑</span>x86 CPU<span lang=ZH-CN>的</span>TSO<span
lang=ZH-CN>模型）。这就说明<b>在</b></span><b>Relax<span lang=ZH-CN>等无约束或者少约束的内存模型下，在多线程中试图通过某原子量来同步非原子量并不是可靠的</span></b><span
lang=ZH-CN>。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> data;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>atomic_bool</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> flag { </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>false</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> };<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// Execute in thread
  A</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>producer</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span>data = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>42</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>;<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// (1)</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>flag.store(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, memory_order_relaxed);<span
  style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// (2)</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  }<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// Execute in thread
  B</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>consume</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>{<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (!flag.load(memory_order_relaxed));<span
  style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// (3)</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>assert(data == </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>42</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>);<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// (4)</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>内存一致性模型</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>广义上的</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><a
href="https://en.wikipedia.org/wiki/Consistency_model" target="_blank"><span
lang=ZH-CN style='color:#555555'>一致性模型</span></a><span lang=ZH-CN>包括</span>Strict
Consistency<span lang=ZH-CN>、</span>Sequential Consistency<span lang=ZH-CN>、</span>Causal
Consistency<span lang=ZH-CN>、</span>Processor Consistency<span lang=ZH-CN>、</span>FIFO
consistency<span lang=ZH-CN>、</span>Cache Consistency<span lang=ZH-CN>、</span>Slow
Consistency<span lang=ZH-CN>、</span>Release consistency<span lang=ZH-CN>、</span>Entry
Consistency<span lang=ZH-CN>、</span>General Consistency<span lang=ZH-CN>、</span>Local
Consistency<span lang=ZH-CN>等。在</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中提供了六种内存模型</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(memory order)<span
lang=ZH-CN>来描述不同线程之间相同</span>/<span lang=ZH-CN>不同数据的读写的顺序。顺序一致性</span>(sequential
consistency, SC)<span lang=ZH-CN>是最强的模型，要求程序中的行为从任意角度来看，序列顺序都是一致的</span>(have
single total order)<span lang=ZH-CN>；这是在说这段多线程程序的行为和一段单线程程序的行为是一致的，类似于不是并行的并发。这个模型禁止了任何四种类型的读写重排，因此我们可以认为</span>SC<span
lang=ZH-CN>下每次读到的都是最新值。在</span>C++ Concurrency in Action<span lang=ZH-CN>中举了一个例子，使用四个线程运行下面四个函数，断言无论如何</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>z</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>永远不可能为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>0<span lang=ZH-CN>。这说明了在</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>read_x_then_y</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>read_y_then_x</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>两个函数至少有一个能看到</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>x</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>y</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>同时被设为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>true</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。容易看出将</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>1/2/3/4<span
lang=ZH-CN>任意排序，那么上面的断言是显然的（注意到即使</span></span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>read_x_then_y</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>在</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>write_x</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>前被调用也有</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>while<span lang=ZH-CN>循环兜底）。但是如果</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>(1 -&gt; 3)</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>(2 -&gt; 4)</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>这两个步骤并行发生的话，上面断言就不成立了。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::atomic&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>bool</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; x = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>false</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, y = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>false</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::atomic&lt;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>int</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>&gt; z = </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>write_x</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>  </span>x.store(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>,</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_seq_cst);<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 1</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>write_y</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>  </span>y.store(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>,</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_seq_cst);<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 2</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>read_x_then_y</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(!x.load(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_seq_cst)); </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// a</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(y.load(</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_seq_cst))<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 3</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>++z;<br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>read_y_then_x</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(!y.load(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_seq_cst)); </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// b</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(x.load(</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_seq_cst))<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 4</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>++z;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>自由模型</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(Relaxed ordering)<span lang=ZH-CN>是最弱的模型，它对<b>线程间</b>的执行顺序不做任何</span>synchronizes-with<span
lang=ZH-CN>的假设，但同线程的变量仍然遵循</span>happens-before<span lang=ZH-CN>假设，即它除了禁止重排<b>单线程</b>上对<b>单个变量</b>的访问顺序，并不作任何额外的事情。下面展示的一个</span>C++11<span
lang=ZH-CN>对应的自由模型</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>std::memory_order_relaxed</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的例子，注意在后面的详述中可以看到，由于特定平台的一致性模型要强于自由模型，所以</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::memory_order_relaxed</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>只是保证强于等于自由模型。注意到这时候仍然保证了</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>1<span lang=ZH-CN>先于</span>2<span
lang=ZH-CN>、</span>3<span lang=ZH-CN>先于</span>4<span lang=ZH-CN>，且</span>3<span
lang=ZH-CN>读到</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>true</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>，但是</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>z</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>就可能为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>0<span lang=ZH-CN>了。这是由于</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>x</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>y</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是两个不同变量，自由模型不关注它们之间的关系。关注一下图</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>5.4<span lang=ZH-CN>，我们发现这张图非常反直觉，例如</span>4<span
lang=ZH-CN>步骤还会返回</span>false<span lang=ZH-CN>，这是出于什么机理呢？但是在这之前，先在</span>x86<span
lang=ZH-CN>下的</span>MSVC2015<span lang=ZH-CN>上测试一下，发现</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>z</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>始终不为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>0<span lang=ZH-CN>，这是为什么呢？我在</span>StackOverflow<span
lang=ZH-CN>上</span><a
href="https://stackoverflow.com/questions/48139399/memory-order-relaxed-not-work-as-expected-in-code-from-c-concurrency-in-action?noredirect=1#comment83256917_48139399"
target="_blank"><span lang=ZH-CN style='color:#555555'>提了个问题</span></a><span
lang=ZH-CN>。回答首先指出</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>std::memory_order_relaxed</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的副作用实际上是禁止<b>编译器</b>（注意区分编译器的重排行为和处理器的乱序行为）重排</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>x</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>y</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Store-Store<span
lang=ZH-CN>，但是断言失败还可能由于</span>CPU<span lang=ZH-CN>决定颠倒写</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>x</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和写</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>y</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的顺序（虽然一般不会进行这种乱序），或者</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>的缓存导致了</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>x</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>延迟写入内存。回答接着解释了为什么</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>x86<span lang=ZH-CN>上不会</span>assertion
fail<span lang=ZH-CN>，这是因为</span>x84<span lang=ZH-CN>提供了</span>acquire/release<span
lang=ZH-CN>语义，保证了当</span>3<span lang=ZH-CN>是</span>true<span lang=ZH-CN>时，在</span>2<span
lang=ZH-CN>前的对</span>3<span lang=ZH-CN>后的可见。注意到这个并不违反</span>x86<span
lang=ZH-CN>对</span>Store-Load<span lang=ZH-CN>可能的乱序，它实际上利用了</span>Store-Store<span
lang=ZH-CN>不会乱序的特性。回顾之前的最严格的顺序一致模型，它要求对于每个共享变量，</span>Load-Load<span
lang=ZH-CN>、</span>Load-Store<span lang=ZH-CN>、</span>Store-Load<span
lang=ZH-CN>、</span>Store-Store<span lang=ZH-CN>都不乱序。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::atomic&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>bool</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; x = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>false</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>, y = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>false</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::atomic&lt;</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>int</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>&gt; z = </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>write_x_then_y</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>  </span>x.store(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>,</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_relaxed);<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 1</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span>y.store(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>,</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_relaxed);<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 2</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>read_y_then_x</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(!y.load(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_relaxed));<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 3</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>(x.load(</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_relaxed))<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 4</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>++z;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>acquire/release<span lang=ZH-CN>模型相对灵活一点，也是</span>x86<span
lang=ZH-CN>实现的语义。</span>release<span lang=ZH-CN>可以理解为写操作，</span>acquire<span
lang=ZH-CN>可以理解为读操作。</span>acquire fence<span lang=ZH-CN>要求其后面的</span>RW<span
lang=ZH-CN>不能与其前面的</span>R<span lang=ZH-CN>重排，也就是</span>RW<span lang=ZH-CN>不能重排到（原本在自己前面的）</span>R<span
lang=ZH-CN>前，例如</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>R1 W2</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>不能变成</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>W2 R1</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，否则</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>R1</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>读到的就是脏值的。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>release fence<span
lang=ZH-CN>要求其前面的</span>RW<span lang=ZH-CN>不能和其后面的</span>W<span lang=ZH-CN>重排，也就是</span>RW<span
lang=ZH-CN>不能重排到（原本在自己后面的）</span>W<span lang=ZH-CN>后，例如</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>R1 W2</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>不能重排为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>W2 R1</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，否则</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>R1</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>又脏读。但是这两个模型即使组合起来也不能禁止其前面的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>W<span lang=ZH-CN>和后面的</span>R<span
lang=ZH-CN>重排。</span>C++11<span lang=ZH-CN>使用剩下四个内存模型常数来实现这一机制，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memory_order_release</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memory_order_acquire</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>表示</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>B<span lang=ZH-CN>线程在使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memory_order_acquire</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>读时，线程</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>A<span lang=ZH-CN>在</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memory_order_release</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>前的所有写操作都是可见的。而稍弱一点的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memory_order_release</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memory_order_consume</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>只用来保证当前操作涉及到的对象的可见性。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Store-Load<span lang=ZH-CN>乱序问题</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在前面的讨论中提到了</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>x86<span lang=ZH-CN>的</span>Store-Load<span
lang=ZH-CN>乱序问题，对于</span>x86<span lang=ZH-CN>，</span>Loads May Be Reordered
with Earlier Stores to Different Locations<span lang=ZH-CN>，但</span><a
href="https://software.intel.com/en-us/forums/intel-moderncode-for-parallel-architectures/topic/277126"
target="_blank"><span lang=ZH-CN style='color:#555555'>对于相同地址则不会乱序</span></a><span
lang=ZH-CN>。在</span><a
href="http://dreamrunner.org/blog/2014/06/28/qian-tan-memory-reordering/"
target="_blank"><span lang=ZH-CN style='color:#555555'>这篇博文</span></a><span
lang=ZH-CN>中记录了一个有关</span>Store-Load<span lang=ZH-CN>乱序的实验。在实验中，</span>X<span
lang=ZH-CN>的写操作可能被延迟到</span>Y<span lang=ZH-CN>的读操作之后，尽管我们插入了</span>compiler
barrier<span lang=ZH-CN>。这时候我们需要一个</span>full/general memory barrier<span
lang=ZH-CN>，也就是实现让它前面所有的</span>Load/Store<span lang=ZH-CN>操作对它后面的</span>Load/Store<span
lang=ZH-CN>操作都是可见的，包括了止</span>Store-Load<span lang=ZH-CN>类型的乱序。在同一篇博文中指出可以使用插入一个</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>mfence</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，以实现</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>full/general memory
barrier<span lang=ZH-CN>。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// gcc</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>asm</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>volatile</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>&quot;mfence&quot;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'> ::: </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>&quot;memory&quot;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>)</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// c++11</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// <a
  href="https://stackoverflow.com/questions/25478029/does-atomic-thread-fencememory-order-seq-cst-have-the-semantics-of-a-full-memo"><span
  style='color:#555555'>https://stackoverflow.com/questions/25478029/does-atomic-thread-fencememory-order-seq-cst-have-the-semantics-of-a-full-memo</span></a></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  std::atomic_thread_fence(std::memory_order_seq_cst)<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><a
href="https://stackoverflow.com/questions/39053600/does-standard-c11-guarantee-that-memory-order-seq-cst-prevents-storeload-reord?rq=1"
target="_blank"><span style='color:#555555'>SoF<span lang=ZH-CN>上</span></span></a><span
lang=ZH-CN>指出虽然</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>atomic(seq_cst)</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>atomic(seq_cst)</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>始终不会重排，但是在</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>atomic(seq_cst)</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>附近的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>non-atomic</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>甚至是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>atomic(non-seq_cst)</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>形式的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>STORE-LOAD</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>都会被重排。例如在下面的代码中</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>1<span lang=ZH-CN>和</span>3<span
lang=ZH-CN>的</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>STORE-LOAD</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>肯定不会被重排，但</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>2<span lang=ZH-CN>和</span>3<span
lang=ZH-CN>的</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>STORE-LOAD</span><span lang=ZH-CN style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>就可能被重排，所以一定要注意。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::atomic&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; a, b, c;<br>
  a.store(</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#718C00;mso-ansi-language:EN-HK'>2</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_seq_cst);<span style='mso-spacerun:yes'>         
  </span></span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// 1: movl 2,[a];
  mfence;</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  c.store(</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#718C00;mso-ansi-language:EN-HK'>4</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_release);<span style='mso-spacerun:yes'>     </span><span
  style='mso-spacerun:yes'>     </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// 2: movl 4,[c];</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>int</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> tmp = b.load(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::memory_order_seq_cst);<span
  style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// 3: movl [b],[tmp];</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>因此在</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>x86<span lang=ZH-CN>上至少要对</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>LOAD</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>STORE</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>其中的一个加上</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>MFENCE</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，或者用一个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>LOCK</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>指令，而这也实现了类似</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memory_order_seq_cst</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的效果。在章节内存模型的实现中还有更多说明。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><br>
<span lang=ZH-CN>下面的代码不一定是等价的</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>atomic&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; x, y<br>
  <br>
  y.store(</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#718C00;mso-ansi-language:EN-HK'>1</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, memory_order_relaxed);<span
  style='mso-spacerun:yes'>            </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>//(1)</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  atomic_thread_fence(memory_order_seq_cst);<span style='mso-spacerun:yes'>  
  </span></span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>//(2)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  x.load(memory_order_relaxed);<span style='mso-spacerun:yes'>               
  </span></span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>//(3)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <br>
  atomic&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; x, y;<br>
  y.store(</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#718C00;mso-ansi-language:EN-HK'>1</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, memory_order_seq_cst);<span
  style='mso-spacerun:yes'>            </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>//(1)</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// Nothing</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  x.load(memory_order_seq_cst);<span style='mso-spacerun:yes'>     </span><span
  style='mso-spacerun:yes'>           </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>//(3)</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>fence<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>常见的</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>fence<span lang=ZH-CN>包括</span>thread
fence(memory/CPU barrier)<span lang=ZH-CN>和</span>signal fence(compiler
barrier)<span lang=ZH-CN>。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>signal
fence<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>signal fence<span lang=ZH-CN>类似下面的东西，参考</span><a
href="https://en.wikipedia.org/wiki/Memory_ordering" target="_blank"><span
style='color:#555555'>Wikipedia</span></a><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// gcc</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>asm</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>volatile</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>&quot;&quot;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'> ::: </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>&quot;memory&quot;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>)</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// msvc</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  __MACHINE(</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _ReadWriteBarrier(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>))<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// c++11</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::atomic_signal_fence(memory_order_acq_rel)<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>对于</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>gcc<span lang=ZH-CN>版本，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>asm</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>volatile</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memory</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>三个关键字的作用可以参考</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="https://stackoverflow.com/questions/14950614/working-of-asm-volatile-memory"
target="_blank"><span style='color:#555555'>SoF<span lang=ZH-CN>上的回答</span></span></a><span
lang=ZH-CN>对于</span>MSVC<span lang=ZH-CN>版本，根据</span><a
href="https://msdn.microsoft.com/en-us/library/f20w0x5e.aspx" target="_blank"><span
style='color:#555555'>MSDN</span></a><span lang=ZH-CN>，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>_ReadWriteBarrier</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>限制了编译器可能的重排。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++11<span lang=ZH-CN>标准库中的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::atomic_signal_fence</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>MSVC<span lang=ZH-CN>上也是利用</span>Compiler
Barrier<span lang=ZH-CN>实现的。一个</span>signal fence<span lang=ZH-CN>的</span><a
href="https://stackoverflow.com/questions/18449291/when-is-a-compiler-only-memory-barrier-such-as-stdatomic-signal-fence-useful"
target="_blank"><span lang=ZH-CN style='color:#555555'>作用是</span></a><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l19 level1 lfo15;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>强制单线程和该线程上的异步中断之间的顺序性</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l19 level1 lfo15;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>强制单核上运行的多线程之间的顺序性注意到在</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>SMP<span lang=ZH-CN>架构下这一点难以保证，所以对于多线程程序往往需要更强的</span>thread
     fence<span lang=ZH-CN>。</span><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>thread
fence<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>thread fence<span lang=ZH-CN>也就是所谓的内存屏障，我们可以使用下面的语句进行声明，此外，我们还可以声明一个单独的</span>Store/Load
Barrier<span lang=ZH-CN>。这里补充一下</span>Store Barrier<span lang=ZH-CN>强制所有屏障<b>前</b>的</span>store<span
lang=ZH-CN>指令，都在屏障指令执行之前被执行，并把</span>store<span lang=ZH-CN>缓冲区的数据都刷到主存。</span>Load
Barrier<span lang=ZH-CN>强制所有屏障<b>后</b>的</span>load<span lang=ZH-CN>指令，都在屏障指令执行之后被执行，并且一直等到</span>load<span
lang=ZH-CN>缓冲区被该</span>CPU<span lang=ZH-CN>读完才能执行之后的</span>load<span
lang=ZH-CN>指令。而一个</span>full barrier<span lang=ZH-CN>兼而有之。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// x86</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>asm</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>volatile</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>&quot;mfence&quot;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>:::</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>&quot;memory&quot;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>)</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// gcc</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4271AE;mso-ansi-language:EN-HK'>__sync_synchronize</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// msvc</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>MemoryBarrier</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// c++11</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  std::atomic_thread_fence(memory_order_seq_cst)<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// other methods</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  _mm_mfence<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>我们需要注意的是内存屏障是相当耗时的操作，甚至还要超过原子操作，内存屏障还会干扰</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CPU<span lang=ZH-CN>的流水线，导致性能的降低。下面我们查看一下标准库</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>atomic_thread_fence</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数的实现</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// MSVC</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>inline</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> _Atomic_thread_fence(memory_order _Order)<br>
  <span style='mso-spacerun:yes'>    </span>{<span style='mso-spacerun:yes'>  
  </span></span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>/* force memory
  visibility and inhibit compiler reordering */</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#if defined(_M_ARM) || defined(_M_ARM64)</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (_Order != memory_order_relaxed)<br>
  <span style='mso-spacerun:yes'>        </span>{<br>
  <span style='mso-spacerun:yes'>        </span>_Memory_barrier();<br>
  <span style='mso-spacerun:yes'>        </span>}<br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#else</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>_Compiler_barrier();<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (_Order == memory_order_seq_cst)<br>
  <span style='mso-spacerun:yes'>        </span>{<span
  style='mso-spacerun:yes'>   </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>/* force visibility */</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>static</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> _Uint4_t _Guard;<br>
  <span style='mso-spacerun:yes'>        </span>_Atomic_exchange_4(&amp;_Guard,
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#718C00;mso-ansi-language:EN-HK'>0</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>, memory_order_seq_cst);<br>
  <span style='mso-spacerun:yes'>        </span>_Compiler_barrier();<br>
  <span style='mso-spacerun:yes'>        </span>}<br>
  <span style='mso-spacerun:yes'> </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>#endif</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// GCC</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>inline</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>void</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  atomic_thread_fence(memory_order __m) </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>noexcept</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  { __atomic_thread_fence(__m); }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>可以发现由于</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>x86<span lang=ZH-CN>自带的</span>acquire/release<span
lang=ZH-CN>语义，除非是最强的</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>memory_order_seq_cst</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，否则</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>atomic_thread_fence</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等价于</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>atomic_signal_fence</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。而</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>memory_order_seq_cst</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>下的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>thread fence<span
lang=ZH-CN>的</span>full barrier<span lang=ZH-CN>实现则比较奇特，仔细查看这个</span>full
barrier<span lang=ZH-CN>的实现这里为啥不直接插入一个</span></span><span style='font-size:
10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>MemoryBarrier()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，而是利用了一个原子操作呢？</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>内存模型的实现</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>六种内存模型通过加入</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Compiler Barrier<span lang=ZH-CN>和</span>Memory
Barrier<span lang=ZH-CN>来实现。在</span><a
href="https://stackoverflow.com/questions/7461484/memory-model-ordering-and-visibility"
target="_blank"><span style='color:#555555'>SoF<span lang=ZH-CN>中指出</span></span></a>acquire/release<span
lang=ZH-CN>相当于在</span>relax<span lang=ZH-CN>后面加一道栅栏，即下面的代码是等价的。但如果不显式加入</span>fence<span
lang=ZH-CN>的话，编译器可以视情况生成等价的更好的代码。而在</span>x86<span lang=ZH-CN>等强内存模型架构</span>cpu<span
lang=ZH-CN>上，也不一定生成</span>fence<span lang=ZH-CN>，例如单独的</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>atomic_thread_fence(memory_order_acquire)</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>就可以简化为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>nop<span lang=ZH-CN>。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// 1</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  a.load(memory_order_acquire)<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// 2</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  a.load(memory_order_relaxed)<br>
  atomic_thread_fence(memory_order_acquire)<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>而</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>memory_order_seq_cst</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>则需要额外的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>MFENCE</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>或者</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>LOCK</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，可参考上节所述。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="https://stackoverflow.com/questions/42450342/whats-the-difference-between-atomic-store-and-atomic-thread-fence"
target="_blank"><span lang=ZH-CN style='color:#555555'>下面的代码</span></a><span
lang=ZH-CN>是等价的</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>if</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (var.load(</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_acquire) == </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>)<br>
  {<br>
  <span style='mso-spacerun:yes'>    </span>assert(a==</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>123</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>);<br>
  }<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>if</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> (var.load(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::memory_order_relaxed) == </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>0</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>)<br>
  {<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::atomic_thread_fence(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_acquire);<br>
  <span style='mso-spacerun:yes'>    </span>assert(a==</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>123</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>);<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>使用内存模型解决双重检查锁定模式</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(DCLP)<span
lang=ZH-CN>存在的问题</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在之前的章节中，我们曾经提到过双重检查锁定模式中存在的问题，对此文章</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="http://preshing.com/20130930/double-checked-locking-is-fixed-in-cpp11/"
target="_blank"><span style='color:#555555'>Double-Checked Locking is Fixed In
C++11</span></a><span lang=ZH-CN>指出我们可以通过适当的内存屏障或者</span>atomic store/load<span
lang=ZH-CN>语义来解决。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::atomic&lt;Singleton*&gt; Singleton::m_instance;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::mutex Singleton::m_mutex;<br>
  <br>
  Singleton* Singleton::getInstance() {<br>
  <span style='mso-spacerun:yes'>    </span>Singleton* tmp = m_instance.load(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::memory_order_relaxed);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::atomic_thread_fence(</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::memory_order_acquire);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (tmp == </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>nullptr</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>) {<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::lock_guard&lt;</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lock(m_mutex);<br>
  <span style='mso-spacerun:yes'>        </span>tmp = m_instance.load(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::memory_order_relaxed);<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (tmp == </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>nullptr</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>) {<br>
  <span style='mso-spacerun:yes'>            </span>tmp = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>new</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> Singleton;<br>
  <span style='mso-spacerun:yes'>            </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::atomic_thread_fence(</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::memory_order_release);<br>
  <span style='mso-spacerun:yes'>            </span>m_instance.store(tmp, </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::memory_order_relaxed);<br>
  <span style='mso-spacerun:yes'>        </span>}<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> tmp;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=EN-GB><a
href="http://www.calvinneo.com/img/bfbc/dclpjj.png"><span lang=EN-US
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK;mso-no-proof:yes;
text-decoration:none;text-underline:none'><!--[if gte vml 1]><v:shape id="Picture_x0020_1"
 o:spid="_x0000_i1025" type="#_x0000_t75" alt="http://www.calvinneo.com/img/bfbc/dclpjj.png"
 href="http://www.calvinneo.com/img/bfbc/dclpjj.png" style='width:451pt;
 height:233pt;visibility:visible;mso-wrap-style:square' o:button="t">
 <v:imagedata src="并发编程重要概念及比较.fld/image010.png" o:title="dclpjj"/>
</v:shape><![endif]--><![if !vml]><span style='mso-ignore:vglayout'><img
border=0 width=451 height=233 src="并发编程重要概念及比较.fld/image010.png"
alt="http://www.calvinneo.com/img/bfbc/dclpjj.png" v:shapes="Picture_x0020_1"></span><![endif]></span></a></span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::atomic&lt;Singleton*&gt; Singleton::m_instance;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::mutex Singleton::m_mutex;<br>
  <br>
  Singleton* Singleton::getInstance() {<br>
  <span style='mso-spacerun:yes'>    </span>Singleton* tmp = m_instance.load();<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> (tmp == </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>nullptr</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>) {<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::lock_guard&lt;</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lock(m_mutex);<br>
  <span style='mso-spacerun:yes'>        </span>tmp = m_instance.load();<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (tmp == </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>nullptr</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>) {<br>
  <span style='mso-spacerun:yes'>            </span>tmp = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>new</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> Singleton;<br>
  <span style='mso-spacerun:yes'>            </span>m_instance.store(tmp);<br>
  <span style='mso-spacerun:yes'>        </span>}<br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>return</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> tmp;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>无等待</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>无等待</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(Wait-Free)<span lang=ZH-CN>是比锁无关更高层面的并发。无等待指的是程序中的每个线程都可以一直运行下去而不阻塞。</span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;text-justify:inter-ideograph;
mso-outline-level:1;background:white'><b><span lang=ZH-CN style='font-size:
16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'>多线程并发模型</span></b><b><span
style='font-size:16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在本章节中将讨论多线程编程中变量共享与消息传递机制。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>条件变量</span></b><b><span
style='font-size:15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Condition Variable<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CV<span lang=ZH-CN>和</span>mutex<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>锁</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>lock_guard</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>unique_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>能够保证线程之间的互斥访问临界资源，但是不能控制这些访问的先后顺序。自然而然地可以想到可以用锁维护一个共享变量记录状态，以实现线程间同步的措施，例如在生产者</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>消费者模型中用它来描述产品数量。一个比较</span>naive<span
lang=ZH-CN>的方式是轮询</span>(poll)<span lang=ZH-CN>，注意在实现时仍然是需要锁的，否则可能两个互相竞争的线程同时获得</span>flag<span
lang=ZH-CN>。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>bool</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'> flag;<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::mutex m;<br>
  <br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>wait_for_flag</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::unique_lock&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; lk(m);<br>
  <span style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>(!flag)<br>
  <span style='mso-spacerun:yes'>  </span>{<br>
  <span style='mso-spacerun:yes'>    </span>lk.unlock();<span
  style='mso-spacerun:yes'>  </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// 1 </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>解锁互斥量</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::this_thread::sleep_for(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::chrono::milliseconds(</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;
  mso-ansi-language:EN-HK'>100</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>));<span style='mso-spacerun:yes'>  </span></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 2 </span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>休眠</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>100ms</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>lk.lock();<span
  style='mso-spacerun:yes'>   </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// 3 </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>再锁互斥量</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>  </span>}<br>
  <span style='mso-spacerun:yes'>  </span>flag = </span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>false</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>另一种更好的方法是利用条件变量，条件变量</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>(condition variable)<span
lang=ZH-CN>是利用共享的变量进行线程之间同步的一种机制。条件变量维护一个等待列表，相对于前面的轮询，条件变量应用了推的机制，当某一个线程所需要的条件不满足时，它会被阻塞。拥有锁的线程在退出临界区时使用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>notify_one</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>notify_all</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>发出信号通知条件变量，条件变量会唤醒一个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>所有正在等待的线程。使用条件变量等待事件通常是类似下面的形式，容易发现期间需要解锁，所以这里只能用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>unique_lock</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>而不能用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>lock_guard</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<br>
  12<br>
  13<br>
  14<br>
  15<br>
  16<br>
  17<br>
  18<br>
  19<br>
  20<br>
  21<br>
  22<br>
  23<br>
  24<br>
  25<br>
  26<br>
  27<br>
  28<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>void</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>wait_for_event</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::unique_lock&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; uni_lock(mtx);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> (!condition)<br>
  <span style='mso-spacerun:yes'>    </span>{<br>
  <span style='mso-spacerun:yes'>   </span><span
  style='mso-spacerun:yes'>     </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>调用</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>wait</span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>后发生的操作</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>:</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 1. </span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>将线程挂到等待队列上</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 2. </span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>释放锁</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>(</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>前面说过带着锁睡觉会死锁</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>)</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// 3. </span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>进入睡眠阻塞线程</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span>cv.wait(uni_lock, [](){</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>return</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> condition;}); </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// wait until condition</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// wait</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>返回时会重新获得锁</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>}<br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>signal_event</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::unique_lock&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; uni_lock(mtx);<br>
  <span style='mso-spacerun:yes'>    </span>condition = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'>    </span>cv.notify_one();<br>
  }<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>void</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>broadcast_event</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::unique_lock&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::mutex&gt; uni_lock(mtx);<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>在</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>notify</span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>前需要在锁保护下修改</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>condition</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>condition = </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>true</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>;<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>理论上</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>notify</span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>的时候不一定要拥有锁，但是性能上可能差一点</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN style='font-size:10.0pt;
  font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:"Microsoft YaHei";
  color:#8E908C;mso-ansi-language:EN-HK'>原因是</span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8E908C;
  mso-ansi-language:EN-HK'><a
  href="https://stackoverflow.com/questions/4544234/calling-pthread-cond-signal-without-locking-mutex"><span
  style='color:#555555'>https://stackoverflow.com/questions/4544234/calling-pthread-cond-signal-without-locking-mutex</span></a></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span>cv.notify_all();<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>下面我们回答两个问题：</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol style='margin-top:0cm' start=1 type=1>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l18 level1 lfo16;tab-stops:
     list 36.0pt;background:white'><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>为什么使用</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>mutex<span lang=ZH-CN>的时候要</span>CV<span
     lang=ZH-CN>我认为这是因为从逻辑上来讲，</span>CV<span lang=ZH-CN>提供了一种新的同步原语。如果我们使用</span>mutex<span
     lang=ZH-CN>来进行同步，其实也是可以的。如下面代码所示，我们两个线程竞争一个</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>mut</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>，以类似轮询的方式来获得同步，不仅很耗资源，而且从逻辑上不够整齐。而</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>CV<span lang=ZH-CN>把</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>consumer</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>的轮询变成了阻塞</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>wait<span lang=ZH-CN>，以</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>provider</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>的通知</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>notify<span lang=ZH-CN>来唤醒，节省了资源，从逻辑上也有了一个完整过程的抽象。</span><o:p></o:p></span></li>
</ol>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;margin-left:36.0pt;border-collapse:collapse;mso-yfti-tbllook:
 1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<br>
  8<br>
  9<br>
  10<br>
  11<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>def</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>provider</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>(mut)</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'>:</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>:<br>
  <span style='mso-spacerun:yes'>        </span>lock(mut)<br>
  <span style='mso-spacerun:yes'>        </span>count++<br>
  <span style='mso-spacerun:yes'>        </span>unlock(mut)<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>def</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4271AE;mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#3E999F;
  mso-ansi-language:EN-HK'>consumer</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>(mut)</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4271AE;
  mso-ansi-language:EN-HK'>:</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;
  mso-ansi-language:EN-HK'>while</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#718C00;mso-ansi-language:
  EN-HK'>1</span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>:<br>
  <span style='mso-spacerun:yes'>        </span>lock(mut)<br>
  <span style='mso-spacerun:yes'>        </span></span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8959A8;mso-ansi-language:EN-HK'>if</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'> count:<br>
  <span style='mso-spacerun:yes'>            </span>count--<br>
  <span style='mso-spacerun:yes'>        </span>unlock(mut)<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<ol style='margin-top:0cm' start=2 type=1>
 <li class=MsoNormal style='color:#555555;margin-bottom:18.75pt;text-align:
     justify;text-justify:inter-ideograph;mso-list:l18 level1 lfo16;tab-stops:
     list 36.0pt;background:white'><span lang=ZH-CN style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>为什么使用</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>CV<span lang=ZH-CN>的时候要</span>mutex<span
     lang=ZH-CN>首先我们看</span>signal<span lang=ZH-CN>的源码，我们修改了维护的</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>condition</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>，然后</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>notify<span lang=ZH-CN>。我们知道</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>condition</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>是一个临界变量，所以必须要用锁来保护。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:18.75pt;
margin-left:36.0pt;text-align:justify;text-justify:inter-ideograph;background:
white'><span lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>另一个原因是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>cv.wait</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>对应的一系列步骤必须</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="http://blog.csdn.net/ysu108/article/details/49508205" target="_blank"><span
lang=ZH-CN style='color:#555555'>要是原子的</span></a><span lang=ZH-CN>，否则会造成丢失</span>signal<span
lang=ZH-CN>的问题。例如当条件满足</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>!condition</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>时程序应当<b>释放锁并阻塞在</b></span><b><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>CV<span lang=ZH-CN>上进入睡眠</span></span></b><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这个过程<b>必须是原子的</b>。我们考虑在释放锁之后另一个线程上的一个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>signal<span
lang=ZH-CN>获得了锁，并发送了</span>signal<span lang=ZH-CN>，但此时本线程上还没有来得及阻塞在</span>CV<span
lang=ZH-CN>上，这个信号就不能被本线程收到了。这一现象广泛出现在使用边缘触发</span>(Edge triggered)<span
lang=ZH-CN>机制的程序中，例如</span>Linux<span lang=ZH-CN>的信号（</span>Linux<span
lang=ZH-CN>的信号属于一种边缘触发），</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>pthread_cond_</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>系列也是边缘触发。相对于水平触发，边缘触发只会唤醒已经等待在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>wait<span lang=ZH-CN>上的线程，因此可能出现丢失信号的问题，例如当</span>notify<span
lang=ZH-CN>操作早于</span>wait<span lang=ZH-CN>操作时，这个</span>notify<span lang=ZH-CN>就会丢失了。注意到上面的实现中，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>cv.notify_one</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>cv.notify_all</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数始终是出现在修改</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>condition</span><b><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>之后</span></b><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的，这也是为了保证当睡眠线程在收到信号后能够及时观察到条件满足了。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>关于使用</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CV<span lang=ZH-CN>时使用锁的错误用法</span><a
href="http://www.cppblog.com/Solstice/archive/2015/10/30/203094.html"
target="_blank"><span lang=ZH-CN style='color:#555555'>在陈硕大牛的博客中</span></a><span
lang=ZH-CN>还指出了更多的例子。例如</span><a
href="https://stackoverflow.com/questions/4544234/calling-pthread-cond-signal-without-locking-mutex"
target="_blank"><span lang=ZH-CN style='color:#555555'>不为</span><span
style='color:#555555'>signal<span lang=ZH-CN>部分上锁是错误的</span></span></a><span
lang=ZH-CN>，因为可能在</span>wait<span lang=ZH-CN>部分在检测到</span>condition<span
lang=ZH-CN>不满足准备</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>pthread_cond_wait</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>睡眠前，另一个线程修改</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>condition</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pthread_cond_signal</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这样进入</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pthread_cond_wait</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>wait<span lang=ZH-CN>部分代码就会丢失这次的</span>signal<span
lang=ZH-CN>，如下代码所示。所以我们在</span>signal<span lang=ZH-CN>部分加锁的目的是为了确保自己现在可以</span>signal<span
lang=ZH-CN>。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
15.0pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>Process
A<span style='mso-spacerun:yes'>                             </span>Process B<o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
15.0pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
15.0pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>pthread_mutex_lock(&amp;mutex);<o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
15.0pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>while
(condition == FALSE)<o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
15.0pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
15.0pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><span
style='mso-spacerun:yes'>                                      </span>condition
= TRUE;<o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
15.0pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><span
style='mso-spacerun:yes'>                                     
</span>pthread_cond_signal(&amp;cond);<o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
15.0pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
15.0pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:EN-HK'>pthread_cond_wait(&amp;cond,
&amp;mutex);<o:p></o:p></span></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>不过即使为</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>signal<span lang=ZH-CN>部分上锁还可能丢失信号。原因是生产者和消费者竞争同一把锁虽然能够保证</span>wait<span
lang=ZH-CN>和</span>signal<span lang=ZH-CN>是串行的顺序，但可能整个</span>signal<span
lang=ZH-CN>过程都在</span>wait<span lang=ZH-CN>过程前面。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>虚假唤醒</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>使用条件变量时可能发生虚假唤醒</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>伪唤醒</span>(spurious
wakeup)<span lang=ZH-CN>的问题，虚假唤醒指的是被</span>wait<span lang=ZH-CN>中阻塞的线程在没有</span>notify<span
lang=ZH-CN>的情况下被唤醒，或者一次</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>notify_one</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>唤醒多个线程（惊群效应）。虚假唤醒可能发生在多处理器系统和<b>接收</b></span><b><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>信号</span></span></b><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>时，条件变量设计者出于性能因素容忍了虚假唤醒的存在。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>APUE<span lang=ZH-CN>指出</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>pthread_cond_signal</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>函数可能唤起多个线程。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="https://stackoverflow.com/questions/1050592/do-spurious-wakeups-actually-happen"
target="_blank"><span style='color:#555555'>SoF</span></a><span lang=ZH-CN>中指出，当等待队列中的</span>Linux<span
lang=ZH-CN>线程收到一个系统信号时，会得到虚假唤醒。在</span><a
href="https://stackoverflow.com/questions/1461913/does-c-sharp-monitor-wait-suffer-from-spurious-wakeups/1461956#1461956"
target="_blank"><span lang=ZH-CN style='color:#555555'>另一个回答</span></a><span
lang=ZH-CN>中，</span>Jon Skeet<span lang=ZH-CN>大神指出其深层次原因是没有任何的保障是一个被唤醒</span>(awakened)<span
lang=ZH-CN>的线程一定会被调度</span>(scheduled)<span lang=ZH-CN>，很可能当一个等待队列中的线程被唤醒后准备获得锁时，另一个线程已经捷足先登了获得了锁，并且重置了条件</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>condition</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的值。但注意，即使是虚假唤醒的情况，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>cv.wait</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>也是<b>在获得锁之后再返回</b>，但这时候条件</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>condition</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>可能已经不满足了，这时候就出现了虚假唤醒。解决虚假唤醒的方案很简单，如上文</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>wait_for_event</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>所示，可以将</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>wait<span lang=ZH-CN>包裹在一个</span>while<span
lang=ZH-CN>循环里面。在</span><a href="https://segmentfault.com/q/1010000010421523"
target="_blank"><span style='color:#555555'>SF</span></a><span lang=ZH-CN>上记录了一番实验，强行产生虚假唤醒。</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>con_var.notify_one();<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// trigger the
  spurious wakeup</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'><br>
  lock.unlock();<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::this_thread::sleep_for(</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::chrono::seconds(</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#718C00;mso-ansi-language:EN-HK'>2</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>));<br>
  condition = </span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>true</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>;<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>可以发现在</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>notify<span lang=ZH-CN>和</span>unlock<span
lang=ZH-CN>两个过程之后的两秒内消费者线程已经被唤醒了，但在拿到锁和条件变量后它发现其实</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>condition</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>值并不为</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>true</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，这就产生了一次虚假唤醒。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><br>
<span lang=ZH-CN>在使用</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>notify_all()</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>唤醒时需要注意惊群问题，如果我们只需要唤醒任意一个线程，那么</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>notify_one()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>就行了，但是如果我们希望唤起特定的几个，或者我们不清楚需要唤醒几个，就得使用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>notify_all()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>唤醒全部。前者的情况类似于</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>accept</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，当多个线程的套接口</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>listen<span
lang=ZH-CN>同一个</span>fd<span lang=ZH-CN>时，内核只</span>notify<span lang=ZH-CN>等待队列最顶部的套接口。后者的情况类似</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>epoll</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，内核不知道究竟有多少个线程需要被唤醒。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>信号量的实现</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>POSIX<span lang=ZH-CN>和</span>Linux<span
lang=ZH-CN>中分别提供了两种信号量的实现方式。其实我们也可以方便地通过</span>mutex+cv+counter<span
lang=ZH-CN>来实现信号量。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>事件</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>Windows<span lang=ZH-CN>内核编程中出现了事件，可以用来替代条件变量的使用。相比使用条件变量显式等待，事件机制将这个</span><b>wait</b><span
lang=ZH-CN>前置，将处理函数直接</span><b>register</b><span lang=ZH-CN>给一个代理，当需要</span><b>notify</b><span
lang=ZH-CN>时，代理会直接调用这个处理函数。实际上事件机制更类似于对回调的一种封装，能够更好地实现模块化和组件化。事件机制减少了阻塞，因此能更好地服务于异步编程。事件和回调有什么区别？</span><a
href="https://stackoverflow.com/questions/36213948/what-is-the-difference-between-asynchronous-calls-and-callbacks"
target="_blank"><span lang=ZH-CN style='color:#555555'>回调不一定是异步的</span></a><span
lang=ZH-CN>。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>基于线程的异步调用</span></b><b><span
style='font-size:15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是实现并行最简单的方式了，不过在使用时我们要注意一下几点：</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l8 level1 lfo17;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>分清</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>对象和实际线程一个实际的例子是</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>detach<span lang=ZH-CN>之后的</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>对象销毁后线程并不会结束，反而是</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>*this</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>不在</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><a
     href="https://en.cppreference.com/w/cpp/thread/thread/detach"
     target="_blank"><span lang=ZH-CN style='color:#555555'>指向任何线程</span></a><span
     lang=ZH-CN>。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l8 level1 lfo17;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>区分</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>对象和线程实体线程实体是由操作系统管理的，它不等同于</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>对象。特别地，</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>的生命周期是不同于线程实体的。当主线程退出时所有的子线程释放，或者当子线程执行完毕时子线程释放。而</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>对象遵所有</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>对象的生命周期。</span></span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>是由程序员管理生命周期的，程序员应当在</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>join()</span><span lang=ZH-CN
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>或者</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>detach()</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>后释放</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>。程序员可以通过</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>控制线程实体。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><br>
     <span lang=ZH-CN>一个简单的场景是</span></span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>std::thread::detach()</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>之后，线程就和</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>无关了，此时</span><span
     style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
     background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
     lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
     mso-bidi-font-family:"Times New Roman";mso-ansi-language:EN-HK'>对象即使析构也无碍于线程实体。试图从主线程</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>fire<span lang=ZH-CN>掉子线程</span><a
     href="https://stackoverflow.com/questions/23454793/whats-the-c-11-way-to-fire-off-an-asynchronous-task-and-forget-about-it"
     target="_blank"><span lang=ZH-CN style='color:#555555'>一个坏主意</span></a><span
     lang=ZH-CN>。如果我们希望某个线程的生命周期等同于某个对象，那么我们可以在该线程的</span>loop<span lang=ZH-CN>里面去跟踪一个</span>flag<span
     lang=ZH-CN>，这个</span>flag<span lang=ZH-CN>可以是全局变量，也可以作为参数传入或者直接捕获。当对象需要析构时，我们设置这个</span>flag<span
     lang=ZH-CN>使得线程内部的</span>loop<span lang=ZH-CN>检测并最终退出，此时只要在析构函数中</span>join<span
     lang=ZH-CN>这个线程即可。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l8 level1 lfo17;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>注意线程带来的开销因此我们需要线程池。</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>线程池</span></b><b><span style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>线程池的产生是为了解决维护线程生命周期所带来的开销的问题，同时节约操作系统资源。一个线程池维护多个线程，当任务到来时在池中取出一个线程来执行这个任务。线程池可以动态地进行扩展。一般对于</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>IO<span lang=ZH-CN>型的任务，我们维护线程池在</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>2x</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>或者</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>2x+2</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的规模，而对于计算型的任务，盲目加线程是不正确的。甚至对于一些</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>HT<span lang=ZH-CN>超线程的架构线程还要少一点会更好。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>std::thread<span
lang=ZH-CN>实现是否应当实现</span>pooling<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><a
href="https://stackoverflow.com/questions/12993451/c11-stdthread-pooled"
target="_blank"><span style='color:#555555'>SoF<span lang=ZH-CN>上有相关的讨论</span></span></a><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span lang=ZH-CN style='font-size:
13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>工作队列</span></b><b><span
style='font-size:13.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>/<span lang=ZH-CN>任务队列</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>注意这里并不是特指</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Linux<span lang=ZH-CN>中的特定数据结构，而是指一种通用的编程概念。工作队列</span>(work
queue)/<span lang=ZH-CN>任务队列</span>(task queue)<span lang=ZH-CN>维护一组工作线程，调用者将异步任务注册到工作队列中，工作线程竞争运行这些异步任务。由此看到工作队列的实现依赖一个线程安全的队列，我们可以通过使用</span>CV<span
lang=ZH-CN>做一个简单的生产者消费者的模式来实现。使用工作队列需要</span><a
href="https://www.ibm.com/developerworks/cn/java/j-jtp0730/index.html"
target="_blank"><span lang=ZH-CN style='color:#555555'>注意的方面</span></a><span
lang=ZH-CN>：</span><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l17 level1 lfo18;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>死锁</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>/<span lang=ZH-CN>优先级反转例如所有正在执行的任务都阻塞等待锁</span>A<span
     lang=ZH-CN>，但持有锁</span>A<span lang=ZH-CN>的任务却因为没有空余的线程而在队列中空等。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l17 level1 lfo18;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>线程泄露例如在异步任务中触发了异常，那么控制流就可能跳出</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'>loop<span lang=ZH-CN>循环，导致该线程无法参与到后面的计算任务中。</span><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l17 level1 lfo18;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>过载</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span lang=ZH-CN style='font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>概念比较</span></b><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l20 level1 lfo19;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>与线程池相比线程池存在一些显著缺点，例如当主线程希望取得一个空闲进程执行异步任务，线程池中可用线程为空的时候，此时无论是扩展线程池加入新线程或者等待某一个线程执行完任务重新变为空闲，都会导致主线程的阻塞。而工作队列能够避免这样的问题。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l20 level1 lfo19;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>与</span><span style='font-size:10.5pt;font-family:
     "PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>future<span lang=ZH-CN>相比工作队列解决<b>一系列</b>的异步计算问题，相比</span>future<span
     lang=ZH-CN>，工作队列需要额外考虑任务的调度、负载均衡等问题。在一定程度上它可以被视作</span>future.then<span
     lang=ZH-CN>的迭代版。</span><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>基于</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>future<span lang=ZH-CN>和</span>shared_future<span
lang=ZH-CN>的异步调用</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>条件变量</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Condition Variable<span lang=ZH-CN>的一个重要的应用就是生产者</span>/<span
lang=ZH-CN>消费者模型，但对于一些平凡的情况，消费者只等待<b>一次</b></span><b>(one-off)</b><span
lang=ZH-CN>来自生产者的结果。一个最简单的做法是启动一个计算线程（或者从线程池中取出一个线程）并<b>异步获取</b>它的结果，不过</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>不能直接提供获取返回值的方法，此时可以考虑使用全局变量、传入指针、回调函数这些做法。容易发现这种方案是完全异步的。另一个较为方便的做法是使用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来获取异步任务中的结果。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>future<span
lang=ZH-CN>是异步编程中一个非常通用的概念，在</span>C++<span lang=ZH-CN>中被实现为</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Python3<span
lang=ZH-CN>中被实现为</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>concurrent.future</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>通常是下面提到的</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>async</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>promise</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等异步机制<b>返回给主线程</b>的一个句柄。在启动这个异步任务后，当我们需要用到结果时，可以通过</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>future::get()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来获取。此时如果异步任务已经完成，则该函数立即返回，否则主线程会阻塞在</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>future::get()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>上。这可以理解为主线程在等待异步线程的</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>join<span lang=ZH-CN>。特别地，</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>也可以调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>wait()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>wait_for(const
chrono::duration&lt;Rep,Period&gt;&amp; rel_time)</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等函数进行主动等待，这些函数会返回三种状态，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>future_status::ready</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>表就绪，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>future_status::timeout</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>表超时，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>future_status::deferred</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>表示这个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>future<span
lang=ZH-CN>对应一个</span>deferred function<span lang=ZH-CN>，此时我们还没有执行这个异步任务，我们将在下节进行详细说明。需要注意的是，当多个线程访问</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>时，要锁来保护线程安全。不过我们应当尽量避免这种用法，因为</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>中还提供了</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，相比</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，它是可以复制的。这也意味着它的结果可以被多次</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>get<span lang=ZH-CN>，而多个线程可以通过一个</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来跟踪异步任务的结果。需要注意的是，为了保证线程安全，我们需要对每个线程维护一份</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::shared_future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，而每个线程仅仅可以操作自己的一份。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>async<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>如下面代码所示，</span><span style='font-size:
10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>常和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::async</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>一并使用。容易看到，它类似于</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Python<span
lang=ZH-CN>中的</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>subprocess.call</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，是个高层面的封装。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4271AE;mso-ansi-language:
  EN-HK'> </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#3E999F;mso-ansi-language:EN-HK'>main</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>()</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'><br>
  {<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::future&lt;</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&gt; the_answer = </span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::async(get_integer());<br>
  <span style='mso-spacerun:yes'>    </span>do_other_stuff();<br>
  <span style='mso-spacerun:yes'>    </span></span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>cout</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>&lt;&lt; the_answer.get() &lt;&lt; </span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#F5871F;
  mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>endl</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>;<br>
  }<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>这里面的</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>std::async</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>用来实现一次异步调用。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::async</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是一个模板<b>函数</b>，它可以接受一个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::launch</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>类型的参数，其中使用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::launch::defered</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>表示异步调用是个</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>deferred function<span
lang=ZH-CN>，它将延迟到</span></span><span style='font-size:10.0pt;font-family:consolas;
mso-fareast-font-family:"Times New Roman";color:#555555;background:#EEEEEE;
mso-ansi-language:EN-HK'>.wait()</span><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>或</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>.get()</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>再执行。而</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::launch::async</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>表示在一个独立线程中运行。默认是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::launch::defered
| std::launch::async</span><span lang=ZH-CN style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>表示这两个二选一。</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>std::async</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>能够接受函数指针、函数对象（的左值、右值。引用和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::ref</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>），也能够通过类似</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::bind</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>一样的机制以引用、</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::ref</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等方式传入对象的上下文。需要注意的是</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::async</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>不能被简单地当做</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>来使用。例如我们可能不关注其返回值，但此时这个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>的析构</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><a
href="https://zh.cppreference.com/w/cpp/thread/async" target="_blank"><span
lang=ZH-CN style='color:#555555'>仍然会</span><b><span lang=ZH-CN
style='color:#555555;text-decoration:none;text-underline:none'>阻塞</span></b><span
lang=ZH-CN style='color:#555555'>到异步操作结束</span></a><span lang=ZH-CN>。因此我们希望它将返回值通过回调的方式传出去的理想并不能实现（实际上这个可以通过</span>future.then<span
lang=ZH-CN>实现）。如下面代码所示：</span><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#8E908C;mso-ansi-language:
  EN-HK'>// <a href="https://zh.cppreference.com/w/cpp/thread/async"><span
  style='color:#555555'>https://zh.cppreference.com/w/cpp/thread/async</span></a></span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::async(</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::launch::async, []{ f(); }); </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// </span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>临时量的析构函数等待</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'> f()</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#F5871F;mso-ansi-language:EN-HK'>std</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'>::async(</span><span style='font-size:
  10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#F5871F;mso-ansi-language:EN-HK'>std</span><span style='font-size:10.0pt;
  font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#4D4D4C;
  mso-ansi-language:EN-HK'>::launch::async, []{ g(); }); </span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>// f() </span><span lang=ZH-CN
  style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;mso-bidi-font-family:
  "Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>完成前不开始</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>SoF<span lang=ZH-CN>中也提到这是一个</span><a
href="https://stackoverflow.com/questions/23455104/why-is-the-destructor-of-a-future-returned-from-stdasync-blocking"
target="_blank"><span lang=ZH-CN style='color:#555555'>争议问题</span></a><span
lang=ZH-CN>，</span><a
href="https://stackoverflow.com/questions/18143661/what-is-the-difference-between-packaged-task-and-async"
target="_blank"><span lang=ZH-CN style='color:#555555'>但至少在</span><span
style='color:#555555'>C++11<span lang=ZH-CN>中，</span>future<span lang=ZH-CN>的析构函数可能会阻塞线程</span></span></a><span
lang=ZH-CN>。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:4;background:white'><b><span lang=ZH-CN style='font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>优先使用</span></b><b><span style='font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>async<span
lang=ZH-CN>等机制替代裸线程</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>相比裸线程，</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>async<b><span lang=ZH-CN>隐藏了底层的细节</span></b><span
lang=ZH-CN>，从而我们可以更关注于<b>异步逻辑</b>。例如它可以帮我们视情况<b>使用线程池进行优化</b></span><b>(pooling)</b><span
lang=ZH-CN>等。此外，裸线程还存在</span><a href="http://callbackhell.com/" target="_blank"><span
lang=ZH-CN style='color:#555555'>回调地狱</span><span style='color:#555555'>(callback
hell)</span></a><span lang=ZH-CN>的缺点，使用</span>async<span lang=ZH-CN>或者后面提到的</span>future.then<span
lang=ZH-CN>甚至</span>co_wait<span lang=ZH-CN>等机制能够让代码更加平展。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>packaged_task<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>不同于</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>std::async</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::packaged_task</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>是个函数对象，这个函数对象有点类似</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::function</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>（但</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::function</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>还能够复制构造），因此</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::packaged_task</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>需要手动调用以运行。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0
 style='width:0cm;border-collapse:collapse;mso-yfti-tbllook:1184'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes'>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal align=right style='text-align:right;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#EFF2F3'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#869194;mso-ansi-language:
  EN-HK'>1<br>
  2<br>
  3<br>
  4<br>
  5<br>
  6<br>
  7<o:p></o:p></span></p>
  </td>
  <td style='background:#F9F9F9;padding:0cm 0cm 0cm 0cm'>
  <p class=MsoNormal style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
  background:#F7F7F7'><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#F5871F;mso-ansi-language:
  EN-HK'>std</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>::packaged_task&lt;</span><span style='font-size:10.0pt;font-family:
  consolas;mso-fareast-font-family:"Times New Roman";color:#8959A8;mso-ansi-language:
  EN-HK'>int</span><span style='font-size:10.0pt;font-family:consolas;
  mso-fareast-font-family:"Times New Roman";color:#4D4D4C;mso-ansi-language:
  EN-HK'>()&gt; task(sleep);<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8959A8;mso-ansi-language:EN-HK'>auto</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'> f = task.get_future();<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// </span><span
  lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>在主线程中运行</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  task();<br>
  </span><span style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:
  "Times New Roman";color:#8E908C;mso-ansi-language:EN-HK'>// </span><span
  lang=ZH-CN style='font-size:10.0pt;font-family:"Microsoft YaHei",sans-serif;
  mso-bidi-font-family:"Microsoft YaHei";color:#8E908C;mso-ansi-language:EN-HK'>启动另一个线程运行，注意只能移动</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#8E908C;mso-ansi-language:EN-HK'>packaged_task</span><span
  style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
  color:#4D4D4C;mso-ansi-language:EN-HK'><br>
  std::thread myThread(std::move(task));<br>
  f.get();<o:p></o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>由于</span><span style='font-size:10.0pt;
font-family:consolas;mso-fareast-font-family:"Times New Roman";color:#555555;
background:#EEEEEE;mso-ansi-language:EN-HK'>std::packaged_task</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>能移动到某个</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::thread</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>中，因此适合用来实现线程池，负责打包待计算的任务。</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::packaged_task</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>还可以被用来向另一个线程派发任务。</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>promise<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在上面的两种派发任务</span><span style='font-size:
10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>-<span lang=ZH-CN>等待获取结果的模型中，我们的主线程是作为等待任务结果的一方，而将执行任务的异步线程则是产生结果的一方。</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>对象由<b>调用者</b>（一般是主线程）持有，调用者会调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::async</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>或者</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::packaged_task</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>等启动一个任务，并且在需要结果时调用</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>f.get()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>获得异步线程的结果。对于异步线程来说，调用者对自己是<b>透明</b>的，只能通过<b>执行完任务正常返回</b>完成向调用者同步。但是这在</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>promise<span
lang=ZH-CN>中就不一样了，在使用</span></span><span style='font-size:10.0pt;font-family:
consolas;mso-fareast-font-family:"Times New Roman";color:#555555;background:
#EEEEEE;mso-ansi-language:EN-HK'>std::promise</span><span lang=ZH-CN
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>时，异步线程需要显式向调用者设置值</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::promise::set_value()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>或传递异常</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::promise::set_exception()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>。因此</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>promise<span
lang=ZH-CN>实际上为被调用者提供一个显式向调用者同步的方法。被调用者显得更加主动，而且它现在可以返回一个异常。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>future.then<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在先前介绍</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>future<span lang=ZH-CN>时，我们认为其有一个美中不足就是最后总有一个同步的过程，也就是调用</span>get<span
lang=ZH-CN>时候的等待，而使用裸线程（池）有优势的一点就是我们可以通过回调更为灵活地控制我们的逻辑，但裸线程也有之前提到的回调地狱之类的缺点。能不能两相结合呢？</span><a
href="https://stackoverflow.com/questions/22175100/how-to-add-a-callback-in-boostfuture-in-c"
target="_blank"><span style='color:#555555'>SoF<span lang=ZH-CN>上也有类似的提问</span></span></a><span
lang=ZH-CN>。实际上有一个提案称为</span>future.then<span lang=ZH-CN>就是用来解决这个问题的。其风格类似于</span>CPS<span
lang=ZH-CN>和</span>Haskell<span lang=ZH-CN>中的</span>Monad<span lang=ZH-CN>，相比先前介绍的</span>future/promise/packaged_task<span
lang=ZH-CN>机制，</span>future.then<span lang=ZH-CN>利用了回调链的机制避免了调用</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>future::get()</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>形成阻塞。相比</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>std::future</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>，</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>future.then<span
lang=ZH-CN>是完全的异步。</span>future.then<span lang=ZH-CN>目前还没有进入</span>C++<span
lang=ZH-CN>标准，因此</span>C++<span lang=ZH-CN>中目前还需要借助于线程池、事件或者</span>IOCP<span
lang=ZH-CN>的方式来实现异步。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>co_await<span lang=ZH-CN>、</span>co_yield<span
lang=ZH-CN>、</span>co_return<o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>future.then<span lang=ZH-CN>机制降低了流程操控的复杂度，不过写起来仍然很繁琐，而且存在回调地狱的问题。在链式调用的过程中，整个流程难以在中间直接</span>abort<span
lang=ZH-CN>，为此</span>Rust<span lang=ZH-CN>先后提出了</span></span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>try!</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>和</span><span
style='font-size:10.0pt;font-family:consolas;mso-fareast-font-family:"Times New Roman";
color:#555555;background:#EEEEEE;mso-ansi-language:EN-HK'>?.</span><span
lang=ZH-CN style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;
mso-bidi-font-family:"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>这样的机制。截至目前这三个函数尚未进入</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>C++<span lang=ZH-CN>标准，但这种由</span>C
Sharp<span lang=ZH-CN>流行开来的异步编程范式其实十分优雅，我们将在一个单独的专题进行讨论。</span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;text-justify:inter-ideograph;
mso-outline-level:1;background:white'><b><span lang=ZH-CN style='font-size:
16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'>多进程并发模型</span></b><b><span
style='font-size:16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>常见的并发模型有共享变量（内存）、</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'>Communicating
Sequential Process(CSP)<span lang=ZH-CN>、</span>Actor<span lang=ZH-CN>等模型。共享变量的模型中，多个线程通过锁或者原子操作对变量进行有序访问，在先前我们讨论了</span>future<span
lang=ZH-CN>等基于线程的共享内存的模型，它们在<b>多线程</b>环境中非常实用。共享变量模型强调利用共享内存进行通信，我们明显发现在</span>future<span
lang=ZH-CN>等模式中信息的交互是一次性的，即调用者在启动异步任务后很难再去操作异步任务，而异步任务更是看不到调用者。另一种思路是通过通信来共享内存，</span>CSP<span
lang=ZH-CN>和</span>Actor<span lang=ZH-CN>模型选择后者，因此在<b>多进程</b>情况下会更得心应手。</span>CSP<span
lang=ZH-CN>模型可以参照</span>Go<span lang=ZH-CN>语言中的</span>Channel<span lang=ZH-CN>，</span>Actor<span
lang=ZH-CN>模型可以参照</span>Mapreduce<span lang=ZH-CN>模型，他们都是通过消息来进行同步的。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Actor<span lang=ZH-CN>模型</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'>Actor<span lang=ZH-CN>模型围绕<b>具名</b>节点（称为</span>Actor<span
lang=ZH-CN>）展开，消息从一个</span>Actor<b><span lang=ZH-CN>直接发送</span></b><span
lang=ZH-CN>到另一个</span>Actor<span lang=ZH-CN>，而并不需要通过诸如</span>Channel<span
lang=ZH-CN>的桥梁。特别地，</span>Actor<span lang=ZH-CN>是与线程无关的，一个线程上可以存在多个</span>Actor<span
lang=ZH-CN>。更进一步地，</span><a
href="https://tonybai.com/2014/09/29/a-channel-compendium-for-golang/"
target="_blank"><span style='color:#555555'>Actor<span lang=ZH-CN>的消息传递也是异步的</span></span></a><span
lang=ZH-CN>，消息的发送和接受可以在任意时间发生。</span>Actor<span lang=ZH-CN>之间进行严格地隔离，实现所谓“</span>Share
nothing<span lang=ZH-CN>”的机制，每一个</span>Actor<span lang=ZH-CN>只能同时处理一个消息，多余的消息会存放在</span>Mailox<span
lang=ZH-CN>里面。这样实际上消息的处理过程是独占的。</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span style='font-size:15.0pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>CSP<span lang=ZH-CN>模型</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>相比</span><span style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Actor<span lang=ZH-CN>，</span>CSP<span
lang=ZH-CN>模型围绕一个中间桥梁（在这里使用</span>Go<span lang=ZH-CN>语言中的具象也就是</span>Channel<span
lang=ZH-CN>来表示），不同的节点向对应的</span>Channel<span lang=ZH-CN>获取或者发送消息，因此在耦合性上要比</span>Actor<span
lang=ZH-CN>模型松一点。相比</span>Actor<span lang=ZH-CN>模型，</span>CSP<span lang=ZH-CN>模型要求发送方在接收方准备好接受消息时才能发送消息，所以同步性要更强一点。以</span>Go<span
lang=ZH-CN>为例，</span>Channel<span lang=ZH-CN>一般具有</span>4<span lang=ZH-CN>个基本操作：</span><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l15 level1 lfo20;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>创建</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>c = make(chan int, buffer_size)</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l15 level1 lfo20;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>发送</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>c &lt;-</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l15 level1 lfo20;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>接受</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>&lt;- c</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l15 level1 lfo20;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>关闭</span><span style='font-size:10.0pt;
     font-family:consolas;mso-fareast-font-family:"Times New Roman";background:
     #EEEEEE;mso-ansi-language:EN-HK'>close(c)</span><span style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:3;background:white'><b><span style='font-size:13.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>Channel<span lang=ZH-CN>的</span>C++<span
lang=ZH-CN>实现</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span style='font-size:10.5pt;font-family:
"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";color:#555555;
mso-ansi-language:EN-HK'><a
href="https://st.xorian.net/blog/2012/08/go-style-channel-in-c/" target="_blank"><span
lang=ZH-CN style='color:#555555'>这篇文章中讲述了使用</span><span style='color:#555555'>C++<span
lang=ZH-CN>模拟</span>Go<span lang=ZH-CN>中的</span>Channel<span lang=ZH-CN>的一个方案</span></span></a><span
lang=ZH-CN>。首先</span>Channel<span lang=ZH-CN>一个最基础的功能就是收发消息，这个可以通过一个队列来实现。</span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;text-justify:inter-ideograph;
mso-outline-level:1;background:white'><b><span lang=ZH-CN style='font-size:
16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'>并发编程中的基础架构</span></b><b><span
style='font-size:16.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-font-kerning:18.0pt;mso-ansi-language:EN-HK'><o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-bottom:18.75pt;text-align:justify;text-justify:
inter-ideograph;background:white'><span lang=ZH-CN style='font-size:10.5pt;
font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>在设计高性能的并发代码时，我们需要注意以下几点：</span><span
style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
"Times New Roman";color:#555555;mso-ansi-language:EN-HK'><o:p></o:p></span></p>

<ol start=1 type=1>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l4 level1 lfo21;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>充分利用局部性假设，是同一线程中的数据紧密联系</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l4 level1 lfo21;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>减少线程上所需的数据量</span><span style='font-size:10.5pt;
     font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'><o:p></o:p></span></li>
 <li class=MsoNormal style='color:#555555;mso-margin-top-alt:auto;mso-margin-bottom-alt:
     auto;text-align:justify;text-justify:inter-ideograph;mso-list:l4 level1 lfo21;
     tab-stops:list 36.0pt;background:white'><span lang=ZH-CN style='font-size:
     10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
     mso-ansi-language:EN-HK'>让不同线程访问不同位置，避免伪共享，这里也是将<b>内存分配对齐到缓存行大小</b>的一个重要原因。</span><span
     style='font-size:10.5pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:
     "Times New Roman";mso-ansi-language:EN-HK'><o:p></o:p></span></li>
</ol>

<p class=MsoNormal style='margin-top:15.0pt;margin-right:0cm;margin-bottom:
11.25pt;margin-left:0cm;text-align:justify;text-justify:inter-ideograph;
mso-outline-level:2;background:white'><b><span lang=ZH-CN style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>响应式</span></b><b><span style='font-size:
15.0pt;font-family:"PingFang SC",sans-serif;mso-bidi-font-family:"Times New Roman";
color:#555555;mso-ansi-language:EN-HK'>(reactive)<span lang=ZH-CN>架构</span><o:p></o:p></span></b></p>

<p class=MsoNormal><span lang=EN-US style='mso-ansi-language:EN-US'><o:p>&nbsp;</o:p></span></p>

</div>

</body>

</html>
